<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Menu - FIT Challenge Program 10 Hari</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" >
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
body { background-color: #f8f9fa; }
/***** Judul di Navbar *****/
.brand-title { font-size: 12px; font:wide; color: #023581; line-height: 1; }
/***** Sub Judul di Navbar *****/
.brand-subtitle { font-size: 10px; color: #6c757d; line-height: 1; }

select {cursor: pointer;}

/***** Main Menu Navbar *****/
.main-menu-link { font-weight: 500; padding: 8px 12px !important; border-radius: 3px; }
.main-menu-link:hover, .main-menu-link.active { 
  color: #dc3545 !important; 
  /* background-color: #dadada; */
}

/****** Icon Medsos ******/
.social-icon { 
  display: inline-flex; 
  justify-content: center; 
  align-items: center; 
  width: 40px; 
  height: 40px; 
  border-radius: 50%; 
}
.social-icon i { color: #555; transition: color 0.3s ease-in-out; }
.social-icon:hover { background-color: #dadada; }
.social-icon:hover i { color: #dc3545; }

/***** Header Image *****/
.header-image img {
    height: 100%;
    width: 100%;
    object-fit: cover;
    /*
    border-radius: 10px 10px 0 0;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    */
}

/*****  HEADER IMAGE SMOOTH ANIMATION *****/
.header-image {
  overflow: hidden;
}
.header-image img {
  animation: headerFadeZoom 1.2s ease-out forwards;
  transform: scale(1.05);
  opacity: 0;
}
@keyframes headerFadeZoom {
  from {
    opacity: 0;
    transform: scale(1.05);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
/*****  Akhir Header Imagae Smooth Animation *****/

/***** Menu Accordian ******/
.menu-accordion { margin-bottom: 10px; }
.menu-header {
  /* background: linear-gradient(135deg, #105fff 0%, #cfdaff 100%); */
  background-color : #f0f0f0;    /* #0077ff; */
  color: #000000;                /* #ffffff; */
  border: none;
  padding: 15px 20px;
  text-align: left;
  width: 100%;
  /* border-radius: 8px; */
  font-weight: 500;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
}
.menu-header:hover {
  /* background: linear-gradient(135deg, #cfdaff 0%, #105fff 100%); */
  background-color : #2f90ff;      /* #7c7c7c; */ 
  color:#ffffff;                   /* #f7f7f7;  */          
  /* transform: translateY(-2px); */
  /* box-shadow: 0 4px 8px rgba(0,0,0,0.2); */
}
.menu-header .menu-icon { transition: transform 0.3s ease; }
.menu-header.collapsed .menu-icon { transform: rotate(0deg); }
.menu-header:not(.collapsed) .menu-icon { transform: rotate(180deg); }
.menu-content {
  background-color: white;
  /* border: 1px solid #dee2e6; */
  border-top: none;
  /* border-radius: 0 0 8px 8px; */
  padding: 0;
}
.menu-item {
  display: block;
  padding: 12px 20px;
  color: #333;      
  text-decoration: none;
  border-bottom: 1px solid #f8f9fa;
  transition: all 0.2s ease;
}
.menu-item:last-child { border-bottom: none; }
/* Warna Hover SubMenu */
.menu-item:hover {
  /* Warna Pointer Sub Menu */
  background-color: #e7e7e7; 
  /* Warna Text Sub Menu */
  color: #333;        
  text-decoration: none;
}

/* Submenu Content Styles */
.submenu-content { 
  position: relative;
  z-index: 10 ;
  border-radius: 8px; 
  margin: 10px 0;
  display: none;
  width:100% 
}
.submenu-trigger { cursor: pointer; }
.submenu-trigger:hover { background-color: #e7e7e7; color: #333; }
/* Jarak Submenu, Jarak Icon dengan text dan Warna Icon */
/* .menu-item i { padding-left: 10px; width: 30px; margin-right: 10px; color: #000000; } */
.menu-item i { padding-left: 20px;  width: 30px; margin-right: 10px; color: #000000; }
/* Style untuk modul terkunci icon lock dan unlock */
.menu-header.disabled { pointer-events: none; opacity: 0.6; cursor: not-allowed; }
.status-lock { font-size: 12px; color: #000e3d; margin-left: 2px; }
.status-unlock { font-size: 12px;color: #ffffff; margin-left: 2px; }

/* Pastikan submenu tidak keluar dari container */
.menu-accordion {
  position: relative;
  overflow: visible;
}

/***** Playlist Container di Menu Accordion *****/
.menu-content .playlist-container {
    margin: 10px 0;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    max-height: 400px;
    position : relative;
}

/***** Footer *****/
.footer a:hover { color: #ff4d4d !important; }

/**** * About Overlay *****/
.about-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  display: none;
}
.about-form {
  width: 100%;
  max-width: 350px;
  padding: 20px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  text-align: center;
}
/***** Akhir About *****/

/***** Video Player Styles *****/
.video-container {
    position: relative;
    width: 100%;
    /* max-width: 800px; */
    max-width: 780px;
    margin: 15px auto;
    display: none;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    /* border: 3px solid #002266; */
    border: 3px solid #000000;
}
.video-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
}
.video-wrapper iframe,
.video-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
.video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #002266 0%, #0044cc 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}
.video-placeholder:hover {
    background: linear-gradient(135deg, #0044cc 0%, #002266 100%);
    transform: scale(1.02);
}
.video-placeholder i { font-size: 48px; margin-bottom: 15px; opacity: 0.9; }
.video-placeholder-text { font-size: 16px; font-weight: 500; text-align: center; padding: 0 20px; }
/* Spinner di tengah video player */
.video-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    background: #000;
    z-index: 5;
}
.video-loading .spinner-border { width: 3rem; height: 3rem; color: #dc3545; }
.close-video {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    transition: all 0.3s ease;
    font-size: 14px;
}
.close-video:hover { background: rgba(220, 53, 69, 0.9); transform: scale(1.1); }
/***** Akhir Video Player Styles *****/

/***** Kunci Materi Video *****/  
/* Kunci seluruh video */
.video-locked { pointer-events: none !important; cursor: default !important; }
/* Semua isi video ikut terkunci */
.video-locked * { pointer-events: none !important; cursor: default !important; }
/* ‚ùó KECUALI tombol close */
.video-locked .close-video, 
.video-locked .close-video * { pointer-events: auto !important; cursor: pointer !important; }
/***** Akhir Kunci Materi Video *****/  

/***** Playlist Container Styles Video Youtube *****/
.playlist-container {
    display: none;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
    max-height: 400px !important;
    overflow-y: auto !important;
    scrollbar-width: thin;
    position: relative;
}

/***** Tombol Close di Playlist Header *****/
.playlist-header .btn-close-header {
    background: none;
    border: none;
    color: #666;
    font-size: 16px;
    padding: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
    transition: all 0.3s ease;
    border-radius: 50%;
    cursor: pointer;
}
.playlist-header .btn-close-header:hover {
    opacity: 1;
    color: #dc3545 !important;
    background-color: rgba(220, 53, 69, 0.1);
    transform: scale(1.1);
}
.playlist-header.position-relative {
    position: relative !important;
}
/***** Pastikan tombol di posisi yang benar *****/
.playlist-header .position-absolute {
    position: absolute !important;
    top: 50% !important;
    right: 10px !important;
    transform: translateY(-50%) !important;
} 

/***** Playlist Video Items Container *****/
.playlist-container::-webkit-scrollbar { width: 8px !important; display: block !important; }
.playlist-container::-webkit-scrollbar-track { background: #f8f9fa !important; display: block !important;}
.playlist-container::-webkit-scrollbar-thumb { background: #ccc !important; border-radius: 4px !important; display: block !important;}
.playlist-container::-webkit-scrollbar-thumb:hover { background: #aaa !important;}
.playlist-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
}
.playlist-item:hover { background-color: #f8f9fa;}
.playlist-item:last-child { border-bottom: none; }
.playlist-thumbnail {
    position: relative;
    width: 120px;
    height: 68px;
    margin-right: 12px;
    border-radius: 4px;
    overflow: hidden;
    background: #ddd;
    flex-shrink: 0;
}
.playlist-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
.position-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
}
.playlist-info { flex: 1; min-width: 0; }
.playlist-title {
    font-weight: 500;
    margin-bottom: 4px;
    font-size: 14px;
    line-height: 1.3;
    display: -webkit-box;
    /* -webkit-line-clamp: 2; */
    line-clamp: 2;
    /*-webkit-box-orient: vertical;*/
    box-orient: vertical;
    overflow: hidden;
}
.playlist-meta {display: flex; gap: 12px; font-size: 12px; color: #666;}
.playlist-duration {color: #dc3545; font-weight: 500;}
.playlist-position {color: #6c757d; }
.playlist-loading {padding: 30px 20px; text-align: center; color: #666;}
.playlist-error { padding: 30px 20px; text-align: center; color: #dc3545;}
/***** Akhir Playlist Youtube *****/

/***** PDF Viewer Styles *****/
.pdf-viewer {
    display: none;
    position: relative;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
}
.pdf-container { width: 100%; height: 500px; scrollbar-width: none; overflow-x: hidden; }
.pdf-container::-webkit-scrollbar { display: none; }                
.pdf-container iframe { width: 100%; height: 100%; border: none; overflow-x: hidden !important; }
.pdf-viewer::-webkit-scrollbar { width: 0px; display: none; }
.pdf-header {
    padding: 12px 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: between;
    align-items: center;
}
.pdf-title { font-weight: 600; color: #333; flex: 1; }
.pdf-actions { display: flex; gap: 10px; }
.pdf-loading {
    padding: 30px 20px;
    text-align: center;
    color: #666;
    height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.close-pdf {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 25;
    transition: all 0.3s ease;
    font-size: 14px;
}
.close-pdf:hover { background: rgba(220, 53, 69, 0.9); transform: scale(1.1);}
/***** Akhir PDF Viewer Styles *****/

/***** PDF.js Viewer Styles *****/
.pdfjs-viewer { 
    width: 100%; 
    height: 500px; 
    border: 1px solid #ddd; 
    overflow: auto; 
    background: #f5f5f5;
}
.pdfjs-canvas { 
    display: block; 
    margin: 0 auto; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 100%; /* TAMBAH INI - pastikan tidak melebihi container */
}
.pdfjs-controls {
    padding: 10px;
    background: white;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;            /* PINDAH KE BAWAH - tambahkan margin-top dan border-top */
    border-top: 1px solid #ddd;
    border-bottom: none;
}
.pdfjs-page-info { font-size: 14px; color: #666;}
/***** Akhir PDF.js Viewer Styles *****/

/* Style untuk tombol centang video */
.complete-btn { transition: all 0.3s ease; }
.complete-btn:hover { transform: scale(1.1); background-color: #218838 !important; }

/***** STYLING UNTUK PESAN UNIVERSAL POSISI MENU *****/
.notification-message {
    display: none;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 10px;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.1);
}
.pesan-notif-icon { font-size: 12px; }
.notification-error { background-color: #c9302c; color: white; border-color: #c9302c; }
.notification-success { background-color:  #025aa5; color: white; border-color: #025aa5; }
.notification-warning { background-color: #f0ad4e; color: black; border-color: #f0ad4e; }
.notification-info { background-color: #00a2ff; color: white; border-color: #00a2ff; }
/* Pesan dalam menu content */
.menu-content .notification-message { margin: 10px 0; border-radius: 6px; }
/* Toast message */
.toast-message {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 300px;
    max-width: 400px;
    z-index: 1060;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Styling untuk modal meal plan */
.meal-plan-modal .modal-header { background: linear-gradient(135deg, #105fff 0%, #cfdaff 100%); color: white; }
.meal-plan-modal .modal-body { padding: 20px; }
.meal-plan-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; display: none; }

/*****************************
/* TAMPILAN MOBILE RESPONSIVE
/*****************************/
@media (max-width: 591.98px) {
  .navbar-collapse .mx-auto {
      margin-left: 0 !important;
      margin-right: 0 !important;
      flex-direction: row; 
      margin-bottom: 1rem;
  }
  .navbar-nav:not(.mx-auto) .nav-item, .navbar-nav:not(.mx-auto) .main-menu-link { 
    width: 100%;
    /* width: 50%; */
  }
  body {
    background-color: #ffffff !important;
  }
  .container {
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
  }
  /* Hilangkan border,shadow mobile only */
  .card {
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    margin: 0 !important;
  }
  .card-body {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
   /* Jarak konten dari sisi layar (mobile only) */
  .container, .container-fluid, .menu-content, .submenu-content {
    padding-left: 10px !important;
    padding-right: 10px !important;
  }
  /* Supaya teks panjang tidak nempel di card */
  .card, .menu-item, .video-container, .playlist-container {
    margin-left: 2px;
    margin-right: 2px;
  }
}
/***** AKHIR TAMPILAN MOBILE *****/

</style>
</head>

<body>
<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="card mx-auto shadow p-0" style="max-width:789px">
      <!-- HEADER -->
      <header>
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #f1f1f1;">
          <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="images/logo-beratidealku.png" alt="Logo" width="199" height="38" class="me-2">
              <div class="d-md-block">
                <div class="brand-title">FIT Challenge</div>
                <div class="brand-subtitle">Program 10 Hari</div>
              </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
              <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link main-menu-link" href="#about" onclick="showAbout()">About</a></li>
                <li class="nav-item" id="loginMenuItem">
                  <a class="nav-link main-menu-link" href="loginFC.html">
                    <i class="fas fa-sign-in-alt"></i> Login
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>
      
      <div class="card-body">
       <!-- Header Image -->
        <div class="header-image">
            <img src="images/Header-FITChallenge.jpg" alt="Header Image">
        </div>

        <div class="card-title text-white p-1 mb-0" style="text-align:center; background-color:#002266; border-bottom:5px solid #f3f3f3;">
          <h5 style="margin-top: 5px; margin-bottom: 0px;" id="greetingTime"></h5>
          <h6 style="font-size: small"; id="greetingName"></h6>
          <h6 style="font-size: small;">
            Di kelas online <strong>FIT CHALLENGE PROGRAMME by BERATidealku</strong><br>
            Kak <strong><span id="greetingNameInline"></span></strong> akan mengikuti kelas ini selama <strong>10 Hari</strong><br>
            dan diedukasi dengan modul-modul yang disusun secara lengkap dan terstruktur<br>
          </h6>
        </div>

        <!------------------------------->
        <!-- MENU UTAMA FIT CHALLENGE  -->
        <!------------------------------->
        <div class="menu-accordion" id="menuAccordion">
          <!--------------------------->
          <!-- MENU PANDUAN APLIKASI -->
          <!---------------------------> 
          <div class="menu-accordion-item">
            <button class="menu-header collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panduanContent">
              <span>
                <i class="fas fa-angle-double-right me-2"></i>Panduan Penggunaan Aplikasi
              </span>
              <i class="fas fa-angle-down menu-icon"></i>
            </button>

            <!-- SUBMENU PANDUAN APLIKASI -->
            <div class="collapse" id="panduanContent" data-bs-parent="#menuAccordion">
              <div class="menu-content">
                <!-- Video Tutorial -->
                <a href="https://www.youtube.com/watch?v=Zg_badTE2Ec" 
                  class="menu-item video-link" data-section="panduan" data-type="youtube" data-url="https://www.youtube.com/watch?v=Zg_badTE2Ec">
                  <i class="fas fa-file-video"></i>Video Panduan Penggunaan Aplikasi
                </a>

                <!-- PDF Panduan Penggunaan Aplikasi -->
                <a href="pdf/Panduan_Penggunaan_Aplikasi.pdf" 
                  class="menu-item" id="pdfPanduanLink">
                  <i class="fas fa-file-pdf"></i>PDF Panduan Penggunaan Aplikasi
                </a>
                
                <!-- PDF Viewer untuk Panduan -->
                <div class="pdf-viewer" id="pdfViewerPanduan" style="display: none;">
                  <button class="close-pdf" onclick="closePDF('panduan')">
                    <i class="fas fa-times"></i>
                  </button>
                  <div class="pdf-container" id="pdfContainerPanduan">
                    <!-- PDF akan dimuat di sini -->
                  </div>
                </div>
               
                <!-- Video Player untuk Panduan -->
                <div class="video-container" id="videoContainerPanduan" style="display: none;">
                  <button class="close-video" onclick="closeVideo('panduan')">
                    <i class="fas fa-times"></i>
                  </button>
                  <div class="video-wrapper">
                    <div class="video-placeholder" onclick="playVideo('panduan')">
                      <i class="fas fa-play-circle"></i>
                      <div class="video-placeholder-text">Klik untuk memuat video</div>
                    </div>
                    <div class="video-loading" id="videoLoadingPanduan">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading video...</span>
                      </div>
                    </div>
                    <div id="videoPlayerPanduan"></div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!--------------------->
          <!-- MENU PERKENALAN --> 
          <!--------------------->
          <div class="menu-accordion-item">
            <button class="menu-header collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#perkenalanContent">
              <span>
                <i class="fas fa-angle-double-right me-2"></i>Perkenalan
              </span>
              <i class="fas fa-angle-down menu-icon"></i>
            </button>
            
            <div class="collapse" id="perkenalanContent" data-bs-parent="#menuAccordion">
              <div class="menu-content">
                <!-- Canva Link - Buka di tab baru -->
                <a href="https://www.canva.com/design/DAGqjXWcl6o/ylVUgMbZ8it0TXN0dqCKzQ/view?utm_content=DAGqjXWcl6o&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h1feb0aca2a" 
                  class="menu-item" target="_blank">
                  <i class="fas fa-video"></i>1. Personal Diet Partner
                </a>
                
                <!-- YouTube Video -->
                <a href="https://www.youtube.com/watch?v=9DoHhx9jlGM" 
                  class="menu-item video-link" data-section="perkenalan" data-type="youtube" data-url="https://www.youtube.com/watch?v=9DoHhx9jlGM">
                  <i class="fas fa-video"></i>2. Alasan Mengapa Herbalife
                </a>

                <!-- Local Video -->
                <a href="video/Live Best Your Best Life ! - 360.mp4" 
                  class="menu-item video-link" data-section="perkenalan" data-type="local" data-url="video/Live Best Your Best Life ! - 360.mp4">
                  <i class="fas fa-video"></i>3. Live Best Your Best Life !
                </a>
                
                <!-- Video Player untuk Perkenalan -->
                <div class="video-container" id="videoContainerPerkenalan" style="display: none;">
                  <button class="close-video" onclick="closeVideo('perkenalan')">
                    <i class="fas fa-times"></i>
                  </button>
                  <div class="video-wrapper">
                    <div class="video-placeholder" onclick="playVideo('perkenalan')">
                      <i class="fas fa-play-circle"></i>
                      <div class="video-placeholder-text">Klik untuk memuat video</div>
                    </div>
                    <div class="video-loading" id="videoLoadingPerkenalan">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading video...</span>
                      </div>
                    </div>
                    <div id="videoPlayerPerkenalan"></div>
                  </div>
                </div>
                
                <a href="#" class="menu-item">
                  <i class="fas fa-check-double"></i>Selesai Perkenalan
                </a>      
              </div>
            </div>
          </div>
           
          <!----------------------------->
          <!-- MENU MODUL HARI PERTAMA -->
          <!-----------------------------> 
          <div class="menu-accordion-item">
            <button class="menu-header collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pertemuan1Content" data-hari="1">
              <span>
                <i class="fas fa-angle-double-right me-2"></i>Modul Hari Pertama
                <i class="fas fa-lock status-lock"></i>
              </span>
              <i class="fas fa-angle-down menu-icon"></i>
            </button>

            <!-- SUBMENU MODUL HARI PERTAMA --> 
            <div class="collapse" id="pertemuan1Content" data-bs-parent="#menuAccordion">
              <div class="menu-content">
              
                <!-- VIDEO MATERI HARI PERTAMA -->
                <a href="https://www.youtube.com/watch?v=Zg_badTE2Ec" 
                  class="menu-item video-link" style="max-width: 100%;" data-section="pertemuan1" 
                  data-type="youtube" data-url="https://www.youtube.com/watch?v=Zg_badTE2Ec" id="materiLink1">
                  1.1 Materi Hari Pertama 
                </a>
                
                <!-- Video Player untuk Materi Hari Pertama - DITEMPATKAN DI SINI -->
                <div class="video-container" id="videoContainerPertemuan1" style="display: none;">
                  <button class="close-video" onclick="closeVideo('pertemuan1')">
                    <i class="fas fa-times"></i>
                  </button>
                
                  <div class="video-wrapper">
                    <div class="video-placeholder" onclick="playVideo('pertemuan1')">
                      <i class="fas fa-play-circle"></i>
                      <div class="video-placeholder-text">Klik untuk memuat video</div>
                    </div>
                    <div class="video-loading" id="videoLoadingPertemuan1">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading video...</span>
                      </div>
                    </div>
                    <div id="videoPlayerPertemuan1"></div>
                  </div>
                </div>
  
                <!-- MEAL PLAN HARI PERTAMA -->
                <a href="#" class="menu-item submenu-trigger" data-target="mealPlanContent1">
                  1.2 Meal Plan Hari Pertama
                </a>

                <!-- WORKOUT HARI PERTAMA -->
                <a href="#" class="menu-item submenu-trigger" data-target="workoutContent1">
                  1.3 Workout Hari Pertama
                </a>
              
                <!-- WATER REMINDER HARI PERTAMA -->
                <a href="#" class="menu-item submenu-trigger" data-target="waterReminderContent1">
                  1.4 Water Reminder Hari Pertama
                </a>

                <!-- WAKTU ISTIRAHAT HARI PERTAMA -->
                <a href="#" class="menu-item submenu-trigger" data-target="istirahatContent1">
                  1.5 Waktu Istirahat Hari Pertama
                </a>
                
                <!-- DATA TRACKING HARI PERTAMA -->
                <a href="#" class="menu-item submenu-trigger" data-target="dataTrackingContent1">
                  1.6 Data Tracking Hari Pertama
                </a>

                <!-- TANYA COACH HARI PERTAMA -->
                <a href="https://api.whatsapp.com/send?phone=6281241318600&text=Halo+kak%2C+saya+ingin+bertanya+materi+tentang+" 
                  class="menu-item" onclick="tanyaCoach(1)" target="_blank">
                  1.7 Tanya Coach? Hari Pertama
                </a>

                <!-- SELESAI MODUL HARI PERTAMA -->
                <a href="#" class="menu-item">1.8 Selesai Modul hari Pertama</a> 
              </div>
            </div>
          </div>

          <!-- KONTEN DETAIL UNTUK SUBMENU -->
          <!-- 1.2 Meal Plan Content -->
          <div class="submenu-content" id="mealPlanContent1" style="display: none;">
            <div class="border p-3 bg-light mt-2 mb-2">
              <div class="card-title p-1 mb-2 position-relative" style="text-align:center; color: #ffffff; text-shadow: #bebebe; background-color:  #002266; border-bottom-style:solid; border-bottom-color:#facc00; border-width:5px;">
                <h6 class="mt-1 mb-1">Apa Yang Anda Makan Hari Ini</h6>
                <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" onclick="hideSubmenu('mealPlanContent1')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <h6><b>PANDUAN NUTRISI</b></h6>
              <p><b>Rekomendasi Meal Plan : </b>Konsumsi makanan bergizi dalam jumlah yang tepat sesuai dengan kebutuhan nutrisi anda</br>
              <button type="button" class="btn btn-primary btn-sm mt-1" id="btnCekDisiniMealPlan">
                <i class="fas fa-utensils"></i> Cek Disini
              </button>
        
              <!-- PDF Viewer untuk Meal Plan -->
              <div class="pdf-viewer" id="pdfViewerMealplan1" style="display: none;">
                <button class="close-pdf" onclick="closePDF('mealplan1')">
                  <i class="fas fa-times"></i>
                </button>
                <div class="pdf-container" id="pdfContainerMealplan1">
                  <!-- PDF akan dimuat di sini -->
                </div>
              </div>
                  
              <div style="border-left-style:solid; border-left-color:#b1b1b1; border-width: 4px; padding-left: 10px; margin-top: 10px;">
                <p><i class="fas far fa-lightbulb mt-2 mb-2" style="color: #fa0000;"></i><b> Tips : </b>Pastikan makanan yang anda konsumsi adalah makanan yang sehat dan seimbang, yang terpenuhi unsur</p>
                <i class="far fa-check-circle"></i> Karbohidrat 40%</br>
                <i class="far fa-check-circle"></i> Protein 30%</br>
                <i class="far fa-check-circle"></i> Lemak 30%</br>
              </div>

              <!-- Jadwal Meal Plan -->
              <div class="mt-3 mb-2" id="jadwalMealplan-container">
                <h6 class="mt-2"><b>JADWAL MEAL PLAN</b></h6>
                <div id="jadwalMealplan-list">
                  <!-- Pilihan jadwal meal dimuat di sini -->  
                </div>
              </div>
             </div>
          </div>
          
          <!-- 1.3 Workout Content -->
          <div class="submenu-content" id="workoutContent1" style="display: none;">
            <div class="border p-3 bg-light mt-2 mb-2">
              <div class="card-title p-1 mb-2 position-relative" style="text-align:center; color: #ffffff; text-shadow: #bebebe; background-color:  #002266; border-bottom-style:solid; border-bottom-color:#facc00; border-width:5px;">
                <h6 class="mt-1 mb-1">Apa Olahraga Anda Hari Ini</h6>
                 <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" onclick="hideSubmenu('workoutContent1')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <h6><b>PANDUAN WORKOUT</b></h6>
              <p><b>Rekomendasi Olahraga : </b>Olahraga 3-5 hari seminggu dengan durasi 20-30 menit setiap harinya, dengan pilihan jenis olahraga yang sesuai dengan kebutuhan tubuh dan kesehatan</br>
              <button type="button" class="btn btn-primary btn-sm mt-1" id="btnCekDisiniWorkout">
                <i class="fas fa-dumbbell"></i> Cek Disini
              </button>
   
              <!-- PDF Viewer untuk Workout -->
              <div class="pdf-viewer" id="pdfViewerWorkout1" style="display: none;">
                <button class="close-pdf" onclick="closePDF('workout1')">
                  <i class="fas fa-times"></i>
                </button>
                <div class="pdf-container" id="pdfContainerWorkout1">
                  <!-- PDF akan dimuat di sini -->
                </div>
              </div>
              
              <div style="border-left-style:solid; border-left-color:#b1b1b1; border-width: 4px; padding-left: 10px; margin-top: 10px;">
                <p><i class="fas far fa-lightbulb mt-2 mb-2" style="color: #fa0000;"></i><b> Tips : </b>Bergabunglah dengan berbagai komunitas olahraga, dimana orang-orangnya saling mendukung dan memotivasi satu sama lain</p>
              </div>

              <h6><b>JENIS WORKOUT</b></h6>  
              <!-- Pilih Jenis Olahraga Kardio -->
              <div class="mt-3 mb-2" id="kardio-container">
                <div id="olahragaKardio-list">
                  <!-- Pilihan olahraga kardio dimuat di sini -->
                </div>
              </div>

              <!-- Pilih Jenis Olahraga Resistance -->
              <div class="mt-3 mb-2" id="resistance-container">
                <div id="olahragaResisten-list">
                  <!-- Pilihan olahraga resisten dimuat di sini -->
                </div>
              </div>
                          
            </div>
          </div>
   
          <!-- 1.4 Water Reminder Content -->
          <div class="submenu-content" id="waterReminderContent1" style="display: none;">
            <div class="border p-3 bg-light mt-2 mb-2">
              <div class="card-title p-1 mb-2 position-relative" style="text-align:center; color: #ffffff; text-shadow: #bebebe; background-color: #002266; border-bottom-style:solid; border-bottom-color:#facc00; border-width:5px;">
                <h6 class="mt-1 mb-1">Hari Ini Minum Air Berapa</h6>
                <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" onclick="hideSubmenu('waterReminderContent1')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <h6><b>PANDUAN WATER REMINDER</b></h6>
              <p><b>Rekomendasi Asupan Air : </b>Minum air putih 8-15 gelas air perhari, dengan jumlah air putih yang cukup untuk mendukung aktivitas tubuh dan kesehatan</br>
              <button type="button" class="btn btn-primary btn-sm mt-1" id="btnCekDisiniAirMinum">
                <i class="fas fa-prescription-bottle"></i> Cek Disini
              </button>
     
              <!-- PDF Viewer untuk Water Reminder -->
              <div class="pdf-viewer" id="pdfViewerWater1" style="display: none;">
                <button class="close-pdf" onclick="closePDF('water1')">
                  <i class="fas fa-times"></i>
                </button>
                <div class="pdf-container" id="pdfContainerWater1">
                  <!-- PDF akan dimuat di sini -->
                </div>
              </div>
          
              <div style="border-left-style:solid; border-left-color:#b1b1b1; border-width: 4px; padding-left: 10px; margin-top: 10px;">
                <p><i class="fas far fa-lightbulb mt-2 mb-2" style="color: #fa0000;"></i><b> Tips : </b>Untuk mencukupi asupan air minum sehari</p>
                <i class="far fa-check-circle"></i> Belilah botol air yang dapat digunakan kembali untuk dibawa kemana-mana</br>
                <i class="far fa-check-circle"></i> Botol yang memiliki tulisan takaran air, untuk mengetahui sudah berapa banyak yang anda minum</br>
                <i class="far fa-check-circle"></i> Minumlah lebih banyak jika iklim cuaca panas dan sering berolahraga</br>
              </div>

              <!-- Asupan Air Putih dalam sehari -->
              <div class="mt-3 mb-2" id="airputih-container">
                <div id="airputihRadioBtn">
                  <!-- Pilihan jumlah air minum dimuat di sini -->
                </div>
              </div>
            </div>
          </div>
               
          <!-- 1.5 Istirahat Content -->
          <div class="submenu-content" id="istirahatContent1" style="display: none;">
            <div class="border p-3 bg-light mt-2 mb-2">
              <div class="card-title p-1 mb-2 position-relative" style="text-align:center; color: #ffffff; text-shadow: #bebebe; background-color: #002266; border-bottom-style:solid; border-bottom-color:#facc00; border-width:5px;">
                <h6 class="mt-1 mb-1">Hari Ini Istirahatnya Berapa Lama</h6>
                <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" onclick="hideSubmenu('istirahatContent1')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <h6><b>PANDUAN ISTIRAHAT</b></h6>
              <p><b>Rekomendasi Istirahat : </b>Dapatkan jam istirahat anda antara 6-8 Jam per malam</br>
              <button type="button" class="btn btn-primary btn-sm mt-1" id="btnCekDisiniIstirihat">
                <i class="fas fa-bed"></i> Cek Disini
              </button>
          
              <!-- PDF Viewer untuk Istirahat -->
              <div class="pdf-viewer" id="pdfViewerIstirahat1" style="display: none;">
                <button class="close-pdf" onclick="closePDF('istirahat1')">
                  <i class="fas fa-times"></i>
                </button>
                <div class="pdf-container" id="pdfContainerIstirahat1">
                  <!-- PDF akan dimuat di sini -->
                </div>
              </div>
          
              <div style="border-left-style:solid; border-left-color:#b1b1b1; border-width: 4px; padding-left: 10px; margin-top: 10px;">
                <p><i class="fas far fa-lightbulb mt-2 mb-2" style="color: #fa0000;"></i><b> Tips : </b>Pastikan anda istirahat dalam ruangan yang pencahayaannya redup, hening dan memiliki suhu ruang yang nyaman</p>
              </div>

              <!-- Waktu Istirahat -->
              <div class="mt-3 mb-2" id="istirahat-container">
                <div id="istirahatBtn">
                  <!-- Pilihan jadwal istirahat dimuat di sini -->
                </div>
              </div>

            </div>
          </div>
      
          <!-- 1.6 Data Tracking Content -->
          <div class="submenu-content" id="dataTrackingContent1" style="display: none;">
            <div class="border p-3 bg-light mt-2 mb-2">
              <div class="card-title p-1 mb-2 position-relative" style="text-align:center; color: #ffffff; text-shadow: #bebebe; background-color: #002266; border-bottom-style:solid; border-bottom-color:#facc00; border-width:5px;">
                <h6 class="mt-1 mb-1">Lengkapi Data Anda ! </h6>
                <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" onclick="hideSubmenu('dataTrackingContent1')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <h6><b>PANDUAN DATA TRACKING</b></h6>
              <p><b>Rekomendasi : </b>Cara melakukan pengukuran dan penimbangan yang benar</br>
              <button type="button" class="btn btn-primary btn-sm mt-1" id="btnCekDisiniDataTubuh">
                <i class="fas fa-user-friends"></i> Cek Disini
              </button>
              
              <!-- PDF Viewer untuk Data Tracking -->
              <div class="pdf-viewer" id="pdfViewerDatatracking1" style="display: none;">
                <button class="close-pdf" onclick="closePDF('datatracking1')">
                  <i class="fas fa-times"></i>
                </button>
                <div class="pdf-container" id="pdfContainerDatatracking1">
                  <!-- PDF akan dimuat di sini -->
                </div>
              </div>  

              <div style="border-left-style:solid; border-left-color:#b1b1b1; border-width: 4px; padding-left: 10px; margin-top: 10px;">
                <p><i class="fas far fa-lightbulb mt-2 mb-2" style="color: #fa0000;"></i><b> Tips : </b>Pastikan menginput data dengan lengkap dan benar, agar anda bisa mendapatkan hasil analisa yang lebih akurat dari kami</p>
              </div>  

              <!-- Data Kondisi Tubuh -->
              <div class="mt-3 mb-2" id="kondisitubuh-container">
                <h6><b>INPUT DATA ANDA</b></h6> 
                <div id="kondisiTubuh">
                  <!-- Inputan Data Kondisi Tubuh dimuat di sini -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- MODUL HARI KE 2-10 (SAMA FITURE DAN STRUKTURNYA) -->
    
          <!-- TAMPILAN KREASI RESEP -->
          <div class="menu-accordion-item">
            <button class="menu-header collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#healthyRecept">
              <span>
                <i class="fas fa-angle-double-right me-2"></i>Resep Healthy Snacking
              </span>
              <i class="fas fa-angle-down menu-icon"></i>
            </button>
            <div class="collapse" id="healthyRecept" data-bs-parent="#menuAccordion">
              <div class="menu-content">
                <!-- Playlist Link - SIMPLE -->
                <a href="https://www.youtube.com/playlist?list=PLJU0P2EGDp-8Zs3cF6x84nF1wkB66hYvG" 
                  class="menu-item playlist-trigger" data-target="playlistHealthyRecept">
                  <i class="fas fa-play-circle"></i>Playlist Kreasi Resep Sehat
                </a>
                
                <!-- Playlist Container -->
                <div class="playlist-container" id="playlistHealthyRecept" style="display: none;">
                  <!-- Playlist items akan diisi oleh JavaScript -->
                </div>
                
                <!-- Video Player untuk Healthy Recept -->
                <div class="video-container" id="videoContainerHealthyRecept" style="display: none;">
                  <button class="close-video" onclick="closeVideo('healthyRecept')">
                    <i class="fas fa-times"></i>
                  </button>
                  <div class="video-wrapper">
                    <div class="video-placeholder" onclick="playVideo('healthyRecept')">
                      <i class="fas fa-play-circle"></i>
                      <div class="video-placeholder-text">Pilih video dari playlist</div>
                    </div>
                    <div class="video-loading" id="videoLoadingHealthyRecept">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading video...</span>
                      </div>
                    </div>
                    <div id="videoPlayerHealthyRecept"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAMPILAN DASHBOARD FIT TRACK -->
          <div class="menu-accordion-item">
            <button class="menu-header collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dasboardFitTrack">
              <span>
                <i class="fas fa-angle-double-right me-2"></i>Dashboard Fit Track
              </span>
              <i class="fas fa-angle-down menu-icon"></i>
            </button>
            <div class="collapse" id="dasboardFitTrack" data-bs-parent="#menuAccordion">
              <div class="menu-content">
                <a href="#" class="menu-item"><i class="fas fa-chart-line"></i>Fit Track1</a>
                <a href="#" class="menu-item"><i class="fas fa-heartbeat"></i>Fit Track2</a>
                <a href="#" class="menu-item"><i class="fas fa-dumbbell"></i>Fit Track3</a>
             </div>
            </div>
          </div>
        </div>

        <footer class="footer mt-3 text-black text-center p-2" style="font-size:12pt; background-color: #f1f1f1;">
          FIT Challenge Versi 1.0 ¬© 2025 Power by:<a href="https://www.beratidealku.com" class="text-black"> www.beratidealku.com</a></br>
          <img src="images/Logo_Herbalife_Independent_Member.png" alt="Logo" width="160" height="20">
        </footer>
      </div>
    </div>
  </div>
</div>

<!-- About Overlay -->
<div class="about-overlay" id="aboutOverlay">
  <div class="about-form">
    <h5 class="mb-2">Fat Loss Challenge Versi 1.0</h5>
    <br>Copyright ¬© 2025 <a href="https://www.beratidealku.com" class="text-black">www.beratidealku.com</a>
    <br>Allright Reserved
    <br>Hanya digunakan untuk kalangan internal
    <div class="d-grid mt-4">
      <button id="btnCloseAbout" class="btn btn-primary">OK</button>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
//******************
// DEKLARASI GLOBAL
//******************
const URL_PROGRAM_APP   = 'https://script.google.com/macros/s/AKfycbzxfHRDA4pXUNLJI01xAuQnlTI0GKNBf5H1oBgYt6r0UCum5Eg8wDtIcNKHreNSOpfcfg/exec';
const PLAYLIST_JSON_URL = './data/playlist.json';   // Daftar Video Resep Makanan & Minuman

/***************************************
* LOAD SEMUA ELEMENTS DOMContentLoaded *
***************************************/
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Aplikasi dimulai...');

    // 1. ACCORDION TOGGLE FIX (PERTAMA)
    let currentOpenMenu = null;
    document.querySelectorAll('.menu-header').forEach(header => {
        header.setAttribute('data-bs-toggle', '');
        
        header.addEventListener('click', function(e) {
            // CEK APAKAH DISABLED
            if (this.classList.contains('disabled')) {
                e.preventDefault();
                e.stopPropagation();
                showMessage('warning', 'Selesaikan Perkenalan terlebih dahulu!', 3000);
                return;
            }
            e.preventDefault();
            e.stopPropagation();
            
            const targetId = this.getAttribute('data-bs-target');
            const targetContent = document.querySelector(targetId);
            
            if (!targetContent) return;
            console.log('üîÑ Menu diklik:', targetId);
            
            // Jika klik menu yang sama yang sedang terbuka
            if (currentOpenMenu === targetId) {
                // TUTUP menu
                targetContent.style.display = 'none';
                targetContent.classList.remove('show');
                this.classList.add('collapsed');
                currentOpenMenu = null;
                console.log('‚úÖ Menu DITUTUP');
            } else {
                // BUKA menu baru
                // Tutup menu yang sebelumnya terbuka
                if (currentOpenMenu) {
                    const previousContent = document.querySelector(currentOpenMenu);
                    const previousHeader = document.querySelector(`[data-bs-target="${currentOpenMenu}"]`);
                    if (previousContent && previousHeader) {
                        previousContent.style.display = 'none';
                        previousContent.classList.remove('show');
                        previousHeader.classList.add('collapsed');
                    }
                }
                
                // Buka menu baru
                targetContent.style.display = 'block';
                targetContent.classList.add('show');
                this.classList.remove('collapsed');
                currentOpenMenu = targetId;
                console.log('‚úÖ Menu DIBUKA');
            }
        });
    });
 
    // Setup Menu Accordian toggle
    setupAccordionToggle();
    // Seetup semua komponen
    setupAllComponents();
    // SetUp Materi
    setupMateriCompletion();

    // 2. CEK STATUS USER DAN APPLY LOCK
    const userId = localStorage.getItem('userId');
    if (userId) {
      console.log('üîÑ Ambil progress dari server untuk user:', userId);
      fetchProgressFromServer(userId);
    } else {
      console.log('‚ö†Ô∏è Tidak ada user ID, mungkin redirect ke login');
    }

    console.log('‚úÖ Aplikasi siap');
});

/******************
* Show About form *
*******************/
function showAbout() {
  document.getElementById('aboutOverlay').style.display = 'flex';
}

/******************
* Hide About form *
*******************/  
function hideAbout() {
  document.getElementById('aboutOverlay').style.display = 'none';
}

/*****************************************
* Logout function dengan clear user data *
******************************************/
function logout() {
    const userId = localStorage.getItem('userId');
    
    // Clear user-specific progress data
    if (userId) {
        localStorage.removeItem(`progressData_${userId}`);
    }
    
    // Clear general data
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('userToken');
    localStorage.removeItem('userLevel');
    localStorage.removeItem('progressData'); // General progress data
    sessionStorage.removeItem('aksesList');
    
    // Clear semua workout data user spesifik
    for (let i = 1; i <= 10; i++) {
        localStorage.removeItem(`workout_kardio_file_${i}`);
        localStorage.removeItem(`workout_kardio_filename_${i}`);
        localStorage.removeItem(`workout_kardio_type_${i}`);
        localStorage.removeItem(`workout_start_time_${i}`);
        localStorage.removeItem(`workout_stop_time_${i}`);
        localStorage.removeItem(`workout_saved_${i}`);
        localStorage.removeItem(`workout_status_${i}`);
    }
    // Redirect ke halaman login
    window.location.href = 'loginFC.html';
}

/***************************************************************
   Tandai Submenu Selesai (Generic & Reusable)
   @param {number} hariKe           - Hari ke (1‚Äì10)
   @param {string} submenuKeyword   - Kata kunci submenu
     Contoh: 'Water Reminder','Materi', 'Meal Plan', 'Workout'
***************************************************************/
function tandaiSubmenuSelesai(hariKe, submenuKeyword) {
  document.querySelectorAll('.menu-item').forEach(item => {
    const text = item.textContent || '';
    const cocokHari = hariKe == null || text.includes(`Hari ${hariKe}`);
    const cocokSub = text.includes(submenuKeyword);

    if (cocokHari && cocokSub) {
      // item.style.fontWeight = 'bold';
      if (!item.querySelector('.submenu-done')) {
        const icon = document.createElement('span');
        icon.className = 'submenu-done';
        icon.innerHTML = '‚úì';
        icon.style.cssText = `
          display:inline-flex;
          align-items:center;
          justify-content:center;
          width:14px;height:14px;
          border-radius:50%;
          border:1.5px solid #2ecc71;
          color:#2ecc71;
          font-size:10px;
          margin-left:6px;
        `;
        item.appendChild(icon);
      }
    }
  });
}

/***************************************************************
   Ambil Container Submenu Berdasarkan Hari
   @param {number} hariKe
   @param {string} prefix bisa : materiContent ,mealPlanContent, workoutContent, dst
***************************************************************/
function getSubmenuContainer(hariKe, prefix) {
  if (!hariKe || !prefix) return null
  return document.getElementById(prefix + hariKe);
}

/***************************************************************
   Enable / Disable Semua Komponen di Submenu
   @param {number} hariKe
   @param {string} containerPrefix
   @param {boolean} disabled
***************************************************************/
function setSubmenuDisabled(hariKe, containerPrefix, disabled = true) {
  const container = getSubmenuContainer(hariKe, containerPrefix);
  if (!container) return;
  // Disable semua input
  const inputs = container.querySelectorAll(
    'input, select, textarea, button'
  );
  inputs.forEach(el => {
    el.disabled = disabled;
  });
}

function disableCentangDiSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) return;

  const btn = section.querySelector('a, button');
  if (btn) {
    btn.style.pointerEvents = 'none';
    btn.style.opacity = '0.5';
    btn.classList.add('disabled');
  }
}


/**************************************************************************
 * Fungsi universal untuk menampilkan pesan
 * @param {string} type - Tipe pesan: 'success', 'error', 'warning', 'info'
 * @param {string} message - Pesan yang akan ditampilkan
 * @param {number} duration - Durasi tampil (ms), 0 = tidak auto-hide
 * @param {string} menuTarget - Target menu (otomatis detect jika null)
 **************************************************************************/
function showMessage(type, message, duration = 3000, menuTarget = null) {
    // Auto-detect menu target jika tidak diberikan
    if (!menuTarget) {
        const activeMenu = document.querySelector('.menu-header:not(.collapsed)');
        if (activeMenu && activeMenu.hasAttribute('data-hari')) {
            const hariKe = activeMenu.getAttribute('data-hari');
            menuTarget = `pertemuan${hariKe}`;
        }
    }
    // Konfigurasi tipe pesan
    const typeConfig = {
        success: { cssClass: 'notification-success', icon: 'fas fa-check-circle' },
        error: { cssClass: 'notification-error', icon: 'fas fa-times-circle' },
        warning: { cssClass: 'notification-warning', icon: 'fas fa-exclamation-circle' },
        info: { cssClass: 'notification-info', icon: 'fas fa-info-circle' }
    };

    const config = typeConfig[type] || typeConfig.info;
    // Buat element pesan
    const messageElement = document.createElement('div');
    messageElement.className = `notification-message w-100 mb-2 ${config.cssClass}`;
    // Jika toast, tambahkan class khusus
    if (menuTarget === 'toast') {
        messageElement.classList.add('toast-message');
        menuTarget = null; // Reset untuk toast
    }
    messageElement.innerHTML = `
        <i class="pesan-notif-icon me-2 ${config.icon}"></i>
        <span class="flex-grow-1">${message}</span>
        <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.remove()"></button>
    `;
    // Tentukan target container
    let targetContainer = document.body;
    if (menuTarget) {
        const menuElement = document.getElementById(menuTarget + 'Content');
        if (menuElement) {
            const menuContent = menuElement.querySelector('.menu-content');
            if (menuContent) {
                targetContainer = menuContent;
            }
        }
    } else {
        // Untuk pesan general, cari container yang aktif
        const activeMenu = document.querySelector('.menu-header:not(.collapsed)');
        if (activeMenu && activeMenu.hasAttribute('data-hari')) {
            const hariKe = activeMenu.getAttribute('data-hari');
            const menuElement = document.getElementById(`pertemuan${hariKe}Content`);
            if (menuElement) {
                const menuContent = menuElement.querySelector('.menu-content');
                if (menuContent) {
                    targetContainer = menuContent;
                }
            }
        }
    }
    // Tambahkan pesan ke container
    targetContainer.insertBefore(messageElement, targetContainer.firstChild);
    messageElement.style.display = 'flex';

    // Auto-hide jika duration > 0
    if (duration > 0) {
        setTimeout(() => {
            if (messageElement.parentElement) {
                messageElement.remove();
            }
        }, duration);
    }
    return messageElement;
}

/*************************
* Helper untuk nama hari *
**************************/
function getDayName(hariKe) {
    const dayNames = {
        1: 'Pertama',
        2: 'Kedua', 
        3: 'Ketiga',
        4: 'Keempat',
        5: 'Kelima',
        6: 'Keenam',
        7: 'Ketujuh',
        8: 'Kedelapan',
        9: 'Kesembilan',
        10: 'Kesepuluh'
    };
    return dayNames[hariKe] || `ke-${hariKe}`;
}

/**********************************************
* Simpan status completion dengan user prefix *
***********************************************/
function saveCompletionStatus(submenuType, hariKe, status) {
    const userId = localStorage.getItem('userId');
    if (!userId) return;
    
    const key = `${submenuType}_${userId}_hari_${hariKe}`;
    localStorage.setItem(key, status);
    localStorage.setItem(`${key}_completed`, new Date().toISOString());
    
    // Update progress data di localStorage
    const progressKey = `progressData_${userId}`;
    let progressData = JSON.parse(localStorage.getItem(progressKey) || '{}');
    
    if (!progressData.success) {
        progressData = {
            success: true,
            perkenalan: progressData.perkenalan || false,
            materiHari1: progressData.materiHari1 || false,
            mealplanHari1: progressData.mealplanHari1 || false,
            workoutHari1: progressData.workoutHari1 || false,
            waterHari1: progressData.waterHari1 || false,
            istirahatHari1: progressData.istirahatHari1 || false,
            datatrackingHari1: progressData.datatrackingHari1 || false
        };
    }
    
    // Update field yang sesuai
    const fieldMap = {
        'materi': 'materiHari1',
        'mealplan': 'mealplanHari1',
        'workout': 'workoutHari1',
        'water': 'waterHari1',
        'istirahat': 'istirahatHari1',
        'datatracking': 'datatrackingHari1'
    };
    
    const field = fieldMap[submenuType];
    if (field && hariKe === 1) {
        progressData[field] = true;
    }
    
    localStorage.setItem(progressKey, JSON.stringify(progressData));
    
    // Apply UI changes
    disableButtonsAfterCompletion(hariKe, submenuType);
    updateSubmenuLinkUI(hariKe, submenuType);
}

/**********************************************
* Check status completion untuk user tertentu *
***********************************************/
function checkCompletionStatus(userId, submenuType, hariKe) {
    // Cek dari localStorage user-specific
    const key = `${submenuType}_${userId}_hari_${hariKe}`;
    const status = localStorage.getItem(key);
    
    if (status === 'completed') {
        return true;
    }
    
    // Fallback: cek dari progress data
    const progressKey = `progressData_${userId}`;
    const progressData = JSON.parse(localStorage.getItem(progressKey) || '{}');
    
    if (progressData.success && hariKe === 1) {
        const fieldMap = {
            'materi': 'materiHari1',
            'mealplan': 'mealplanHari1',
            'workout': 'workoutHari1',
            'water': 'waterHari1',
            'istirahat': 'istirahatHari1',
            'datatracking': 'datatrackingHari1'
        };
        
        const field = fieldMap[submenuType];
        return progressData[field] || false;
    }
    
    return false;
}


function setupAccordionToggle() {
    let currentOpenMenu = null;
    
    document.querySelectorAll('.menu-header').forEach(header => {
        header.setAttribute('data-bs-toggle', '');
        
        header.addEventListener('click', function(e) {
            // CEK APAKAH DISABLED
            if (this.classList.contains('disabled')) {
                e.preventDefault();
                e.stopPropagation();
                showMessage('warning', 'Selesaikan Perkenalan terlebih dahulu!', 3000);
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const targetId = this.getAttribute('data-bs-target');
            const targetContent = document.querySelector(targetId);
            
            if (!targetContent) return;
            
            // Accordion toggle logic...
            if (currentOpenMenu === targetId) {
                // TUTUP menu
                targetContent.style.display = 'none';
                targetContent.classList.remove('show');
                this.classList.add('collapsed');
                currentOpenMenu = null;
            } else {
                // BUKA menu baru
                if (currentOpenMenu) {
                    const previousContent = document.querySelector(currentOpenMenu);
                    const previousHeader = document.querySelector(`[data-bs-target="${currentOpenMenu}"]`);
                    if (previousContent && previousHeader) {
                        previousContent.style.display = 'none';
                        previousContent.classList.remove('show');
                        previousHeader.classList.add('collapsed');
                    }
                }
                
                // Buka menu baru
                targetContent.style.display = 'block';
                targetContent.classList.add('show');
                this.classList.remove('collapsed');
                currentOpenMenu = targetId;
            }
        });
    });
}

/**************************************
* Apply Lock System yang lebih strict *
***************************************/
function applyLockSystem(progress) {
  console.log('üîí Apply Lock System (USER BARU SAJA)');

  // hanya lock jika perkenalan BELUM selesai
  if (progress.perkenalan === true) return;

  for (let i = 1; i <= 10; i++) {
    const header = document.querySelector(`[data-hari="${i}"]`);
    if (!header) continue;

    header.classList.add('disabled');
    header.style.pointerEvents = 'none';
    header.style.cursor = 'not-allowed';
  }

  // perkenalan tetap aktif
  const perkenalanHeader =
    document.querySelector('[data-bs-target="#perkenalanContent"]');

  if (perkenalanHeader) {
    perkenalanHeader.classList.remove('disabled');
    perkenalanHeader.style.pointerEvents = 'auto';
    perkenalanHeader.style.cursor = 'pointer';
  }
}

/*************************************
* Terapkan Progress User dari Server *
**************************************/
function applyExistingUserProgress(progress) {
   console.log('üìä Apply Existing Progress FINAL');

  // Simpan global
  window.userProgress = progress;

  // PERKENALAN
  if (progress.perkenalan === true) {
    updateSubmenuLinkUI('perkenalan', 0);
    disableSelesaiPerkenalanButton();
    unlockModul(1);
  }

  // MATERI HARI 1‚Äì10
  for (let hariKe = 1; hariKe <= 10; hariKe++) {
    if (progress[`materiHari${hariKe}`] === true) {
      lockMateriVideo(hariKe);
      const btn = document.getElementById(`btnMateriDone${hariKe}`);
      if (btn) disableButtonFully(btn);
      updateSubmenuLinkUI('materi', hariKe);
    }
  }

  // MEAL PLAN HARI 1‚Äì10
  for (let hariKe = 1; hariKe <= 10; hariKe++) {
    if (progress[`mealplanHari${hariKe}`] === true) {
      lockMealPlanUI(hariKe);
      updateSubmenuLinkUI('mealplan', hariKe);
    }
  }

  // SUBMENU WORKOUT 1-10 
  for (let hariKe = 1; hariKe <= 10; hariKe++) {
    if (progress[`workoutHari${hariKe}`] === true) {  
      console.log(`‚úÖ Restore Workout Hari ${hariKe} (login)`);
      // ‚úÖ Tampilkan centang hijau di submenu
      updateSubmenuLinkUI('workout', hariKe);
      // üîí Kunci SEMUA UI workout (kardio + resistance)
      disableButtonsAfterCompletion(hariKe, 'workout');
    }
  }

  // WATER REMINDER HARI 1‚Äì10
  for (let hariKe = 1; hariKe <= 10; hariKe++) {
    if (progress[`waterHari${hariKe}`] === true) {
      // ‚úÖ Tampilkan centang hijau di submenu
      updateSubmenuLinkUI('water', hariKe);
      disableButtonsAfterCompletion(hariKe, 'water');
    }
  }
}

/************************************
* Disable button secara TOTAL (UX) *
************************************/
function disableButtonFully(el) {
    if (!el) return;

    el.disabled = true;
    el.dataset.done = 'true';
    el.style.pointerEvents = 'none';
    el.style.cursor = 'default';
    el.onclick = null;

    if (el.classList.contains('btn-success')) {
        el.classList.remove('btn-success');
        el.classList.add('btn-secondary');
    }

    const parent = el.parentElement;
    if (parent) parent.style.cursor = 'default';
}

/**************************************
 * Kunci UI Meal Plan 
 * - HANYA disable tombol uploadMealItem
 * - X Form & X PDF TETAP AKTIF
 **************************************/
function lockMealPlanUI(hariKe) {
  console.log(`üîí Mengunci Meal Plan UI hari ${hariKe}`);

  const container = document.getElementById(`mealPlanContent${hariKe}`);
  if (!container) return;
  
  //* 1Ô∏è‚É£ DISABLE TOMBOL UPLOAD MEAL PLAN (BERDASARKAN onclick)
  container.querySelectorAll('button[onclick]').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';

    // ‚úÖ HANYA tombol upload meal
    if (onclick.includes('uploadMealItem')) {
      disableButtonFully(btn);
    }
  });

  // 2Ô∏è‚É£ DISABLE INPUT TEXT (VISUAL LOCK)
  container.querySelectorAll('input.form-control').forEach(input => {
    input.readOnly = true;
    input.style.pointerEvents = 'none';
    input.style.opacity = '0.6';
  });

  // 3Ô∏è‚É£ DISABLE TOMBOL SELESAI
  const btnSelesai = document.getElementById(`btnSelesaiMealPlan${hariKe}`);
  if (btnSelesai) {
    disableButtonFully(btnSelesai);
  }
   console.log(`‚úÖ Meal Plan hari ${hariKe} terkunci (X & PDF tetap aktif)`);
}

/***************************************
* Strict Lock Modul (benar-benar lock) *
****************************************/
function strictLockModul(hariKe) {
    const modulHeader = document.querySelector(`[data-hari="${hariKe}"]`);
    if (modulHeader) {
        // 1. Add disabled class
        modulHeader.classList.add('disabled');
        
        // 2. Remove click event listener yang ada
        const newHeader = modulHeader.cloneNode(true);
        modulHeader.parentNode.replaceChild(newHeader, modulHeader);
        
        // 3. Set style untuk benar-benar disabled
        newHeader.style.pointerEvents = 'none';
        newHeader.style.opacity = '0.5';
        newHeader.style.cursor = 'not-allowed';
        newHeader.style.backgroundColor = '#f8f9fa'; // Background abu-abu
        
        // 4. Update lock icon
        const lockIcon = newHeader.querySelector('.status-lock, .status-unlock');
        if (lockIcon) {
            lockIcon.className = 'status-lock';
            //lockIcon.style.color = '#000e3d'; // Warna biru tua
        }
        
        // 5. Add tooltip "Selesaikan Perkenalan dulu"
        newHeader.title = 'Selesaikan Perkenalan terlebih dahulu!';
        newHeader.setAttribute('data-bs-toggle', 'tooltip');
        newHeader.setAttribute('data-bs-placement', 'top');
        
        console.log(`üîí STRICT LOCK Modul Hari ${hariKe}`);
        
        // Initialize Bootstrap tooltip
        new bootstrap.Tooltip(newHeader);
    }
}

/*********************************
* Unlock modul dengan icon benar *
**********************************/
function unlockModul(hariKe) {
    console.log(`üîì Attempting to unlock Modul Hari ${hariKe}`);
    
    const modulHeader = document.querySelector(`[data-hari="${hariKe}"]`);
    if (!modulHeader) {
        console.error(`‚ùå Modul header not found for hari ${hariKe}`);
        return;
    }
    
    console.log('üìå Modul header found:', modulHeader);
    
    // 1. Remove disabled class
    modulHeader.classList.remove('disabled');
    
    // 2. Restore style
    modulHeader.style.pointerEvents = 'auto';
    modulHeader.style.opacity = '1';
    modulHeader.style.cursor = 'pointer';
    modulHeader.style.backgroundColor = ''; // Reset background color
    
    // 3. Update lock icon ke UNLOCK
    let lockIcon = modulHeader.querySelector('.status-lock, .status-unlock');
    
    if (!lockIcon) {
        // Cari icon di dalam span
        const iconSpan = modulHeader.querySelector('span');
        if (iconSpan) {
            lockIcon = iconSpan.querySelector('i.fa-lock, i.fa-unlock, i.fa-check-circle');
        }
    }
    
    if (lockIcon) {
        console.log('üîë Found lock icon:', lockIcon.className);
        lockIcon.className = 'fas fa-unlock status-unlock';
        lockIcon.style.color = '#000e3d'; // Warna biru tua
    } else {
        console.warn('‚ö†Ô∏è No lock icon found, creating new one');
        // Buat icon baru
        const iconContainer = modulHeader.querySelector('span');
        if (iconContainer) {
            const newIcon = document.createElement('i');
            newIcon.className = 'fas fa-unlock status-unlock';
            newIcon.style.color = '#000e3d'; // Warna biru tua
            newIcon.style.marginLeft = '2px' //'10px';
            iconContainer.appendChild(newIcon);
        }
    }
    
    // 4. Remove tooltip
    modulHeader.removeAttribute('title');
    modulHeader.removeAttribute('data-bs-toggle');
    modulHeader.removeAttribute('data-bs-placement');
    
    // 5. Remove any Bootstrap tooltip instance
    if (modulHeader._tooltip) {
        modulHeader._tooltip.dispose();
    }
    
    console.log(`‚úÖ Modul Hari ${hariKe} UNLOCKED successfully`);
}

/************************************
* Lock semua modul untuk user baru  *
*************************************/
function applyLockForNewUser() {
    console.log('üîê STRICT lock semua modul untuk user baru');

    // üîí STRICT LOCK modul hari 1‚Äì10
    for (let i = 1; i <= 10; i++) {
        strictLockModul(i); // ‚úÖ PAKAI YANG BENAR
    }

    // ‚úÖ Perkenalan tetap terbuka
    const perkenalanHeader = document.querySelector('[data-bs-target="#perkenalanContent"]');
    if (perkenalanHeader) {
        perkenalanHeader.classList.remove('disabled');
        perkenalanHeader.style.pointerEvents = 'auto';
        perkenalanHeader.style.opacity = '1';
        perkenalanHeader.style.cursor = 'pointer';
    }
    console.log('‚úÖ User baru: hanya Perkenalan yang aktif');
}

/***********************
* Lock modul tertentu  *
************************/
function lockModul(hariKe) {
    const modulHeader = document.querySelector(`[data-hari="${hariKe}"]`);
    if (modulHeader) {
        // Skip jika sudah unlocked
        if (!modulHeader.classList.contains('disabled')) {
            modulHeader.classList.add('disabled');
            modulHeader.style.pointerEvents = 'none';
            modulHeader.style.opacity = '0.6';
            modulHeader.style.cursor = 'not-allowed';
            
            // Update lock icon
            let lockIcon = modulHeader.querySelector('.status-lock, .status-unlock');
            if (lockIcon) {
                lockIcon.className = 'fas fa-lock status-lock';
                //lockIcon.style.color = '#000e3d';
            } else {
                // Cari atau buat icon
                const iconContainer = modulHeader.querySelector('span');
                if (iconContainer) {
                    const existingIcon = iconContainer.querySelector('i');
                    if (existingIcon) {
                        existingIcon.className = 'fas fa-lock status-lock';
                        //existingIcon.style.color = '#000e3d';
                    } else {
                        const newIcon = document.createElement('i');
                        newIcon.className = 'fas fa-lock status-lock';
                        //newIcon.style.color = '#000e3d';
                        newIcon.style.marginLeft = '2px' //'10px';
                        iconContainer.appendChild(newIcon);
                    }
                }
            }
            
            console.log(`üîí Modul Hari ${hariKe} dikunci`);
        }
    }
}

/*******************************
* Update UI Perkenalan lengkap *
********************************/
function updatePerkenalanUI() {
  console.log('üîÑ Updating Perkenalan UI...');
  const status = getCompletionStatus('perkenalan', 0);
  if (status === 'completed') {
    // 1Ô∏è‚É£ Disable tombol ‚úì video SAJA
    const section = document.getElementById('perkenalanContent');
    if (section) {
      const btn = section.querySelector('.btn-check, a, button');
      if (btn) {
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.5';
      }
    }
    // 2Ô∏è‚É£ Tandai submenu selesai
    tandaiSubmenuSelesai(null, 'Selesai Perkenalan');
  }

  console.log('‚úÖ Perkenalan UI updated');
}

function setupAllComponentsInternal() {
    // Submenu triggers
    document.querySelectorAll('.submenu-trigger').forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('data-target');
            showSubmenu(target);
        });
    });
    
    // Setup tombol close di semua submenu
    document.querySelectorAll('.btn-close-header').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.closest('.submenu-content').id;
            hideSubmenu(targetId);
        });
    });

    // Setup video links
    setupAllLinks();
    
    // Setup playlist
    setupPlaylistTriggers();
    
    // Setup Materi Perkenalan
    setupPerkenalanCompletion();
    
    // Setup PDF links
    setupPanduanPDFLinks();

    // Setup tombol "Cek Disini" untuk Modul 
    setupCekDisiniButtons();
    
    // Setup materi completion
    setupMateriCompletion();
    
    // Check materi status dari localStorage
    for (let i = 1; i <= 10; i++) {
        checkMateriStatus(i);
    }
    
    // Setup meal plan forms
    generateMealPlanForms();
    
    // Cek status meal plan
    for (let i = 1; i <= 10; i++) {
        checkMealPlanStatus(i);
        loadMealPlanProgress(i);
    }
    
    // Setup tentang overlay
    document.getElementById('btnCloseAbout').addEventListener('click', hideAbout);
    // Setup workout forms
    generateWorkoutForms();      // 1. Generate HTML dulu
    initializeAllWorkoutDays();  // 2. Setup event listeners
 
    // Tambahkan styles
    addWaterReminderStyles(); 
    // Generate semua form
    initializeAllWaterReminderForms(); 
    // Update onclick handlers untuk water reminder links
    for (let i = 1; i <= 10; i++) {
        const waterLink = document.querySelector(`[onclick="waterReminder(${i})"]`);
        if (waterLink) {
            waterLink.onclick = function(e) {
                e.preventDefault();
                showWaterReminderForm(i);
            };
        }
    }

    /* ======================================
      Menandai hari aktif saat klik tombol simpan & selesai water
      ====================================== */
    document.querySelectorAll('[data-target^="waterReminderContent"]').forEach(item => {
      item.addEventListener('click', function () {
        const hariKe = parseInt(
          this.getAttribute('data-target').replace('waterReminderContent', '')
        );

        // SIMPAN REFERENSI HARI AKTIF
        window.activeWaterHari = hariKe;
      });
    });

    //  INITIAL STATE WATER REMINDER
    document.querySelectorAll('[id^="btnSelesaiWater"]').forEach(btn => {
      btn.disabled = true;
    });

    // Initialize video players
    initializeAllVideoPlayers();
    
    // Di akhir setupAllComponentsInternal()
    console.log('üîç Testing server connection on startup...');
}

/**************************************
* Update navbar untuk user yang login *
***************************************/
function updateNavbarForLoggedInUser() {
  const loginMenuItem = document.getElementById('loginMenuItem');
  if (!loginMenuItem) return;

  const userId = localStorage.getItem('userId');
  if (!userId) return;

  const parentUl = loginMenuItem.closest('ul.navbar-nav');
  if (parentUl) {
    // Mobile ‚Üí kiri | Desktop ‚Üí kanan
    if (window.innerWidth <= 591) {
      parentUl.classList.remove('ms-auto', 'mx-auto');
    } else {
      parentUl.classList.add('ms-auto');
      parentUl.classList.remove('mx-auto');
    }
  }

  // üîë PENTING: pakai nav-link, BUKAN div
  loginMenuItem.innerHTML = `
    <a href="#" class="nav-link main-menu-link d-flex align-items-center gap-3" onclick="logout()">
      <span class="fw-bold text-dark">
        <i class="fas fa-user me-1"></i>${userId}
      </span>
      <i class="fas fa-sign-out-alt text-danger"></i>
    </a>
  `;
}

// Di dalam generate HTML untuk submenu
function createSubmenuHTML(hariKe) {
    return `
        <!-- Materi Video -->
        <a href="https://www.youtube.com/watch?v=Zg_badTE2Ec" 
          class="menu-item video-link" onclick="showSubmenuWithStatus('videoContainerPertemuan${hariKe}', ${hariKe}, 'materi')"
          style="max-width: 100%;" data-section="pertemuan${hariKe}" 
          data-type="youtube" data-url="https://www.youtube.com/watch?v=Zg_badTE2Ec" id="materiLink${hariKe}">
          ${hariKe}.1 Materi Hari ${getDayName(hariKe)} 
        </a>
        
        <!-- Meal Plan -->
        <a href="#" 
          class="menu-item submenu-trigger" onclick="showSubmenuWithStatus('mealPlanContent${hariKe}', ${hariKe}, 'mealplan')" 
          data-target="mealPlanContent${hariKe}" id="mealPlanLink${hariKe}">
          ${hariKe}.2 Meal Plan Hari ${getDayName(hariKe)}
       </a>
        
        <!-- Workout -->
        <a href="#"
          class="menu-item submenu-trigger" onclick="showSubmenuWithStatus('workoutContent${hariKe}', ${hariKe}, 'workout')" 
          data-target="workoutContent${hariKe}" id="workoutLink${hariKe}">
          ${hariKe}.3 Workout Hari ${getDayName(hariKe)}
        </a>
        
        <!-- Water Reminder -->
        <a href="#"
          class="menu-item submenu-trigger" onclick="showSubmenuWithStatus('waterReminderContent${hariKe}', ${hariKe}, 'water')" 
          data-target="waterReminderContent${hariKe}" id="waterLink${hariKe}">
          ${hariKe}.4 Water Reminder Hari ${getDayName(hariKe)}
        </a>
        
        <!-- Waktu Istirahat -->
        <a href="#"
          class="menu-item submenu-trigger" onclick="showSubmenuWithStatus('istirahatContent${hariKe}', ${hariKe}, 'istirahat')" 
          data-target="istirahatContent${hariKe}" id="istirahatLink${hariKe}">
          ${hariKe}.5 Waktu Istirahat Hari ${getDayName(hariKe)}
        </a>
        
        <!-- Data Tracking -->
        <a href="#"
          class="menu-item submenu-trigger" onclick="showSubmenuWithStatus('dataTrackingContent${hariKe}', ${hariKe}, 'datatracking')" 
          data-target="dataTrackingContent${hariKe}" id="trackingLink${hariKe}">
          ${hariKe}.6 Data Tracking Hari ${getDayName(hariKe)}
        </a>
        
        <!-- Selesai Modul -->
        <a href="#" class="menu-item" onclick="selesaiModul(${hariKe})" id="selesaiModulLink${hariKe}">
          Selesai Modul hari ${getDayName(hariKe)}
        </a>
    `;
}

/**********************************************************
* Load progress dari localStorage dan apply button status *
***********************************************************/
function loadProgressFromStorage() {
    console.log('üìÇ Memuat progress dari storage...');
    
    // Ambil data progress
    const progressData = localStorage.getItem('progressData');
    const userId = localStorage.getItem('userId');
    
    if (progressData) {
        const progress = JSON.parse(progressData);
        console.log('üìä Progress ditemukan:', progress);
        
        // APLIKASIKAN KE UI
        applyProgressToUI(progress);
        
        // Apply button status untuk semua hari
        for (let hariKe = 1; hariKe <= 10; hariKe++) {
            checkAndApplyButtonStatus(hariKe);
        }
    } else if (userId) {
        // Jika ada userId tapi tidak ada progress, coba ambil dari server
        console.log('üîÑ Ambil progress dari server...');
        fetchProgressFromServer(userId);
    }
}

/**********************************************
* FUNGSI LOAD COMPLETE PROGRESS DARI SERVER
* + RESTORE NAMA KONSUMEN (FIX FINAL)
**********************************************/
async function loadCompleteProgressFromServer(userId, hariKe = 1) {
  return new Promise((resolve, reject) => {
    console.log(`üì° Loading COMPLETE progress for ${userId}, day ${hariKe}`);

    const callbackName = 'cb_complete_progress_' + Date.now();
    const script = document.createElement('script');

    script.src =
      `${URL_PROGRAM_APP}?action=getUserCompleteProgress` +
      `&userId=${encodeURIComponent(userId)}` +
      `&hariKe=${hariKe}` +
      `&callback=${callbackName}`;

    window[callbackName] = function (response) {
      console.log('üìä Complete progress response:', response);

      try {
        if (response && response.success) {

          /* ======================================================
           * üîë FIX UTAMA: SIMPAN NAMA KONSUMEN KE LOCALSTORAGE
           * Sumber: sheet PROGRAM kolom E (Nama Konsumen)
           * ====================================================== */
          if (
            response.workoutData &&
            response.workoutData.namaKonsumen &&
            response.workoutData.namaKonsumen.trim() !== ''
          ) {
            localStorage.setItem(
              'namaKonsumen',
              response.workoutData.namaKonsumen.trim()
            );
            console.log(
              'üë§ Nama Konsumen disimpan:',
              response.workoutData.namaKonsumen
            );
          }

          // Simpan complete progress user
          localStorage.setItem(
            `completeProgress_${userId}`,
            JSON.stringify(response)
          );

          // Apply ke UI (materi, mealplan, workout, dll)
          applyCompleteProgressToUI(response, hariKe);

          resolve(response);

        } else {
          console.error('‚ùå Failed to load complete progress:', response);
          reject(new Error(response?.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('‚ùå Error processing progress:', err);
        reject(err);
      }

      // Cleanup
      document.body.removeChild(script);
      delete window[callbackName];
    };

    script.onerror = () => {
      console.error('‚ùå Script error loading complete progress');
      document.body.removeChild(script);
      delete window[callbackName];
      reject(new Error('Failed to load progress'));
    };

    document.body.appendChild(script);
  });
}

/********************************************
/* APPLY COMPLETE PROGRESS TO UI - DETAILED *
/********************************************/
function applyCompleteProgressToUI(progress, hariKe) {
  console.log('üéØ Applying COMPLETE progress to UI:', progress);

  // Inisialisasi Global Progress
  if (!window.userProgress) {
    window.userProgress = {};
  }

  // Perkenalan
  if (progress.perkenalan === true) {
    unlockModul(hariKe);
  }
  
  // Status Submenu hari Pertama
  const progressMap = [
    { field: 'materiHari1',   type: 'materi' },
    { field: 'mealplanHari1', type: 'mealplan' },
    { field: 'workoutHari1',  type: 'workout' },
    { field: 'waterHari1',    type: 'water' },
    { field: 'istirahatHari1', type: 'istirahat' },
    { field: 'datatrackingHari1', type: 'datatracking' }
  ];

  progressMap.forEach(item => {
    if (progress[item.field] === true) {
      window.userProgress[item.field] = true;
      updateSubmenuLinkUI(item.type, hariKe);
      if (item.type === 'workout') {
        disableButtonsAfterCompletion(hariKe, 'workout');
      }
    }
  });

  // Automatis Expand Modul
  if (
    progress.perkenalan ||
    progress.materiHari1 ||
    progress.mealplanHari1 ||
    progress.workoutHari1 ||
    progress.waterHari1
  ) {
    setTimeout(() => {
      const header = document.querySelector(`[data-hari="${hariKe}"]`);
      if (header && header.classList.contains('collapsed')) {
        header.click();
      }
    }, 800);
  }
}

/*****************************************
/* LOAD SAVED WORKOUT DATA DARI PROGRESS *
/*****************************************/
function loadWorkoutSavedData(hariKe) {
  console.log(`üíæ Loading saved workout data for day ${hariKe}`);

  if (!window.userProgressData || !window.userProgressData.workoutData) {
    console.warn('‚ö†Ô∏è Tidak ada workoutData tersimpan');
    return;
  }

  const data = window.userProgressData.workoutData;
  if (!data || typeof data !== 'object') {
    console.warn('‚ö†Ô∏è workoutData invalid:', data);
    return;
  }

  // Kardio
  const kardioSelect = document.getElementById(`kardio${hariKe}`);
  if (kardioSelect && data.kardio) {
    kardioSelect.value = data.kardio;
  }

  // Resistance akan tetap dibuat oleh flow normal
  console.log('‚úÖ Workout saved data applied safely');
}

/************************************************
/* Extract File Name dari Drive URL *
*************************************************/
function extractFileNameFromDriveUrl(driveUrl, hariKe) {
    console.log('üîó Extracting filename from Drive URL:', driveUrl);

    if (!driveUrl) return '';

    try {
        let fileId = '';

        // Format: /file/d/FILE_ID/view
        if (driveUrl.includes('/file/d/')) {
            const start = driveUrl.indexOf('/d/') + 3;
            const end = driveUrl.indexOf('/', start);
            fileId = driveUrl.substring(start, end);
        }

        // Format: uc?id=FILE_ID
        if (driveUrl.includes('uc?id=')) {
            const params = new URLSearchParams(driveUrl.split('?')[1]);
            fileId = params.get('id');
        }

        if (!fileId) return '';

        // Ambil filename jika pernah disimpan
        const savedName = localStorage.getItem(`drive_filename_${fileId}`);
        if (savedName) return savedName;

        // Fallback: generate ulang
        const userId     = localStorage.getItem('userId') || 'user';
        const kardioType = document.getElementById(`olahragaKardio${hariKe}`)?.value || 'Kardio';

        return `${userId}_KA${hariKe}${kardioType}.jpg`;

    } catch (err) {
        console.error('‚ùå extractFileName error:', err);
        return '';
    }
}

/****************************
* Save filename saat upload *
*****************************/
function saveDriveFileInfo(fileId, fileName) {
    if (fileId && fileName) {
        localStorage.setItem(`drive_filename_${fileId}`, fileName);
        console.log(`üíæ Saved filename mapping: ${fileId} -> ${fileName}`);
    }
}

/********************************************
/* ADD RESISTANCE EXERCISE FROM SAVED DATA *
/********************************************/
function addResistanceExerciseFromSaved(hariKe, exerciseName) {
  console.log(`‚ûï Adding saved resistance exercise: ${exerciseName} for day ${hariKe}`);
  
  const containerId = `selectedResistanceContainer${hariKe}`;
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`‚ùå Container not found: ${containerId}`);
    return;
  }
  
  const exerciseId = exerciseName.toLowerCase().replace(/\s+/g, '-');
  const fullExerciseId = `resistance-${hariKe}-${exerciseId}`;
  
  // Cek apakah sudah ada
  if (document.getElementById(fullExerciseId)) {
    return;
  }
  
  const exerciseElement = document.createElement("div");
  exerciseElement.id = fullExerciseId;
  exerciseElement.className = "resistance-exercise-item card mb-3";
  exerciseElement.innerHTML = `  
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="card-title mb-0 text-primary">${exerciseName} ‚úì</h6>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-secondary btn-sm" disabled
                  data-bs-toggle="tooltip" title="Sudah selesai">
            <i class="fas fa-check-double"></i>
          </button>
        </div>
      </div>
      
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <div class="input-group input-group-sm">	
            <span class="input-group-text"><i class="fas fa-user-cog"></i></span>
            <input type="number" min="0" id="jmlSet-${hariKe}-${exerciseId}" class="form-control" 
                   placeholder="Jumlah set" disabled style="background-color: #f8f9fa;">
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fas fa-user-plus"></i></span>
            <input type="number" min="0" id="jmlRepetisi-${hariKe}-${exerciseId}" class="form-control" 
                   placeholder="Jumlah Repetisi" disabled style="background-color: #f8f9fa;">
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fas fa-user-clock"></i></span>
            <input type="number" min="0" id="jmlDurasi-${hariKe}-${exerciseId}" class="form-control" 
                   placeholder="Durasi (Menit)" disabled style="background-color: #f8f9fa;">
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.appendChild(exerciseElement);
}

/************************************************
* Disable semua field & tombol setelah selesai *
*************************************************/
function disableButtonsAfterCompletion(hariKe, submenuType) {
  // Disabled Workout
  if (submenuType === 'workout') {
    console.log(`üîí Disable workout UI hari ${hariKe}`);
    disableWorkoutUI(hariKe);
    return;
  }

  // Disabled Water Reminder
  if (submenuType === 'water') {
    console.log(`üîí Lock WATER hari ${hariKe} (READ ONLY)`);

    const container = document.getElementById(`waterReminderContent${hariKe}`);
    if (!container) return;

    // Disabled semua inputan
    container.querySelectorAll('input, select, textarea').forEach(el => {
      el.disabled = true;
      el.readOnly = true;
      el.style.backgroundColor = '#f8f9fa';
      el.style.cursor = 'not-allowed';
    });

    // Disabled semua button kecuali "X" & "Cek Disini"
    container.querySelectorAll('button').forEach(btn => {
      const id   = btn.id || '';
      const text = btn.textContent || '';
      const cls  = btn.className || '';

      // Close "X" Tetap aktif
      if (
        cls.includes('btn-close') ||
        cls.includes('close-pdf') ||
        cls.includes('close-video') ||
        btn.innerHTML.includes('fa-times')
      ) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        return;
      }

      // "Cek Disini" Tetat Aktif
      if (id.includes('CekDisini') || text.includes('Cek Disini')) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.title = 'Lihat PDF';
        return;
      }

      // Lainnya DISABLE
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.title = 'Water sudah diisi';
    });

    console.log(`‚úÖ Water hari ${hariKe} terkunci total`);
    return;
  }
}

/************************************************
/* UPDATE SUBMENU LINK UI - CENTANG HIJAU BULAT *
/************************************************/
function updateSubmenuLinkUI(type, hariKe) {
    console.log(`üîÑ Update submenu UI: ${type} hari ${hariKe}`);

    let link = null;

    // Perkenalan Selektor
    if (type === 'perkenalan') {
        const container = document.getElementById('perkenalanContent');
        if (!container) return;
        link = [...container.querySelectorAll('a.menu-item')]
            .find(a => a.textContent.includes('Selesai Perkenalan'));
    }

    // Materi Selektor
    if (type === 'materi') {
        const container = document.getElementById(`pertemuan${hariKe}Content`);
        if (!container) return;
        link = container.querySelector(
            `a.menu-item.video-link[data-section="pertemuan${hariKe}"]`
        );
    }

    // Meal Plan Selektor
    if (type === 'mealplan') {
        link = document.querySelector(
            `a.menu-item.submenu-trigger[data-target="mealPlanContent${hariKe}"]`
        );
    }
    
    // Workout Selektor
    if (type === 'workout') {
        link = document.querySelector(
            `a.menu-item.submenu-trigger[data-target="workoutContent${hariKe}"]`
        );
    }

    // Water Selektor
    if (type === 'water') {
        link = document.querySelector(
           `a.menu-item.submenu-trigger[data-target="waterReminderContent${hariKe}"]`
      );
    }

    if (!link) {
        console.warn('‚ùå Submenu tidak ditemukan untuk:', type, hariKe);
        return;
    }

    // ‚ùå Cegah dobel centang
    if (link.querySelector('.status-done')) return;

    const icon = document.createElement('i');
    icon.className = 'fas fa-check-circle status-done';
    icon.style.color = '#198754';   // hijau bootstrap
    icon.style.marginLeft = '2px';  //'8px';
    icon.style.fontSize = '0.9em';

    link.appendChild(icon);
    // link.style.fontWeight = 'bold';
    link.style.color = '#666';
}

/***************************
/* SHOW SUBMENU READ-ONLY  *
/**************************/
function showSubmenuReadOnly(targetId) {
    console.log(`üëÅÔ∏è Showing submenu ${targetId} in READ-ONLY mode`);
    
    // Ekstrak hariKe dari targetId (misal: "workoutContent1" ‚Üí 1)
    const hariKe = targetId.replace(/\D/g, '') || 1;
    const submenuType = targetId.replace(/Content\d+/, ''); // "workout"
    
    console.log(`üìÖ Detected: day ${hariKe}, type: ${submenuType}`);
    
    const targetContent = document.getElementById(targetId);
    if (!targetContent) {
        console.error(`‚ùå Target content not found: ${targetId}`);
        return;
    }
    
    // Tampilkan submenu
    showSubmenu(targetId);
    
    // Untuk Workout: Pastikan form dibuat dulu
    if (submenuType === 'workout') {
        console.log(`üî® Ensuring workout form is created for day ${hariKe}`);
        
        // Pastikan form dasar sudah ada
        const formContainer = document.getElementById(`olahragaKardio-list${hariKe > 1 ? hariKe : ''}`);
        if (!formContainer || formContainer.innerHTML.trim() === '') {
            console.log(`‚öôÔ∏è Creating basic workout form for day ${hariKe}`);
            // Jika belum ada, buat form dasar
            if (typeof createWorkoutFormHTML === 'function') {
                formContainer.innerHTML = createWorkoutFormHTML(hariKe);
            }
        }
        
        // Pastikan Resistance Section dibuat
        const resistanceSection = document.getElementById(`resistance-section${hariKe}`);
        if (resistanceSection) {
            console.log(`‚úÖ Resistance section found, setting up...`);
            // Panggil setupResistanceExercises untuk MEMBUAT form
            if (typeof setupResistanceExercises === 'function') {
                setupResistanceExercises(hariKe);
            }
        }
        
        // Setup event listeners
        if (typeof setupWorkoutForDay === 'function') {
            setupWorkoutForDay(hariKe);
        }
        
        // Load saved data jika ada
        if (typeof loadSavedWorkoutData === 'function') {
            setTimeout(() => {
                loadSavedWorkoutData(hariKe);
            }, 300);
        }
    }
    
    // Terapkan mode read-only SETELAH form dibuat
    setTimeout(() => {
        console.log(`üîí Applying read-only mode to ${targetId}`);
        applyReadOnlyModeToSubmenu(targetContent);
    }, 800); // Delay lebih lama untuk memastikan form sudah dibuat
    
    console.log(`‚úÖ Read-only mode initiated for ${targetId}`);
}

/**********************************
/* APPLY READ-ONLY MODE TO SUBMENU
***********************************/
function applyReadOnlyModeToSubmenu(container) {
    if (!container) return;
    
    // 1. Disable semua tombol aksi kecuali "Cek Disini" dan "Close"
    container.querySelectorAll('button').forEach(button => {
        const buttonId = button.id || '';
        const buttonText = button.textContent || '';
        const buttonClass = button.className || '';
        
        // TOMBOL "CLOSE/X" TETAP ENABLED
        if (buttonClass.includes('btn-close') || 
            buttonClass.includes('close-pdf') || 
            buttonClass.includes('close-video') ||
            button.textContent.includes('√ó') ||
            button.innerHTML.includes('fa-times')) {
            // Biarkan tombol close tetap enabled
            button.disabled = false;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            return;
        }
        
        // TOMBOL "CEK DISINI" TETAP ENABLED
        if (buttonId.includes('CekDisini') || 
            buttonText.includes('Cek Disini')) {
            button.disabled = false;
            if (button.classList.contains('btn-secondary')) {
                button.classList.remove('btn-secondary');
            }
            if (!button.classList.contains('btn-primary')) {
                button.classList.add('btn-primary');
            }
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            button.title = 'Lihat PDF';
            return;
        }
        
        // SEMUA TOMBOL LAIN: DISABLE
        button.disabled = true;
        if (button.classList.contains('btn-primary') || 
            button.classList.contains('btn-success') ||
            button.classList.contains('btn-outline-secondary')) {
            button.classList.remove('btn-primary', 'btn-success', 'btn-outline-secondary');
            button.classList.add('btn-secondary');
        }
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
        button.title = 'Sudah selesai';
    });
    
    // Disable input fields kecuali untuk melihat PDF/video
    container.querySelectorAll('input, select, textarea').forEach(input => {
        const inputId = input.id || '';
        
        if (!inputId.includes('CekDisini') && 
            !inputId.includes('pdfViewer') &&
            !inputId.includes('videoContainer')) {
            
            input.disabled = true;
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
            input.style.cursor = 'not-allowed';
        }
    });
    console.log(`‚úÖ Read-only mode applied to ${container.id}`);
}

/***************************************
/* UPDATE SETUP ALL COMPONENTS - FINAL *
/***************************************/
function setupAllComponents() {
  console.log('üîß Setting up all components...');
  // DATA LOGIN
  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName'); // üîë sudah fix

  // ACCORDION TOGGLE FIX
  setupAccordionToggle();

  // CEK USER LOGIN
  if (userId) {
    console.log('üë§ User is logged in:', userId);

    // UPDATE NAVBAR (ICON USER + LOGOUT)
    updateNavbarForLoggedInUser();

    // SAPAAN PERSONAL USER BERDASARKAN WAKTU AKSES
    const namaTampil = userName && userName.trim() !== '' ? userName : userId;
    const hour       = new Date().getHours();

    let salam = 'SELAMAT MALAM';
    if (hour >= 4 && hour < 11) salam = 'SELAMAT PAGI';
    else if (hour >= 11 && hour < 15) salam = 'SELAMAT SIANG';
    else if (hour >= 15 && hour < 18) salam = 'SELAMAT SORE';

    const elGreetingName = document.getElementById('greetingName');
    const elGreetingTime = document.getElementById('greetingTime');
    const elGreetingNameInline = document.getElementById('greetingNameInline');

    if (elGreetingName) {
      elGreetingName.innerText = `Kak ${namaTampil}`;
    }
    if (elGreetingTime) {
      elGreetingTime.innerText = salam;
    }
    if (elGreetingNameInline) {
      elGreetingNameInline.innerText = namaTampil;
    }

    // LOAD COMPLETE PROGRESS DARI SERVER
    loadCompleteProgressFromServer(userId, 1)
      .then(progress => {
        console.log('‚úÖ Complete progress loaded successfully');
      })
      .catch(error => {
        console.error('‚ùå Error loading complete progress:', error);
        // fallback jika server gagal
        checkProgressFallback(userId);
      });

  } else {
    console.log('‚ö†Ô∏è No user logged in or session expired');
    // üîí USER BELUM LOGIN ‚Üí LOCK SEMUA MODUL
    applyLockForNewUser();
  }

  // SETUP SEMUA KOMPONEN LAINNYA (TETAP JALAN)
  setupAllComponentsInternal();
  console.log('‚úÖ All components setup complete');
}

/***************************
/* CHECK PROGRESS FALLBACK *
/***************************/
function checkProgressFallback(userId) {
  console.log('üîÑ Using fallback progress check for user:', userId);
  
  // Cek dari localStorage
  const progressKey = `completeProgress_${userId}`;
  const savedProgress = JSON.parse(localStorage.getItem(progressKey) || '{}');
  
  if (savedProgress.success) {
    applyCompleteProgressToUI(savedProgress, 1);
  } else {
    // Coba ambil dari fungsi lama
    fetchProgressFromServer(userId);
  }
}

/*************************************************
* Ambil progress dari server untuk user tertentu *
**************************************************/
function fetchProgressFromServer(userId) {
    const callbackName = 'cb_fetch_progress_' + Date.now();
    const script = document.createElement('script');
    
    script.src = `${URL_PROGRAM_APP}?action=getLastProgress&userId=${encodeURIComponent(userId)}&callback=${callbackName}`;
    
    window[callbackName] = function(response) {
        console.log('üì° Progress dari server untuk user', userId, ':', response);
        if (response.success) {

            // simpan global
            window.userProgress = response;

            // simpan storage (biarkan)
            localStorage.setItem(`progressData_${userId}`, JSON.stringify(response));
            localStorage.setItem('progressData', JSON.stringify(response));

            // TENTUKAN USER BARU / LAMA
            const isUserBaru = response.perkenalan !== true;

            if (isUserBaru) {
                // üîí HANYA USER BARU ‚Üí apply lock
                applyLockSystem(response);
            }

            // SEMUA USER ‚Üí restore progress
            applyExistingUserProgress(response);
        }
        document.body.removeChild(script);
        delete window[callbackName];
    };
    
    script.onerror = () => {
        console.warn('‚ö†Ô∏è Gagal ambil progress dari server untuk user', userId);
        document.body.removeChild(script);
        delete window[callbackName];
    };
    
    document.body.appendChild(script);
}

/************************************
* Terapkan progress ke UI - SIMPLE  *
*************************************/
function applyProgressToUI(progress) {
  console.log('üéØ Menerapkan progress ke UI');
  
  // 1. PERKENALAN
  if (progress.perkenalan) {
    console.log('‚úÖ Perkenalan sudah selesai');
    
    // Update link "Selesai Perkenalan"
    const perkenalanLinks = document.querySelectorAll('#perkenalanContent .menu-item');
    perkenalanLinks.forEach(link => {
      if (link.textContent.includes('Selesai Perkenalan')) {
        link.innerHTML = '<i class="fas fa-check-double"></i>Selesai Perkenalan';
        link.style.color = '#666666';
        // link.style.fontWeight = 'bold';
        link.style.pointerEvents = 'none';
      }
    });
    
    // Unlock Modul Hari 1
    unlockModul(1);
  }
  
  // 2. MATERI HARI 1
  if (progress.materiHari1) {
    console.log('‚úÖ Materi Hari 1 sudah selesai');
    
    // Update link materi
    const materiLink = document.getElementById('materiLink1');
    if (materiLink) {
      materiLink.innerHTML = materiLink.innerHTML + ' ‚úì';
      materiLink.style.color = '#666666';
      // materiLink.style.fontWeight = 'bold';
    }
    
    // Update tombol centang di video
    const completeBtn = document.querySelector('#videoContainerPertemuan1 .complete-btn');
    if (completeBtn) {
      completeBtn.innerHTML = '<i class="fas fa-check-double"></i>';
      completeBtn.classList.remove('btn-success');
      completeBtn.classList.add('btn-secondary');
      completeBtn.disabled = true;
    }
  }
  
  // 3. MEAL PLAN HARI 1
  if (progress.mealplanHari1) {
    console.log('‚úÖ Meal Plan Hari 1 sudah selesai');
    
    // Update link meal plan
    const mealPlanLinks = document.querySelectorAll('[onclick="uploadMealPlan(1)"]');
    mealPlanLinks.forEach(link => {
      link.innerHTML = `<i class="fas fa-utensils"></i>${hariKe}.2 Meal Plan - Hari ${getDayName(hariKe)} <i class="fas fa-check-circle text-success ms-1" style="font-size:0.9em"></i>`;
      link.style.color = '#666666';
      link.style.marginLeft = '2px';
      // link.style.fontWeight = 'bold';

    });
    
    // Update tombol selesai meal plan
    const selesaiBtn = document.getElementById('btnSelesaiMealPlan1');
    if (selesaiBtn) {
      selesaiBtn.innerHTML = '<i class="fas fa-check"></i> Selesai Meal Plan';
      selesaiBtn.classList.remove('btn-secondary');
      selesaiBtn.classList.add('btn-success');
      selesaiBtn.disabled = true;
    }
  }
  
  console.log('‚úÖ Progress berhasil diterapkan');
}

/**********************************
* Cek status materi dan update UI *
***********************************/
function checkMateriStatus(hariKe) {
    const status = localStorage.getItem(`materi_hari_${hariKe}`);
    if (status === 'completed') {
        updateMateriCompletionUI(hariKe);
    }
}

/****************************************
* Update UI materi dengan tanda centang *
*****************************************/
function updateMateriCompletionUI(hariKe) {
  console.log(`üîÑ Updating Materi Completion UI for day ${hariKe}`);
  //  1Ô∏è‚É£ Disable HANYA tombol centang (‚úì) video materi

  // Container materi hari ke-n
  const container = document.getElementById(`materiContent${hariKe}`);
  if (!container) return;

  // Cari tombol / link centang (biasanya tombol selesai video)
  const actionButtons = container.querySelectorAll('button, a');
  actionButtons.forEach(btn => {
    // Hanya disable tombol aksi, bukan link video
    if (
      btn.textContent.includes('‚úì') ||
      btn.classList.contains('btn-check') ||
      btn.classList.contains('btn-selesai')
    ) {
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.5';
      btn.classList.add('disabled');
    }
  });
  //   2Ô∏è‚É£ Update submenu ‚Üí icon centang BULAT hijau
  updateSubmenuLinkUI(hariKe, 'materi');
  console.log(`‚úÖ Materi Hari ${hariKe} UI updated successfully`);
}

/********************************************
* Setup Tombol Cek Disini - untuk semua hari
********************************************/
function setupCekDisiniButtons() {
    console.log('üîß Setting up Cek Disini buttons for all days...');
    
    // Setup event listeners untuk semua tombol Cek Disini yang ada
    document.querySelectorAll('[id^="btnCekDisini"]').forEach(button => {
        // Hapus event listener lama jika ada
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Mencegah event bubbling ke parent
            
            // Deteksi jenis dan hari dari ID button
            const buttonId = this.id;
            let jenis, hariKe;
            
            // Extract informasi dari ID button
            if (buttonId.includes('MealPlan')) {
                jenis = 'MealPlan';
                hariKe = buttonId.replace('btnCekDisiniMealPlan', '') || '1';
            } else if (buttonId.includes('Workout')) {
                jenis = 'WorkOut';
                hariKe = buttonId.replace('btnCekDisiniWorkout', '') || '1';
            } else if (buttonId.includes('AirMinum')) {
                jenis = 'WaterReminder';
                hariKe = buttonId.replace('btnCekDisiniAirMinum', '') || '1';
            } else if (buttonId.includes('Istirihat')) {
                jenis = 'Istirahat';
                hariKe = buttonId.replace('btnCekDisiniIstirihat', '') || '1';
            } else if (buttonId.includes('DataTubuh')) {
                jenis = 'DataTracking';
                hariKe = buttonId.replace('btnCekDisiniDataTubuh', '') || '1';
            }
            
            if (jenis && hariKe) {
                console.log(`üìÑ Handling Cek Disini: ${jenis} for day ${hariKe}`);
                handleCekDisiniClick(jenis, hariKe);
            }
        });
    });
    
    console.log('‚úÖ Cek Disini buttons setup completed for all days');
}

/**********************************************************
* Handle klik tombol Cek Disini untuk semua jenis dan hari
***********************************************************/
function handleCekDisiniClick(jenis, hariKe) {
    console.log(`üìã ${jenis} button clicked for day ${hariKe}`);
    
    // Mapping jenis ke section dan nama file
    const config = {
        'MealPlan': {
            section: 'mealplan',
            fileName: `MealPlan_HariKe${hariKe}.pdf`,
            title: `Meal Plan Hari ${getDayName(hariKe)}`
        },
        'WorkOut': {
            section: 'workout', 
            fileName: `WorkOut_HariKe${hariKe}.pdf`,
            title: `Workout Hari ${getDayName(hariKe)}`
        },
        'WaterReminder': {
            section: 'water',
            fileName: `WaterReminder_HariKe${hariKe}.pdf`,
            title: `Water Reminder Hari ${getDayName(hariKe)}`
        },
        'Istirahat': {
            section: 'istirahat',
            fileName: `Istirahat_HariKe${hariKe}.pdf`,
            title: `Waktu Istirahat Hari ${getDayName(hariKe)}`
        },
        'DataTracking': {
            section: 'datatracking',
            fileName: `DataTracking_HariKe${hariKe}.pdf`,
            title: `Data Tracking Hari ${getDayName(hariKe)}`
        }
    };
    
    const itemConfig = config[jenis];
    if (itemConfig) {
        const pdfUrl = `https://amihaji.github.io/beratideal/pdf/${itemConfig.fileName}`;
        const sectionId = `${itemConfig.section}${hariKe}`;
        
        // TUTUP SEMUA KONTEN LAIN KECUALI SUBMENU YANG SEDANG AKTIF
        const currentSubmenu = document.querySelector(`#${jenis}Content${hariKe}`);
        
        // Hanya sembunyikan konten yang tidak relevan
        document.querySelectorAll('.video-container').forEach(video => {
            video.style.display = 'none';
        });
        
        document.querySelectorAll('.playlist-container').forEach(playlist => {
            playlist.style.display = 'none';
        });
        
        // Tampilkan PDF viewer
        loadPDF(sectionId, pdfUrl, itemConfig.title);
        
        // Tampilkan submenu jika belum terbuka
        if (currentSubmenu && currentSubmenu.style.display === 'none') {
            currentSubmenu.style.display = 'block';
        }
    }
}


// ********************************
// ***** FUNGSI VIDEO PLAYER ******
// ********************************
let currentVideoData = {};

/************************************
* Fungsi Initialisasi Seluruh video *
*************************************/ 
function initializeAllVideoPlayers() {
  console.log('Initializing video players...');

  // Setup video placeholder click events
  document.querySelectorAll('.video-placeholder').forEach(placeholder => {
    const section = placeholder.closest('.video-container').id.replace('videoContainer', '');
    placeholder.addEventListener('click', function() {
      playVideo(section);
    });
  });
  
  // Close video dengan ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentVideoData.section) {
      closeVideo(currentVideoData.section);
    }
  });
}

/*********************************
* Setup Semua Link Video dan PDF *
**********************************/
function setupAllLinks() {
  // Setup video links
  document.querySelectorAll('.video-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      const section = this.getAttribute('data-section');
      const videoType = this.getAttribute('data-type');
      const videoUrl = this.getAttribute('data-url');
      const title = this.textContent.trim();
      
      // Sembunyikan semua konten lain
      document.querySelectorAll('.submenu-content').forEach(content => {
        content.style.display = 'none';
      });
      document.querySelectorAll('.video-container').forEach(video => {
        video.style.display = 'none';
      });
      document.querySelectorAll('.pdf-viewer').forEach(pdf => {
        pdf.style.display = 'none';
      });
      
      // Load video
      loadVideo(section, videoType, videoUrl, title);
      
      // Tampilkan video player di posisi yang tepat
      const videoContainer = document.getElementById(`videoContainer${capitalizeFirst(section)}`);
      if (videoContainer) {
        videoContainer.style.display = 'block';
        
        // Sisipkan video container setelah link video yang diklik
        this.parentNode.insertBefore(videoContainer, this.nextSibling);
        
        // Auto play video
        setTimeout(() => {
          playVideo(section);
        }, 500);
      }
    });
  });
  
  // Setup PDF links
  setupPDFLinks();
}

/******************************************
* Fungsi Memuat Video Berdasarkan Section *
*******************************************/ 
function loadVideo(section, videoType, videoUrl, title = '') {
    console.log('üé¨ loadVideo called:', { section, videoType, videoUrl, title });
   
    // Untuk Canva, buka di tab baru
    if (videoType === 'canva') {
        window.open(videoUrl, '_blank');
        return;
    }
    
    const videoContainer = document.getElementById(`videoContainer${capitalizeFirst(section)}`);
    if (!videoContainer) {
        console.error('‚ùå Video container not found for section:', section);
        return;
    }
    
    const videoPlaceholder = videoContainer.querySelector('.video-placeholder');
    const videoLoading = document.getElementById(`videoLoading${capitalizeFirst(section)}`);
    const videoPlayer = document.getElementById(`videoPlayer${capitalizeFirst(section)}`);
    
    // Validasi URL YouTube
    if (videoType === 'youtube' && !validateYouTubeUrl(videoUrl)) {
        console.error('‚ùå Invalid YouTube URL:', videoUrl);
        showMessage('error', 'URL Youtube tidak valid');
        return;
    }
    // Close video di section lain
    closeAllVideos();
    
    // Reset previous video 
    if (videoPlayer) videoPlayer.innerHTML = '';
    currentVideoData = {
        section: section,
        type: videoType,
        url: videoUrl,
        title: title
    };
    
    // Show video container
    videoContainer.style.display = 'block';
    
    // Update placeholder text
    let placeholderText = 'Klik untuk memuat video';
    if (videoType === 'youtube') {
        const youtubeId = extractYouTubeId(videoUrl);
        placeholderText = youtubeId ? 'Klik untuk memuat video dari YouTube' : 'URL YouTube tidak valid';
    } else if (videoType === 'local') {
        placeholderText = 'Klik untuk memuat video';
    }
    
    if (videoPlaceholder) {
        videoPlaceholder.querySelector('.video-placeholder-text').textContent = placeholderText;
        videoPlaceholder.style.display = 'flex';
    }
    if (videoLoading) videoLoading.style.display = 'none';
    
    // Auto play setelah ditampilkan
    setTimeout(() => {
        playVideo(section);
    }, 500);
}

/**********************************
* Memutar Video yang sudah dimuat *
***********************************/
function playVideo(section) {
    console.log('playVideo called for section:', section);
    
    const videoContainer   = document.getElementById(`videoContainer${capitalizeFirst(section)}`);
    const videoPlaceholder = videoContainer?.querySelector('.video-placeholder');
    const videoLoading     = document.getElementById(`videoLoading${capitalizeFirst(section)}`);
    const videoPlayer      = document.getElementById(`videoPlayer${capitalizeFirst(section)}`);
    
    if (!videoContainer || !videoPlayer) {
        console.error('Video elements not found for section:', section);
        return;
    }
    
    // Hide placeholder, show loading
    if (videoPlaceholder) videoPlaceholder.style.display = 'none';
    if (videoLoading) videoLoading.style.display = 'flex';
    
    // Load video based on type
    setTimeout(() => {
        if (videoLoading) videoLoading.style.display = 'none';
        
        if (currentVideoData.type === 'youtube') {
            console.log('Loading YouTube video:', currentVideoData.url);
            loadYouTubeVideo(videoPlayer, currentVideoData.url);
        } else if (currentVideoData.type === 'local') {
            console.log('Loading local video:', currentVideoData.url);
            loadLocalVideo(videoPlayer, currentVideoData.url);
        }
    }, 1000);
}

/***********************
* Memuat Video Youtube *
************************/
function loadYouTubeVideo(videoPlayer, url) {
    const videoId = extractYouTubeId(url);
    console.log('YouTube ID extracted:', videoId);
    
    if (videoId) {
        videoPlayer.innerHTML = `
            <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
            </iframe>
        `;
        console.log('YouTube iframe created');
    } else {
        console.error('Could not extract YouTube ID from URL:', url);
        // Fallback: buka di tab baru
        window.open(url, '_blank');
        if (currentVideoData.section) {
            closeVideo(currentVideoData.section);
        }
    }
}

/*********************
* Memuat Video Local *
**********************/
function loadLocalVideo(videoPlayer, url) {
    console.log('Creating local video element for:', url);
    videoPlayer.innerHTML = `
        <video controls autoplay style="width:100%; height:100%">
            <source src="${url}" type="video/mp4">
            Browser Anda tidak mendukung pemutaran video.
        </video>
    `;
    
    // Handle error loading local video
    const videoElement = videoPlayer.querySelector('video');
    if (videoElement) {
        videoElement.onerror = function() {
            console.error('Error loading local video:', url);
            showMessage('error', 'Video tidak dapat dimuat');
            if (currentVideoData.section) {
                closeVideo(currentVideoData.section);
            }
        };
    }
}

/******************************
* Ekstrak ID dari URL YouTube *
*******************************/
function extractYouTubeId(url) {
    console.log('üîç Extracting YouTube ID from:', url);
    
    if (!url) {
        console.log('‚ùå URL is empty');
        return null;
    }
    
    // Support semua format URL YouTube
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/,
        /youtube\.com\/watch\?.*v=([^&?#]+)/,
        /youtu\.be\/([^&?#]+)/,
        /youtube\.com\/v\/([^&?#]+)/,
        /youtube\.com\/watch\?.*vi?=([^&?#]+)/,
        /youtube\.com\/user\/.*\/[^#]+\?.*v=([^&?#]+)/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
            const videoId = match[1];
            console.log('‚úÖ YouTube ID found:', videoId);
            return videoId;
        }
    }
    
    // Fallback: coba ekstrak dengan metode split
    try {
        if (url.includes('youtube.com/watch?v=')) {
            const videoId = url.split('v=')[1]?.split('&')[0];
            if (videoId && videoId.length === 11) {
                console.log('‚úÖ YouTube ID found (fallback):', videoId);
                return videoId;
            }
        } else if (url.includes('youtu.be/')) {
            const videoId = url.split('youtu.be/')[1]?.split('?')[0];
            if (videoId && videoId.length === 11) {
                console.log('‚úÖ YouTube ID found (fallback):', videoId);
                return videoId;
            }
        }
    } catch (error) {
        console.error('Error in fallback extraction:', error);
    }
    
    console.log('‚ùå No YouTube ID found in URL:', url);
    return null;
}

/**********************************
* Tutup Video di Section Tertentu *
***********************************/
function closeVideo(section) {
    console.log('Closing video for section:', section);
    
    const videoContainer = document.getElementById(`videoContainer${capitalizeFirst(section)}`);
    if (!videoContainer) return;
    
    const videoPlayer = document.getElementById(`videoPlayer${capitalizeFirst(section)}`);
    const videoPlaceholder = videoContainer.querySelector('.video-placeholder');
    const videoLoading = document.getElementById(`videoLoading${capitalizeFirst(section)}`);
    
    // Stop video playback
    const iframe = videoPlayer.querySelector('iframe');
    const localVideo = videoPlayer.querySelector('video');
    
    if (iframe) iframe.src = '';
    if (localVideo) {
        localVideo.pause();
        localVideo.currentTime = 0;
    }
    
    videoPlayer.innerHTML = '';
    videoContainer.style.display = 'none';
    if (videoPlaceholder) videoPlaceholder.style.display = 'flex';
    if (videoLoading) videoLoading.style.display = 'none';
    
    currentVideoData = {};
}

/************************************************************
* Tutup Semua Video yang sedang diputar - Tidak Menutup PDF *
*************************************************************/
function closeAllVideos() {
    console.log('Closing all videos and playlists (not PDFs)');
    
    // Tutup semua video
    const videoContainers = document.querySelectorAll('.video-container');
    videoContainers.forEach(container => {
        const section = container.id.replace('videoContainer', '');
        if (section) {
            closeVideo(section);
        }
    });
    
    // Tutup semua playlist
    document.querySelectorAll('.playlist-container').forEach(playlist => {
        playlist.style.display = 'none';
    });
    
    // HANYA tutup submenu yang tidak sedang menampilkan PDF
    document.querySelectorAll('.submenu-content').forEach(content => {
        // Cek apakah di dalam submenu ini ada PDF yang sedang ditampilkan
        const pdfViewersInside = content.querySelectorAll('.pdf-viewer');
        let hasVisiblePDF = false;
        
        pdfViewersInside.forEach(pdf => {
            if (pdf.style.display === 'block') {
                hasVisiblePDF = true;
            }
        });
        
        // Jika tidak ada PDF yang terlihat di submenu ini, sembunyikan
        if (!hasVisiblePDF) {
            content.style.display = 'none';
        }
    });
}

/***********************
* Validasi URL YouTube *
************************/
function validateYouTubeUrl(url) {
    console.log('üîç Validating YouTube URL:', url);
    
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
    const isValid = youtubeRegex.test(url);
    
    console.log('‚úÖ YouTube URL validation:', isValid);
    return isValid;
}

// ****************************
// ***** FUNGSI PLAYLIST ******
/******************************
 
/************************************
* Memuat data playlist dari File JSon
*************************************/
async function loadPlaylistData() {
    try {
        console.log('üì• Loading playlist data from JSON...');
        const response = await fetch(PLAYLIST_JSON_URL);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ Loaded ${data.length} videos from JSON`);
        return data;
        
    } catch (error) {
        console.error('‚ùå Error loading playlist data:', error);
        // Fallback ke proven videos
        return getProvenVideos();
    }
}

/*********************************
* Fallback Video Jika JSon Error *
**********************************/
function getProvenVideos() {
    return [
        {
            id: '1',
            videoId: '9DoHhx9jlGM',
            title: 'Alasan Mengapa Herbalife',
            thumbnail: 'https://i.ytimg.com/vi/9DoHhx9jlGM/mqdefault.jpg',
            duration: '15:30',
            position: 1
        },
        {
            id: '2', 
            videoId: 'Zg_badTE2Ec',
            title: 'Dari Mana Saja Sumber Protein Bisa Didapatkan?',
            thumbnail: 'https://i.ytimg.com/vi/Zg_badTE2Ec/mqdefault.jpg',
            duration: '12:45',
            position: 2
        }
    ];
}

/*************************
* Setup Trigger Playlist *
**************************/
function setupPlaylistTriggers() {
  document.querySelectorAll('.playlist-trigger').forEach(trigger => {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      const target = this.getAttribute('data-target');
      const playlistUrl = this.getAttribute('href');
      showPlaylistInSection(target, playlistUrl, this);
    });
  });
}

/********************************
* Tampilkan Playlist di Section *
*********************************/
async function showPlaylistInSection(targetId, playlistUrl, triggerElement) {
  const playlistContainer = document.getElementById(targetId);
  if (!playlistContainer) {
    console.error('Playlist container not found:', targetId);
    return;
  }
  
  // Sembunyikan semua konten lain
  document.querySelectorAll('.submenu-content').forEach(content => {
    content.style.display = 'none';
  });
  document.querySelectorAll('.video-container').forEach(video => {
    video.style.display = 'none';
  });
  document.querySelectorAll('.pdf-viewer').forEach(pdf => {
    pdf.style.display = 'none';
  });
  document.querySelectorAll('.playlist-container').forEach(playlist => {
    playlist.style.display = 'none';
  });
  
  // Tampilkan loading
  playlistContainer.innerHTML = `
    <div class="playlist-loading">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div class="mt-2">Memuat daftar video...</div>
    </div>
  `;
  playlistContainer.style.display = 'block';
  
  // Tempatkan playlist container setelah trigger element
  if (triggerElement && triggerElement.parentNode) {
    triggerElement.parentNode.insertBefore(playlistContainer, triggerElement.nextSibling);
  }
  
  try {
    const playlistItems = await loadPlaylistData();
    if (!playlistItems || playlistItems.length === 0) {
      throw new Error('Tidak ada data video');
    }
    renderPlaylist(playlistContainer, playlistItems, 'healthyRecept');
  } catch (error) {
    console.error('Error showing playlist:', error);
    // Fallback ke proven videos
    const provenVideos = getProvenVideos();
    renderPlaylist(playlistContainer, provenVideos, 'healthyRecept');
  }
}

/********************************************
* Render Playlist items dengan tombol close *
*********************************************/
function renderPlaylist(container, items, section) {
  container.innerHTML = '';
  
  // Header dengan tombol close
  const header = document.createElement('div');
  header.className = 'playlist-header position-relative';
  header.style.padding = '12px 15px';
  header.style.borderBottom = '1px solid #dee2e6';
  header.style.background = '#f8f9fa';
  header.style.fontWeight = '600';
  header.innerHTML = `
    <div>
      <i class="fas fa-list-ul me-2"></i>Playlist Healthy Snacking
      <div style="font-size: 12px; color: #666; font-weight: normal; margin-top: 2px;">
        ${items.length} video tersedia
      </div>
    </div>
    <button type="button" class="btn-close-header position-absolute top-50 end-0 translate-middle-y me-2" 
            onclick="hidePlaylist('${container.id}')">
      <i class="fas fa-times"></i>
    </button>
  `;
  container.appendChild(header);
  
  // Render playlist items
  items.forEach((item, index) => {
    const playlistItem = document.createElement('div');
    playlistItem.className = 'playlist-item';
    playlistItem.style.cursor = 'pointer';
    playlistItem.innerHTML = `
      <div class="playlist-thumbnail">
        <img src="${item.thumbnail}" alt="${item.title}" 
             loading="lazy"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjY4IiB2aWV3Qm94PSIwIDAgMTIwIDY4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iNjgiIGZpbGw9IiNlZGVkZWQiLz48dGV4dCB4PSI2MCIgeT0iMzQiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VGh1bWJuYWlsPC90ZXh0Pjwvc3ZnPg=='">
        <div class="position-badge">${index + 1}</div>
      </div>
      <div class="playlist-info">
        <div class="playlist-title">${item.title}</div>
        <div class="playlist-meta">
          ${item.duration ? `<span class="playlist-duration"><i class="fas fa-clock me-1"></i>${item.duration}</span>` : ''}
          <span class="playlist-position">Video ${index + 1}</span>
        </div>
      </div>
    `;
    
    playlistItem.onclick = function() {
      playVideoFromPlaylist(section, item.videoId, item.title);
    };
    
    container.appendChild(playlistItem);
  });
  
  // Footer
  const footer = document.createElement('div');
  footer.className = 'playlist-footer';
  footer.style.padding = '10px 15px';
  footer.style.borderTop = '1px solid #dee2e6';
  footer.style.fontSize = '12px';
  footer.style.color = '#666';
  footer.style.textAlign = 'center';
  footer.style.background = '#f8f9fa';
  footer.innerHTML = `
    <div><i class="fas fa-database me-1"></i>Data update ‚Ä¢ ${new Date().toLocaleDateString('id-ID')}</div>
  `;
  container.appendChild(footer);
}

/***********************
* Fungsi Hide Playlist *
************************/
function hidePlaylist(playlistId) {
  const playlistContainer = document.getElementById(playlistId);
  
  if (playlistContainer) {
    playlistContainer.style.display = 'none';
  }
  
  // Kembalikan ke posisi semula jika perlu
  const healthyReceptContent = document.getElementById('healthyRecept');
  if (healthyReceptContent && playlistId === 'playlistHealthyRecept') {
    const menuContent = healthyReceptContent.querySelector('.menu-content');
    if (menuContent) {
      menuContent.appendChild(playlistContainer);
    }
  }
}

/****************************
* Putar Video dari Playlist *
*****************************/
function playVideoFromPlaylist(section, videoId, title) {
    console.log('üé¨ Playing video from playlist:', { section, videoId, title });
    
    const videoContainer = document.getElementById(`videoContainer${capitalizeFirst(section)}`);
    if (!videoContainer) {
        console.error('Video container not found for section:', section);
        return;
    }
    
    // Sembunyikan playlist
    const playlistContainer = document.getElementById(`playlist${capitalizeFirst(section)}`);
    if (playlistContainer) {
        playlistContainer.style.display = 'none';
    }
    // Show video container
    videoContainer.style.display = 'block';
    // Set current video data
    currentVideoData = {
        section: section,
        type: 'youtube',
        url: `https://www.youtube.com/watch?v=${videoId}`,
        title: title
    };
    
    // Auto play video setelah delay
    setTimeout(() => { playVideo(section);}, 500);
    
    // Scroll ke video player
    setTimeout(() => { videoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 600);
}

// *****************************
// ***** FUNGSI PDF VIEWER *****
// *****************************
let currentPDFData = {};

/************************
* Fungsi Setup PDF Link *
*************************/
function setupPDFLinks() {
  document.querySelectorAll('.pdf-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      const section = this.getAttribute('data-section');
      const pdfUrl = this.getAttribute('data-url');
      const title = this.textContent.trim();
      
      // Sembunyikan semua video container
      document.querySelectorAll('.video-container').forEach(video => {
        video.style.display = 'none';
      });
      
      // Sembunyikan semua submenu content
      document.querySelectorAll('.submenu-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Sembunyikan semua PDF viewer terlebih dahulu
      document.querySelectorAll('.pdf-viewer').forEach(pdf => {
        pdf.style.display = 'none';
      });
      
      // Load PDF
      loadPDF(section, pdfUrl, title);
      
      // Tampilkan PDF viewer di posisi yang tepat
      const pdfViewer = document.getElementById(`pdfViewer${capitalizeFirst(section)}`);
      if (pdfViewer) {
        pdfViewer.style.display = 'block';
        
        // Sisipkan PDF viewer setelah link PDF yang diklik
        this.parentNode.insertBefore(pdfViewer, this.nextSibling);
      }
    });
  });
}

/*****************************
* Memuat dan Menampilkan PDF *
******************************/ 
function loadPDF(section, pdfUrl, title = '') {
    console.log('loadPDF called:', { section, pdfUrl, title });
    
    const pdfViewer = document.getElementById(`pdfViewer${capitalizeFirst(section)}`);
    const pdfContainer = document.getElementById(`pdfContainer${capitalizeFirst(section)}`);
    
    if (!pdfViewer || !pdfContainer) {
        console.error('‚ùå PDF Viewer or Container not found for section:', section);
        return;
    }
    
    // TUTUP SEMUA PDF LAIN TERLEBIH DAHULU
    document.querySelectorAll('.pdf-viewer').forEach(pdf => {
        pdf.style.display = 'none';
    });
    
    // Reset previous PDF
    pdfContainer.innerHTML = '';
    currentPDFData = {
        section: section,
        url: pdfUrl,
        title: title
    };
    
    // Show loading
    pdfContainer.innerHTML = `
        <div class="pdf-loading">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <div class="mt-2">Memuat PDF, tunggu...</div>
        </div>
    `;
    
    // Show PDF viewer
    pdfViewer.style.display = 'block';
    
    // Tempatkan PDF viewer di posisi yang tepat
    const cekDisiniBtn = document.getElementById(`btnCekDisini${capitalizeFirst(section)}`);
    if (cekDisiniBtn && cekDisiniBtn.parentNode) {
        // Tempatkan PDF viewer setelah parent paragraph dari tombol
        const parentParagraph = cekDisiniBtn.closest('p');
        if (parentParagraph && parentParagraph.parentNode) {
            parentParagraph.parentNode.insertBefore(pdfViewer, parentParagraph.nextSibling);
            console.log('‚úÖ PDF placed after button paragraph');
        } else {
            // Fallback: tempatkan setelah tombol langsung
            cekDisiniBtn.parentNode.insertBefore(pdfViewer, cekDisiniBtn.nextSibling);
            console.log('‚úÖ PDF placed after button');
        }
    } else {
        console.log('‚ùå Cek Disini button not found for section:', section);
    }
    
    // Load PDF setelah ditampilkan
    setTimeout(() => { displayPDF(section, pdfUrl, title); }, 500);
}

/***************************************
* Setup link PDF - khusus Menu Panduan *
****************************************/
function setupPanduanPDFLinks() {
    const panduanPDFLink = document.getElementById('pdfPanduanLink');
    if (panduanPDFLink) {
        // Hapus href yang menyebabkan navigasi
        panduanPDFLink.href = "#";
        // Tambahkan event listener baru
        panduanPDFLink.addEventListener('click', function(e) {
            e.preventDefault();
            loadPDF('panduan', 'pdf/Panduan_Penggunaan_Aplikasi.pdf', 'PDF Panduan Penggunaan Aplikasi');
        });
        
        console.log('‚úÖ PDF Panduan link setup completed');
    // } else {
       // console.error('‚ùå PDF Panduan link not found');
    }
}

/******************
* Menampilkan PDF *
*******************/
function displayPDF(section, pdfUrl, title) {
    console.log('Displaying PDF with PDF.js:', pdfUrl);
    const pdfContainer = document.getElementById(`pdfContainer${capitalizeFirst(section)}`);
    if (!pdfContainer) return;
    
    // Set up PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    const scale = 1.5;
    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.className = 'pdfjs-canvas';
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            const renderTask = page.render(renderContext);
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
            
            // Clear container dan tambahkan canvas DULUAN
            const viewer = document.getElementById(`pdfjsViewer${capitalizeFirst(section)}`);
            viewer.innerHTML = '';
            viewer.appendChild(canvas);
            
            // Update page info
            document.getElementById(`pdfjsPageInfo${capitalizeFirst(section)}`).textContent = 
                `Hal: ${num} dari ${pdfDoc.numPages}`;
                
        }).catch(function(error) {
            console.error('Error rendering page:', error);
            // handlePDFError(section);
        });
    }
    // Antrian render halaman
    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }
    // Ke halaman sebelumnya 
    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }
    // ke halaman berikutnya
    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }
    
    // Load the PDF
    pdfjsLib.getDocument(pdfUrl).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        
        // Update container - CONTROLS DIBAWAH SETELAH CANVAS
        pdfContainer.innerHTML = `
            <div class="pdfjs-viewer" id="pdfjsViewer${capitalizeFirst(section)}"></div>
            <div class="pdfjs-controls">
                <button class="btn btn-sm btn-outline-primary" onclick="onPrevPage${capitalizeFirst(section)}()">
                    <i class="fas fa-chevron-left"></i> Sebelum
                </button>
                <span class="pdfjs-page-info" id="pdfjsPageInfo${capitalizeFirst(section)}">
                    Hal: 1 dari ${pdfDoc.numPages}
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="onNextPage${capitalizeFirst(section)}()">
                    Berikut <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
        // Render first page
        renderPage(1);
        // Store functions globally for button access
        window[`onPrevPage${capitalizeFirst(section)}`] = onPrevPage;
        window[`onNextPage${capitalizeFirst(section)}`] = onNextPage;
    }).catch(function(error) {
        console.error('Error loading PDF with PDF.js:', error);
        // Fallback ke iframe
        fallbackToIframe(section, pdfUrl);
    });
}

/***************************************
* Fallback ke Iframe Jika PDF.js Gagal *
****************************************/
function fallbackToIframe(section, pdfUrl) {
    const pdfContainer = document.getElementById(`pdfContainer${capitalizeFirst(section)}`);
    pdfContainer.innerHTML = `
        <iframe src="${pdfUrl}#toolbar=0&navpanes=0&scrollbar=1&view=FitH" 
          width="100%" height="500" style="border: none;">
        </iframe>
    `;
}

/***********************
* Buka PDF di Tab Baru *
************************/
function openPDFInNewTab(section) {
    if (currentPDFData.url) {
        window.open(currentPDFData.url, '_blank');
    }
}

/*******************************************
* Tutup PDF Viewer & Tidak menutup submenu *
********************************************/
function closePDF(section) {
    console.log('Closing PDF for section:', section);
    const pdfViewer = document.getElementById(`pdfViewer${capitalizeFirst(section)}`);
    const pdfContainer = document.getElementById(`pdfContainer${capitalizeFirst(section)}`);
    if (!pdfViewer || !pdfContainer) return;
    
    // Clear PDF content
    pdfContainer.innerHTML = '';
    pdfViewer.style.display = 'none';
    
    // JANGAN kembalikan ke posisi semula, biarkan tetap di submenu
    currentPDFData = {};
    
    console.log('‚úÖ PDF closed (submenu remains open)');
}

/*************************
* Tutup Semua PDF Viewer *
**************************/
function closeAllPDFs() {
    console.log('Closing all PDFs');
    const pdfViewers = document.querySelectorAll('.pdf-viewer');
    pdfViewers.forEach(viewer => {
        viewer.style.display = 'none';
        const container = viewer.querySelector('.pdf-container');
        if (container) {
            container.innerHTML = '';
        }
    });
    
    currentPDFData = {};
    console.log('‚úÖ All PDFs closed');
}

// ********************************
// ***** FUNGSI SUMNEU DAN UI *****
/**********************************

/***********************************************
* Tampilkan Submenu & Tidak menyembunyikan PDF *
***********************************************/
function showSubmenu(targetId) {
  console.log('üîç Menampilkan submenu:', targetId);
  
  // TUTUP SEMUA SUBMENU LAIN TAPI BIARKAN PDF TERBUKA
  document.querySelectorAll('.submenu-content').forEach(content => {
    if (content.id !== targetId) {
      content.style.display = 'none';
      // Kembalikan ke posisi semula
      const menuAccordion = document.getElementById('menuAccordion');
      if (menuAccordion && menuAccordion.parentNode) {
        menuAccordion.parentNode.insertBefore(content, menuAccordion.nextSibling);
      }
    }
  });
  
  // Tampilkan submenu yang dipilih
  const targetContent = document.getElementById(targetId);
  if (targetContent) {
    // TEMUKAN TRIGGER ELEMENT YANG DITEKAN
    const triggerElement = document.querySelector(`[data-target="${targetId}"]`);
    
    if (triggerElement) {
      console.log('‚úÖ Trigger ditemukan:', triggerElement);
      
      // TEMUKAN PARENT MENU CONTENT (di dalam accordion)
      const parentMenuContent = triggerElement.closest('.menu-content');
      
      if (parentMenuContent) {
        console.log('‚úÖ Menu content parent ditemukan');
        
        // Tempatkan content TEPAT SETELAH TRIGGER ELEMENT di dalam menu content
        parentMenuContent.insertBefore(targetContent, triggerElement.nextSibling);
        
        // Tampilkan content
        targetContent.style.display = 'block';
        
        console.log('‚úÖ Submenu ditempatkan di posisi yang benar');
        
      } else {
        console.warn('‚ö†Ô∏è Menu content parent tidak ditemukan');
        
        // Fallback: tempatkan setelah trigger element
        triggerElement.parentNode.insertBefore(targetContent, triggerElement.nextSibling);
        targetContent.style.display = 'block';
      }
    } else {
      console.error('‚ùå Trigger element tidak ditemukan untuk:', targetId);
      targetContent.style.display = 'block';
    }
    
    // Scroll ke konten yang ditampilkan
    setTimeout(() => { 
      targetContent.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
      console.log('üìú Scroll ke submenu');
    }, 100);
  } else {
    console.error('‚ùå Target content tidak ditemukan:', targetId);
  }
}

/**************************************************
* Sembunyikan Submenu dan tidak meyembunyikan PDF *
***************************************************/
function hideSubmenu(targetId) {
  console.log('üîç Menyembunyikan submenu:', targetId);
  
  const targetContent = document.getElementById(targetId);
  if (targetContent) {
    // Hanya sembunyikan submenu content itu sendiri
    targetContent.style.display = 'none';
    
    // KEMBALIKAN KE POSISI SEMULA (setelah menu accordion)
    const menuAccordion = document.getElementById('menuAccordion');
    if (menuAccordion && menuAccordion.parentNode) {
      menuAccordion.parentNode.insertBefore(targetContent, menuAccordion.nextSibling);
      console.log('‚úÖ Submenu dikembalikan ke posisi semula');
    }
    
    // Scroll kembali ke menu yang aktif
    const activeMenu = document.querySelector('.menu-header:not(.collapsed)');
    if (activeMenu) {
      setTimeout(() => {
        activeMenu.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
  }
}
// *****************************
// ***** UTILITY FUNCTIONS *****
// *****************************

/***************************************************************
* Fungsi untuk check status dan apply disable berdasarkan user *
****************************************************************/
function checkAndApplyButtonStatus(userId, hariKe) {
    console.log(`üîç Checking button status for user ${userId}, day ${hariKe}`);
    
    // Ambil progress data dari localStorage (yang sudah disinkron dari server)
    const progressData = localStorage.getItem(`progressData_${userId}`);
    if (!progressData) return;
    
    const progress = JSON.parse(progressData);
    
    // Check dan apply status untuk setiap submenu
    const statusChecks = [
        { type: 'materi', check: progress.materiHari1 },
        { type: 'mealplan', check: progress.mealplanHari1 },
        { type: 'workout', check: progress.workoutHari1 },
        { type: 'water', check: progress.waterHari1 },
        { type: 'istirahat', check: progress.istirahatHari1 },
        { type: 'datatracking', check: progress.datatrackingHari1 }
    ];
    
    statusChecks.forEach(item => {
        if (item.check) {
            disableButtonsAfterCompletion(hariKe, item.type);
            updateSubmenuLinkUI(hariKe, item.type);
        }
    });
}

/****************************************************
* Tampilkan submenu hanya untuk melihat (read-only) *
*****************************************************/
function showSubmenuOnly(targetId) {
    console.log(`üëÅÔ∏è Showing submenu ${targetId} in read-only mode`);
    
    const targetContent = document.getElementById(targetId);
    if (!targetContent) return;
    
    // Tampilkan submenu
    showSubmenu(targetId);
    
    // Apply read-only styling
    setTimeout(() => {
        // Disable semua tombol aksi
        targetContent.querySelectorAll('button').forEach(button => {
            if (!button.id.includes('CekDisini') && !button.classList.contains('close')) {
                button.disabled = true;
                if (button.classList.contains('btn-primary') || button.classList.contains('btn-success')) {
                    button.classList.remove('btn-primary', 'btn-success');
                    button.classList.add('btn-secondary');
                }
                button.style.opacity = '0.6';
                button.style.cursor = 'not-allowed';
                button.title = 'Sudah selesai';
            }
        });
        
        // Disable input fields
        targetContent.querySelectorAll('input, select, textarea').forEach(input => {
            if (!input.id.includes('CekDisini')) {
                input.disabled = true;
                input.readOnly = true;
                input.style.backgroundColor = '#f8f9fa';
                input.style.cursor = 'not-allowed';
            }
        });
        
        // Tombol "Cek Disini" tetap enabled
        targetContent.querySelectorAll('[id^="btnCekDisini"]').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.title = 'Lihat PDF';
        });
    }, 300);
}

/**********************************************
* Memberikan tombol centang Materi (Hari 1‚Äì10)
***********************************************/
function setupMateriCompletion() {
  console.log('üîß Setting up materi completion...');

  document.querySelectorAll('.video-container').forEach(container => {
    const containerId = container.id;

    if (!containerId.includes('Pertemuan')) return;

    const hariKe = containerId.replace('videoContainerPertemuan', '');
    const videoWrapper = container.querySelector('.video-wrapper');
    if (!videoWrapper) return;

    videoWrapper.style.position = 'relative';

    let completeBtn = container.querySelector('.complete-btn');

    // === BUAT TOMBOL JIKA BELUM ADA ===
    if (!completeBtn) {
      completeBtn = document.createElement('button');
      completeBtn.innerHTML = '<i class="fas fa-check"></i>';
      completeBtn.className = 'btn btn-success btn-sm complete-btn';
      completeBtn.id = `btnMateriDone${hariKe}`;
      completeBtn.style.cssText = `
        position: absolute; top: 10px; left: 10px; z-index: 25;
        width: 35px; height: 35px; border-radius: 50%; padding: 0;
        border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      `;

      completeBtn.onclick = () => {
        if (completeBtn.dataset.done === 'true') {
          console.warn('‚õî Materi sudah diselesaikan');
          return;
        }

        simpanMateri(hariKe);

        // üîí KUNCI LANGSUNG DI UI
        completeBtn.dataset.done = 'true';
        completeBtn.disabled = true;
        completeBtn.innerHTML = '<i class="fas fa-check-double"></i>';
        completeBtn.classList.remove('btn-success');
        completeBtn.classList.add('btn-secondary');

        // üíæ SIMPAN STATUS
        localStorage.setItem(`materi_hari_${hariKe}`, 'completed');

        // ‚úÖ UPDATE SUBMENU
        updateSubmenuLinkUI('materi', hariKe);
      };

      videoWrapper.appendChild(completeBtn);
      console.log('‚úÖ Tombol centang ditambahkan:', completeBtn.id);
    }

    // === AUTO-LOCK JIKA SUDAH COMPLETED ===
    if (localStorage.getItem(`materi_hari_${hariKe}`) === 'completed') {
      completeBtn.dataset.done = 'true';
      completeBtn.disabled = true;
      completeBtn.innerHTML = '<i class="fas fa-check-double"></i>';
      completeBtn.classList.remove('btn-success');
      completeBtn.classList.add('btn-secondary');
    }
  });
}

/*********************************************************************
* Cari link "Selesai Perkenalan" dengan selector yang lebih spesifik *
*********************************************************************/
function setupPerkenalanCompletion() {
  const selesaiPerkenalanLinks = document.querySelectorAll('.menu-item');
  selesaiPerkenalanLinks.forEach(link => {
    if (link.textContent.includes('Selesai Perkenalan')) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        selesaikanPerkenalan();
      });
    }
  });
}

/*****************************
* Simpan & Kunci Materi Hari *
*****************************/
async function simpanMateri(hariKe) {
    console.log('üéØ Tombol centang diklik untuk hari:', hariKe);

    const userId   = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    if (!userId) return;

    const btn = document.getElementById(`btnMateriDone${hariKe}`);
    if (!btn) return;

    // ‚õî cegah klik ulang
    if (btn.dataset.done === 'true') {
        console.warn('‚õî Materi sudah diselesaikan');
        return;
    }

    const response = await fetch(URL_PROGRAM_APP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            action: 'updateMateri',
            userId,
            userName,
            hariKe
        })
    });

    const result = await response.text();
    console.log('üì• Response updateMateri:', result);

    if (result && result.includes('OK')) {
        // ‚úÖ simpan status lokal
        localStorage.setItem(`materi_hari_${hariKe}`, 'completed');

        // üîí KUNCI VIDEO TOTAL
        lockMateriVideo(hariKe);
        
        const btn = document.getElementById(`btnMateriDone${hariKe}`);
        // üîí KUNCI TOTAL TOMBOL
        disableButtonFully(btn);

        // üü¢ UPDATE SUBMENU (1.1, 2.1, dst)
        updateSubmenuLinkUI('materi', hariKe);

        console.log(`‚úÖ Materi hari ${hariKe} berhasil disimpan & dikunci`);
    }
}

/********************************************
* Selesaikan perkenalan unlock Hari Pertama *
********************************************/
async function selesaikanPerkenalan() {
  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');
  if (!userId) return;

  console.log('‚úÖ Menyelesaikan perkenalan');

  const response = await fetch(URL_PROGRAM_APP, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      action: 'updatePerkenalan',
      userId,
      userName
    })
  });

  const result = await response.text();
  console.log('üì• Response updatePerkenalan:', result);

  if (result && result.includes('OK')) {

    // üîì 1Ô∏è‚É£ UNLOCK DULU (INI PALING PENTING)
    unlockModul(1);

    // üîí 2Ô∏è‚É£ DISABLE tombol "Selesai Perkenalan" saja
    disableSelesaiPerkenalanButton();

    // ‚úÖ 3Ô∏è‚É£ BARU update UI submenu (SETELAH unlock)
    updateSubmenuLinkUI('perkenalan', 0);
  }
}

function lockMateriVideo(hariKe) {
    const container = document.getElementById(`videoContainerPertemuan${hariKe}`);
    if (!container) return;

    container.classList.add('video-locked');
    container.style.opacity = '0.8';

    console.log(`üîí Video materi hari ${hariKe} dikunci total`);
}

function disableSelesaiPerkenalanButton() {
  const container = document.getElementById('perkenalanContent');
  if (!container) return;
  // Cari link dengan teks "Selesai Perkenalan"
  const links = container.querySelectorAll('a.menu-item');
  links.forEach(link => {
    if (link.textContent.trim().includes('Selesai Perkenalan')) {
      link.style.pointerEvents = 'none';
      link.style.opacity = '0.5';
      link.classList.add('disabled');
    }
  });
}


function disableActionButtons(type, hariKe) {
  console.log(`üîí Disabling action buttons for ${type} day ${hariKe}`);

  const containerId =
    type === 'perkenalan'
      ? 'perkenalanContent'
      : `${type}Content${hariKe}`;

  const container = document.getElementById(containerId);
  if (!container) return;

  // üîë TARGET SEMUA TOMBOL AKSI (‚úì / Selesai)
  const buttons = container.querySelectorAll('button, a');

  buttons.forEach(btn => {
    btn.style.pointerEvents = 'none';
    btn.style.opacity = '0.5';
  });
}

/************************
* Cek Status Perkenalan *
*************************/
function checkPerkenalanStatus() {
  const userId = localStorage.getItem('userId');
  if (!userId) return;
  const perkenalanSelesai = localStorage.getItem('perkenalanSelesai');
   if (!perkenalanSelesai) {
    // Lock Modul Hari Pertama
    const modulPertamaHeader = document.querySelector('[data-hari="1"]');
    if (modulPertamaHeader) {
      modulPertamaHeader.classList.add('disabled');
      modulPertamaHeader.style.pointerEvents = 'none';
      modulPertamaHeader.style.opacity = '0.6';
      
      const lockIcon = modulPertamaHeader.querySelector('.status-lock');
      if (lockIcon) {
        lockIcon.className = 'status-lock';
        lockIcon.innerHTML = '<i class="fas fa-lock"></i>';
      }
    }
  }
}

function disableCheckButton(sectionId) {
  const btn = document.querySelector(
    `#${sectionId} .btn-check, #${sectionId} .btn-selesai, #${sectionId} a[onclick*="simpan"]`
  );
  if (btn) {
    btn.style.pointerEvents = 'none';
    btn.style.opacity = '0.5';
  }
}


/*******************************************************
* Unlock modul berikutnya secara otomatis              * 
* @param {number} hariSelesai - Hari yang baru selesai *
********************************************************/
function selesaiMateri(hariSelesai) {
    console.log('‚úÖ Menyelesaikan materi hari:', hariSelesai);
    showMessage('success', `Materi hari ${hariSelesai} selesai!`, 3000, `pertemuan${hariSelesai}`);
    
    // Unlock modul berikutnya (jika masih dalam range 1-10)
    const nextHari = hariSelesai + 1;
    if (nextHari <= 10) {
        unlockModul(nextHari);
    }
}

/***************************************
* Simpan status materi di localStorage *
****************************************/
function saveMateriStatus(hariKe, status) {
    localStorage.setItem(`materi_hari_${hariKe}`, status);
    localStorage.setItem(`materi_completed_${hariKe}`, new Date().toISOString());
    
    // Apply button disable
    disableButtonsAfterCompletion(hariKe, 'materi');
}

/************************************
* Check dan apply unlock untuk user existing *
*************************************/
async function checkAndUnlockModulesForUser(userId) {
    console.log('üîì Checking and unlocking modules for user:', userId);
    
    try {
        // Ambil progress dari server
        const progress = await fetchUserProgressFromServer(userId);
        
        if (progress && progress.success) {
            console.log('üìä Progress from server:', progress);
            
            // 1. Jika perkenalan sudah selesai, unlock modul hari 1
            if (progress.perkenalan) {
                console.log('‚úÖ Perkenalan sudah selesai - unlocking modul hari 1');
                unlockModul(1);
                
                // Update UI perkenalan
                updatePerkenalanUI();
            }
            
            // 2. Check progress untuk setiap submenu
            const progressChecks = [
                { type: 'materi', field: 'materiHari1' },
                { type: 'mealplan', field: 'mealplanHari1' },
                { type: 'workout', field: 'workoutHari1' },
                { type: 'water', field: 'waterHari1' },
                { type: 'istirahat', field: 'istirahatHari1' },
                { type: 'datatracking', field: 'datatrackingHari1' }
            ];
            
            progressChecks.forEach(item => {
                if (progress[item.field]) {
                    console.log(`‚úÖ ${item.type} sudah selesai - updating UI`);
                    updateSubmenuLinkUI(1, item.type);
                    disableButtonsAfterCompletion(1, item.type);
                }
            });
            
            // 3. Auto-expand Modul Hari 1 jika sudah ada progress
            if (progress.perkenalan || progress.materiHari1 || progress.mealplanHari1 || progress.workoutHari1) {
                setTimeout(() => {
                    const header = document.querySelector('[data-hari="1"]');
                    if (header && header.classList.contains('collapsed')) {
                        console.log('üìñ Auto-expanding Modul Hari 1');
                        header.click();
                    }
                }, 1000);
            }
            
        } else {
            console.log('‚ö†Ô∏è No progress found or user is new');
            // Untuk user baru, lock modul hari 1
            lockModul(1);
        }
        
    } catch (error) {
        console.error('‚ùå Error checking user progress:', error);
        // Fallback: cek dari localStorage
        checkProgressFromLocalStorage(userId);
    }
}

/************************************
* Fetch progress dari server dengan Promise *
*************************************/
function fetchUserProgressFromServer(userId) {
    return new Promise((resolve, reject) => {
        const callbackName = 'cb_user_progress_' + Date.now();
        const script = document.createElement('script');
        
        script.src = `${URL_PROGRAM_APP}?action=getLastProgress&userId=${encodeURIComponent(userId)}&callback=${callbackName}`;
        
        window[callbackName] = function(response) {
            console.log('üì° Server progress response:', response);
            resolve(response);
            document.body.removeChild(script);
            delete window[callbackName];
        };
        
        script.onerror = () => {
            console.warn('‚ö†Ô∏è Failed to fetch progress from server');
            reject(new Error('Failed to fetch progress'));
            document.body.removeChild(script);
            delete window[callbackName];
        };
        
        document.body.appendChild(script);
    });
}

/************************************
* Check progress dari localStorage sebagai fallback *
*************************************/
function checkProgressFromLocalStorage(userId) {
    console.log('üìÇ Checking progress from localStorage for user:', userId);
    
    // Cek progress data user-specific
    const userProgressKey = `progressData_${userId}`;
    const userProgress = JSON.parse(localStorage.getItem(userProgressKey) || '{}');
    
    if (userProgress.success) {
        console.log('üìä Found user progress in localStorage:', userProgress);
        
        // Jika perkenalan sudah selesai, unlock modul hari 1
        if (userProgress.perkenalan) {
            unlockModul(1);
            updatePerkenalanUI();
        }
        
        // Check submenu progress
        if (userProgress.materiHari1 || userProgress.mealplanHari1 || userProgress.workoutHari1) {
            unlockModul(1);
        }
        
    } else {
        // Cek general progress data
        const generalProgress = JSON.parse(localStorage.getItem('progressData') || '{}');
        if (generalProgress.success && generalProgress.perkenalan) {
            unlockModul(1);
            updatePerkenalanUI();
        }
    }
}

/****************************************
* Update UI materi dengan tanda centang *
*****************************************/

/************************
/***** FUNGSI BANTU *****
/************************/

/********************************
* Convert file to base64 string *
*********************************/
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = error => reject(error);
    });
}

/**************************
* Mengambil Nilai hari ke *
***************************/
function getHariKeFromSection(section) {
  const map = {
    'Pertemuan1': 1, 'Pertemuan2': 2, 'Pertemuan3': 3,
    'Pertemuan4': 4, 'Pertemuan5': 5, 'Pertemuan6': 6,
    'Pertemuan7': 7, 'Pertemuan8': 8, 'Pertemuan9': 9,
    'Pertemuan10': 10
  };
  return map[section] || 1;
}

/**********************************
* Konvers Huruf Besar Awal String *
***********************************/
function capitalizeFirst(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

/**********************************
* Mengupdate Status Materi Unlock *
***********************************/
function updateMateriStatusUI(hariKe) {
  const header = document.querySelector(`[data-hari="${hariKe}"]`);
  if (header) {
    const lockIcon = header.querySelector('.status-lock');
    if (lockIcon) {
      lockIcon.className = 'status-unlock';
      lockIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
    }
  }
}

/************************
* Jadwal Waktu Istrihat *
*************************/   
const radioIstirahat = document.getElementById("istirahatBtn");
if (radioIstirahat) {
  const wrapper = document.createElement("div");
  wrapper.className = "mb-1"; /* "input-group mb-1 align-items-start"; */
  wrapper.innerHTML = `  
    <h6><b>WAKTU ISTIRAHAT</b></h6>
    <b>Mulai Istirahat Jam</b>
    <div class="input-group mb-3">
      <button type="button" class="btn btn-outline-primary btn-sm" id="btnStartIstirahat" data-bs-toggle="tooltip" title="Mulai Istirahat">
        <i class="far fa-clock mt-2 mb-2"></i>  
      </button>
      <input class="form-control" type="time" id="mulaiIstirahat" style="max-width: 100%;" disabled>  
    </div>

    <b>Berapa Jam Istirahat</b></h6>
    <div class="input-group mb-3">
      <div class="input-group-text">
        <input type="radio">
      </div>
      <input type="text" class="form-control" id="tidurKurang6Jam" placeholder="Kurang dari 6jam per malam" readonly>
    </div>  
    
    <div class="input-group mb-3">
      <div class="input-group-text">
        <input type="radio">
      </div>
      <input type="text" class="form-control" id="tidurAntara6_8Jam" placeholder="6jam-8jam per malam" readonly>
    </div>  
    
    <div class="input-group mb-3">
      <div class="input-group-text">
        <input type="radio">
      </div>
      <input type="text" class="form-control" id="tidurLebih8Jam" placeholder="Lebih 8jam per malam" readonly>
    </div>  
    <div class="container p-0">
      <button type="button" class="btn btn-primary btn-sm" id="btnSimpanIstirahat" data-bs-toggle="tooltip" title="Simpan Istirahat"><i class="fa fa-pencil-square-o"></i> Simpan</button>
      <button type="button" class="btn btn-secondary btn-sm" id="btnSelesaiIstirahat" data-bs-toggle="tooltip" title="Selesai Istirahat"><i class="fa fa-check"></i> Selesai</button>
    </div>
  `;
    radioIstirahat.appendChild(wrapper);
} 

/***************************
* Input Data Kondisi Tubuh *
****************************/   
const inputKondisiTubuh = document.getElementById("kondisiTubuh");
if (inputKondisiTubuh) {
  const wrapper = document.createElement("div");
  wrapper.className = "mb-1"; /* "input-group mb-1 align-items-start"; */
  wrapper.innerHTML = `  
    <!-- Pilih Jenis Kelamin -->
    <div class="input-group mt-3 mb-3">  
      <div class="input-group-text">
        <i class="fas fa-venus-mars"></i> 
      </div>
      <select class="form-select" id="jenisKelamin1" required>
        <option value="">Pilihan Jenis Kelamin...</option>
        <option value="Pria">Pria</option>
        <option value="Wanita">Wanita</option>
      </select>
    </div> 

    <!-- Input Data Umur -->
    <div class="input-group mb-3">
      <div class="input-group-text">
        <i class="far fa-calendar-alt" style="padding-left: 3px; padding-right:4px;"></i>
      </div>
      <div class="input-group-text">
        <label>Input Tgl Lahir</label>
      </div>
      <input type="date" class="form-control" id="tglLahir">
    </div>  
                  
    <!-- Input Berat Badan -->
    <div class="input-group mb-3">
      <div class="input-group-text">
        <i class="fas fa-weight" style="padding-left: 2px; padding-right:3px;"></i>
      </div>
      <input type="number" class="form-control" id="beratBadan" placeholder="Input Berat badan (kg)">
    </div>  

    <!-- Input Tinggi Badan -->
    <div class="input-group mb-3">
      <div class="input-group-text">
        <i class="fas fa-ruler-vertical" style="padding-left: 5px; padding-right: 6px;"></i>
      </div>
      <input type="number" class="form-control" id="tinggiBadan" placeholder="Input Tinggi badan (cm)">
    </div>  
                  
    <!-- Input Lingkar Pinggang -->
    <div class="input-group mb-3">
      <div class="input-group-text">
        <i class="fas fa-ribbon" style="padding-left: 3px; padding-right: 4px;"></i>
      </div>
      <input type="number" class="form-control" id="lngkarPinggang" placeholder="Input Lingkar Pinggang (cm)">
    </div>

    <!-- Input Aktivitas Olahraga -->
    <div class="input-group mt-3 mb-3">
      <div class="input-group-text">
        <i class="fas fa-dumbbell"></i> 
      </div>
      <select class="form-select" id="aktivitasOlahraga" style="max-width: 100%;" required>
        <option value="">Pilihan Aktivitas Olahraga...</option>
        <option value="Sedikit/Tidak Olahraga">Sedikit/Tidak Olahraga</option>
        <option value="Olahraga ringan 1-3 hari/minggu">Olahraga ringan 1-3 hari/minggu</option>
        <option value="Olahraga moderat 3-5 hari/minggu">Olahraga moderat 3-5 hari/minggu</option>
        <option value="Olahraga berat 6-7 hari per minggu">Olahraga berat 6-7 hari/minggu</option>
        <option value="Olahraga sangat aktif + Kegiatan fisik">Olahraga aktif + Kegiatan fisik</option>           
      </select>
    </div>

    <div>
      <button type="button" class="btn btn-primary btn-sm" id="btnSimpanDataTubuh" data-bs-toggle="tooltip" title="Simpan Data Fisik"><i class="fa fa-pencil-square-o"></i> Simpan</button>
      <button type="button" class="btn btn-secondary btn-sm" id="btnSelesaiDataTubuh" data-bs-toggle="tooltip" title="Selesai Input Data"><i class="fa fa-check"></i> Selesai</button>
    </div>
  `;
  inputKondisiTubuh.appendChild(wrapper);
}   

/***********************************************
* Upload meal plan untuk hari tertentu di form * 
************************************************/
function uploadMealPlan(hariKe) {
    console.log('üçΩÔ∏è Upload meal plan hari:', hariKe);
    // Tampilkan form upload langsung
    showMealPlanUploadForm(hariKe);
    // restore saat submenu dibuka
    restoreMealPlanState(hariKe);
}

/************************
* Tampilkan upload file *
*************************/
function showMealPlanUploadForm(hariKe) {
    // Sembunyikan semua submenu lainnya
    document.querySelectorAll('.submenu-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Tampilkan meal plan content
    const mealPlanContent = document.getElementById(`mealPlanContent${hariKe}`);
    if (mealPlanContent) {
        mealPlanContent.style.display = 'block';
        // Scroll ke form
        setTimeout(() => { mealPlanContent.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        // showMessage('info', `Upload meal plan hari ${hariKe}`, 3000, `pertemuan${hariKe}`);
    } else {
        showMessage('error', 'Form meal plan tidak ditemukan', 3000, `pertemuan${hariKe}`);
    }
}

function handleMealUploadResponse(result) {
  console.log('üì• Upload callback result:', result);

  if (!result || !result.success) return;

  const { hariKe, mealType, fileName } = window.__lastMealUpload || {};
  if (!hariKe || !mealType) return;

  updateMealInputField(mealType, fileName, hariKe);
}

/************************
 * Upload per item meal *
 ************************/
async function uploadMealItem(hariKe, mealType) {
  console.log(`üì∏ Upload ${mealType} hari ${hariKe}`);
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';

  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const base64Data = reader.result.split(',')[1];
        const res = await uploadToServer(
          hariKe,
          mealType,
          base64Data,
          file.name
        );

        console.log('üì• Upload result:', res);
        if (res && res.success) {
          // ‚úÖ SET NAMA FILE KE INPUT
          updateMealInputField(mealType, file.name, hariKe);
          
          // simpan nama file agar persist
          localStorage.setItem(`mealFile_${hariKe}_${mealType}`, file.name);

          // ‚úÖ SIMPAN STATUS LOKAL (UNTUK VALIDASI)
          const key = `meal_${hariKe}_${mealType}`;
          localStorage.setItem(key, 'done');
          console.log(`‚úÖ ${mealType} hari ${hariKe} selesai`);
        } else {
          // alert('Gagal upload: ' + (res?.message || 'Unknown error'));
          showMessage('error', 'Gagal Upload', 3000);
        }
      } catch (err) {
        console.error('‚ùå Upload error:', err);
        // alert('Terjadi kesalahan saat upload');
        showMessage('error','Terjadi kesalahan saat upload', 3000);
      }
    };
    reader.readAsDataURL(file);
  };
  fileInput.click();
}

/************************
* Upload file ke server *
*************************/
async function uploadToServer(hariKe, mealType, fileData, fileName) {
  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');
  if (!userId) {
    console.error('‚ùå User belum login');
    return { success: false, message: 'Silakan login terlebih dahulu' };
  }

  try {
    const response = await fetch(URL_PROGRAM_APP, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        action: 'uploadMealPlan',
        userId,
        userName,
        hariKe,
        mealType,
        file: fileData,
        fileName
      })
    });

    let raw = await response.text();
    console.log('üì• Upload response RAW:', raw);
    if (!raw) {
      return { success: false, message: 'Response kosong dari server' };
    }

    // üî• BERSIHKAN RESPONSE (kasus undefined({...}))
    let clean = raw.trim();
    if (clean.startsWith('undefined')) {
      clean = clean.replace(/^undefined/, '');
    }
    if (clean.startsWith('(') && clean.endsWith(')')) {
      clean = clean.slice(1, -1);
    }

    // üß† PARSE JSON
    try {
      const parsed = JSON.parse(clean);
      return parsed;
    } catch (err) {
      console.error('‚ùå JSON parse gagal:', clean);
      return {
        success: false,
        message: 'Format response server tidak valid'
      };
    }

  } catch (error) {
    console.error('‚ùå Server error:', error);
    return {
      success: false,
      message: 'Gagal terhubung ke server'
    };
  }
}

/*********************************
 * Update input + centang hijau  *
 *********************************/
function updateMealInputField(mealType, fileName, hariKe) {
  const input = document.getElementById(`${mealType}${hariKe}`);
  if (!input) return;

  input.value = fileName;

  // üü¢ centang di DALAM input
  input.style.backgroundImage    = "url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" fill=\"green\"><path d=\"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.08 0l3.992-3.992a.75.75 0 1 0-1.06-1.06L7.5 9.44 6.03 7.97a.75.75 0 1 0-1.06 1.06l2 2z\"/></svg>')";
  input.style.backgroundRepeat   = 'no-repeat';
  input.style.backgroundPosition = 'right 10px center';
  input.style.backgroundSize     = '16px';
}

/****************************************
* Get nama meal type yang user-friendly *
*****************************************/
function getMealTypeName(mealType) {
    const mealNames = {
        'sarapan': 'Sarapan',
        'cemilanPagi': 'Cemilan Pagi', 
        'makanSiang': 'Makan Siang',
        'cemilanSore': 'Cemilan Sore',
        'makanMalam': 'Makan Malam'
    };
    return mealNames[mealType] || mealType;
}

/*************************************
* Selesaikan Meal Plan ‚Äì FINAL FIX
* (TIDAK menyentuh container)
*************************************/
async function selesaikanMealPlan(hariKe) {
    console.log(`üçΩÔ∏è Menyelesaikan Meal Plan hari ${hariKe}`);

    // 1Ô∏è‚É£ VALIDASI SEMUA ITEM SUDAH UPLOAD
    if (!checkAllMealsUploaded(hariKe)) {
        showMessage( 'warning', 'Masih ada meal plan yang belum diupload', 3000, `mealPlanContent${hariKe}` );
        return;
    }

    const userId   = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    if (!userId) return;

    // 2Ô∏è‚É£ SIMPAN STATUS OK KE SHEET (KOLOM Q)
    const response = await fetch(URL_PROGRAM_APP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            action: 'updateMealPlan',
            userId,
            userName,
            hariKe
        })
    });

    const result = await response.text();
    console.log('üì• Update Meal Plan:', result);

    if (result && result.includes('OK')) {

        // 3Ô∏è‚É£ SIMPAN STATUS LOKAL
        localStorage.setItem(`mealplanHari${hariKe}`, 'OK');

        showMessage( 'success', 'Meal Plan Tersimpan dan Selesai', 3000, `mealPlanContent${hariKe}` );
        // 4Ô∏è‚É£ KUNCI UI lockMealPlanUI
        lockMealPlanUI(hariKe);

        // 5Ô∏è‚É£ CENTANG SUBMENU
        updateSubmenuLinkUI('mealplan', hariKe);

        // ‚ùå PENTING: TIDAK ADA KODE YANG MENYENTUH CONTAINER
        console.log(`‚úÖ Meal Plan hari ${hariKe} selesai (X & PDF aman)`);
    }
}

/*****************************************
 * Restore Meal Plan setelah reload      *
 *****************************************/
function restoreMealPlanState(hariKe) {
  const mealTypes = [
    'sarapan',
    'cemilanPagi',
    'makanSiang',
    'cemilanSore',
    'makanMalam'
  ];

  mealTypes.forEach(meal => {
    const fileName = localStorage.getItem(`mealFile_${hariKe}_${meal}`);
    if (fileName) {
      updateMealInputField(meal, fileName, hariKe);
    }
  });

  // Jika sudah selesai
  if (localStorage.getItem(`mealPlanDone_${hariKe}`) === 'true') {
    lockMealPlanUI(hariKe);
    updateSubmenuLinkUI(hariKe, 'mealplan');
  }
}

/***********************************************************
* Cek apakah semua meal sudah diupload untuk hari tertentu *
************************************************************/
function checkAllMealsUploaded(hariKe) {
  const meals = [
    'sarapan',
    'cemilanPagi',
    'makanSiang',
    'cemilanSore',
    'makanMalam'
  ];
  return meals.every(meal =>
    localStorage.getItem(`meal_${hariKe}_${meal}`) === 'done'
  );
}

/**************************
* Simpan status meal plan *
***************************/
function saveMealPlanStatus(hariKe, status) {
    localStorage.setItem(`mealplan_hari_${hariKe}`, status);
    localStorage.setItem(`mealplan_completed_${hariKe}`, new Date().toISOString());
    
    // Apply button disable
    disableButtonsAfterCompletion(hariKe, 'mealplan');
}

/************************************************************
* Update UI setelah meal plan selesai dengan disable tombol *
*************************************************************/
function updateMealPlanCompletionUI(hariKe) {
  // üîí Disable tombol selesai
  const selesaiBtn = document.getElementById(`btnSelesaiMealPlan${hariKe}`);
  if (selesaiBtn) {
    selesaiBtn.disabled = true;
    selesaiBtn.onclick = null;
    selesaiBtn.style.opacity = '0.5';
  }

  // üîí Disable SEMUA tombol upload
  const container = document.getElementById(`mealPlanContent${hariKe}`);
  if (container) {
    container.querySelectorAll('button').forEach(btn => {
      btn.disabled = true;
      btn.onclick = null;
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.5';
    });
  }

  // ‚úÖ Tandai submenu Meal Plan
  updateSubmenuLinkUI(hariKe, 'mealplan');
}

/*********************************
* Cek status meal plan saat load *
**********************************/
function checkMealPlanStatus(hariKe) {
    const status = localStorage.getItem(`mealplan_hari_${hariKe}`);
    if (status === 'completed') {
        updateMealPlanCompletionUI(hariKe);
    }
}

/*******************************************
* Generate form meal plan untuk semua hari *
********************************************/
function generateMealPlanForms() {
    for (let hariKe = 1; hariKe <= 10; hariKe++) {
        const containerId = `jadwalMealplan-list${hariKe > 1 ? hariKe : ''}`;
        const container = document.getElementById(containerId);
        
        if (container) {
            container.innerHTML = createMealPlanFormHTML(hariKe);
        }
    }
}

/**********************************************
* Load progress meal plan yang sudah diupload *
***********************************************/
function loadMealPlanProgress(hariKe) {
    const mealTypes = ['sarapan', 'cemilanPagi', 'makanSiang', 'cemilanSore', 'makanMalam'];
    
    mealTypes.forEach(mealType => {
        const status = localStorage.getItem(`meal_${hariKe}_${mealType}`);
        if (status === 'uploaded') {
            const fileName = localStorage.getItem(`meal_${hariKe}_${mealType}_file`) || 'File terupload';
            updateMealInputField(mealType, fileName, hariKe);
        }
    });
}

/***********************************
* Create HTML untuk form meal plan *
************************************/
function createMealPlanFormHTML(hariKe) {
    return `
        <div><label class="form-label">Sarapan (07:00 - 09:00)</label></div>
        <div class="input-group mt-0 mb-2">
            <input class="form-control" type="text" id="sarapan${hariKe}" placeholder="Upload Sarapan" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="uploadMealItem(${hariKe}, 'sarapan')">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>

        <div><label class="form-label">Cemilan Pagi (10:00 - 10:30)</label></div>
        <div class="input-group mt-0 mb-2">
            <input class="form-control" type="text" id="cemilanPagi${hariKe}" placeholder="Upload Cemilan Pagi" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="uploadMealItem(${hariKe}, 'cemilanPagi')">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>

        <div><label class="form-label">Makan Siang (12:00 - 14:00)</label></div>
        <div class="input-group mt-0 mb-2">
            <input class="form-control" type="text" id="makanSiang${hariKe}" placeholder="Upload Makan Siang" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="uploadMealItem(${hariKe}, 'makanSiang')">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>

        <div><label class="form-label">Cemilan Sore (16:00 - 16:30)</label></div>
        <div class="input-group mt-0 mb-2">
            <input class="form-control" type="text" id="cemilanSore${hariKe}" placeholder="Upload Cemilan Sore" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="uploadMealItem(${hariKe}, 'cemilanSore')">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>

        <div><label class="form-label">Makan Malam (18:00 - 20:00)</label></div>
        <div class="input-group mt-0 mb-2">
            <input class="form-control" type="text" id="makanMalam${hariKe}" placeholder="Upload Makan Malam" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="uploadMealItem(${hariKe}, 'makanMalam')">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>

        <!-- ‚úÖ TAMBAHKAN TOMBOL SELESAI -->
        <div class="text-left mt-4">
            <button type="button" class="btn btn-secondary btn-sm" onclick="selesaikanMealPlan(${hariKe})" id="btnSelesaiMealPlan${hariKe}">
                <i class="fa fa-check"></i> Selesai Meal Plan
            </button>
        </div>
    `;
}

// *********************************************
// ***** FUNGSI WORKOUT COMPLETE FLEKSIBEL *****
// *********************************************


/*************************************
 * SELESAIKAN WORKOUT (FINAL VERSION)
 *************************************/
async function selesaiWorkout(hariKe) {
  console.log(`üèÅ Menyelesaikan workout hari ${hariKe}`);

  // üîí USER LAMA ‚Üí LANGSUNG KELUAR (READ ONLY)
  if (
    window.userProgress &&
    window.userProgress[`workoutHari${hariKe}`] === true
  ) {
    console.log('‚ÑπÔ∏è Workout sudah selesai sebelumnya (user lama)');
    return;
  }

  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');

  // ‚õî VALIDASI BARU DILAKUKAN SAAT TOMBOL SELESAI DIKLIK
  const sudahSimpan = localStorage.getItem(`workoutSavedHari${hariKe}`) === 'true';
  if (!sudahSimpan) {
    showMessage( 'warning','Simpan data workout terlebih dahulu', 3000, `pertemuan${hariKe}` );
    return;
  }

  try {
    const response = await fetch(URL_PROGRAM_APP, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams({
        action: 'completeWorkout',
        userId,
        userName,
        hariKe
      })
    });

    const result = await response.json();
    console.log('üì• Complete workout response:', result);

    if (result.success === true) {
      // ‚úÖ SET STATUS FRONTEND
      if (!window.userProgress) window.userProgress = {};
      window.userProgress[`workoutHari${hariKe}`] = true;

      localStorage.setItem(`workoutHari${hariKe}`, 'completed');

      updateSubmenuLinkUI('workout', hariKe);
      disableWorkoutUI(hariKe);

      showMessage( 'success', 'Workout hari ini berhasil diselesaikan', 3000, `pertemuan${hariKe}` );
    } else {
      showMessage( 'error', result.message || 'Gagal menyelesaikan workout', 3000, `pertemuan${hariKe}` );
    }

  } catch (err) {
    console.error('‚ùå Error complete workout:', err);
    showMessage( 'error', 'Terjadi kesalahan koneksi', 3000, `pertemuan${hariKe}` );
  }
}

/****************************************
 * SHOW WORKOUT FORM - FINAL VERSION
 ****************************************/
function showWorkoutForm(hariKe) {
    console.log(`üëü Showing workout form for day ${hariKe}`);
    
    // 1. Pastikan form HTML sudah digenerate
    const containerId = hariKe === 1 ? 'olahragaKardio-list' : `olahragaKardio-list${hariKe}`;
    const container = document.getElementById(containerId);
    
    if (container && (container.innerHTML.trim() === '<!-- Pilihan olahraga kardio dimuat di sini -->' || 
                      container.innerHTML.trim() === '')) {
        console.log(`üîÑ Generating workout form for day ${hariKe} on demand`);
        container.innerHTML = createWorkoutFormHTML(hariKe);
    }
    
    // 2. Tampilkan submenu
    showSubmenu(`workoutContent${hariKe}`);
    
    // 3. Setup event listeners (DENGAN FUNGSI YANG BENAR)
    setupWorkoutEventListeners(hariKe);
    
    // 4. Setup resistance
    setupResistanceExercises(hariKe);
    
    console.log(`‚úÖ Workout form for day ${hariKe} is ready`);
}

/************************************************
 * SETUP WORKOUT EVENT LISTENERS - FINAL VERSION
 ************************************************/
function setupWorkoutEventListeners(hariKe) {
  console.log(`üîß Setting up workout event listeners for day ${hariKe}`);

  // TOMBOL SIMPAN
  const btnSimpan = document.getElementById(`btnSimpanWorkout${hariKe}`);
  if (btnSimpan) {
    const newBtnSimpan = btnSimpan.cloneNode(true);
    btnSimpan.parentNode.replaceChild(newBtnSimpan, btnSimpan);

    newBtnSimpan.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();

      console.log(`üíæ Tombol Simpan diklik hari ${hariKe}`);
      const success = await simpanWorkoutData(hariKe);

      if (success) {
        const btnSelesai = document.getElementById(`btnSelesaiWorkout${hariKe}`);
        if (btnSelesai) btnSelesai.disabled = false;
      }
    });
  }

  // TOMBOL SELESAI (FINAL)
  const btnSelesai = document.getElementById(`btnSelesaiWorkout${hariKe}`);
  if (btnSelesai) {
    btnSelesai.disabled = true;

    const newBtnSelesai = btnSelesai.cloneNode(true);
    btnSelesai.parentNode.replaceChild(newBtnSelesai, btnSelesai);

    newBtnSelesai.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();

      console.log(`üèÅ Menyelesaikan workout hari ${hariKe}`);

      const userId = localStorage.getItem('userId');
      if (!userId) {
        showMessage('error', 'Silakan login terlebih dahulu', 3000);
        return;
      }

      try {
        const response = await fetch(URL_PROGRAM_APP, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            action: 'completeWorkout',
            userId: userId,
            hariKe: hariKe
          })
        });

        const result = await response.json();
        console.log('üì• Complete workout response:', result);

        if (result.success === true) {
          // üîí LOCK UI
          disableWorkoutUI(hariKe);

          // ‚úÖ CENTANG HIJAU
          updateSubmenuLinkUI('workout', hariKe);

          // ‚úÖ GLOBAL PROGRESS
          if (window.userProgress) {
            window.userProgress[`workoutHari${hariKe}`] = true;
          }

          showMessage('success', 'Workout berhasil diselesaikan', 3000);
        } else {
          showMessage('error', result.message || 'Gagal menyelesaikan workout', 3000);
        }

      } catch (err) {
        console.error(err);
        showMessage('error', 'Gagal terhubung ke server', 3000);
      }
    });
  }

  console.log(`‚úÖ Workout listeners ready for day ${hariKe}`);
}

/*******************************
* Upload file kardio olahraga  *
********************************/
async function uploadKardioFile(hariKe) {
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) throw new Error('User belum login');

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const base64Data = reader.result.split(',')[1];

        console.log('üì∏ Kardio file siap disimpan (base64)');

        // Simpan sementara (SEPERTI MEALPLAN)
        localStorage.setItem(`kardioFile_${hariKe}`, base64Data);
        localStorage.setItem(`kardioFilename_${hariKe}`, file.name);

        // Update UI saja (BELUM KIRIM SERVER)
        document.getElementById(`kegiatanKardio${hariKe}`).value = file.name;
      };

      reader.readAsDataURL(file);
    };

    input.click();
  } catch (err) {
    console.error('‚ùå Upload kardio gagal:', err);
    // alert(err.message);
    showMessage('error', err.message, 3000);
  }
}


/****************************************
* Helper: Konversi jenis kardio ke kode *
*****************************************/
function getKardioCode(kardioType) {
    const kardioMapping = {
        'Lari': 'Lari',
        'Sepeda': 'Sepeda',
        'Renang': 'Renang',
        'Aerobic': 'Aerobic',
        'Zumba': 'Zumba',
        'Jalan Cepat': 'JalanCepat'
    };
    
    return kardioMapping[kardioType] || kardioType.replace(/\s+/g, '');
}

/*********************************
* Set waktu mulai olahraga kardio *
**********************************/
function setStartTimeKardio(hariKe) {
    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0].substring(0, 5); // Format HH:mm
    
    const inputField = document.getElementById(`startOlahraga${hariKe}`);
    if (inputField) {
        inputField.value = timeString;
        
        // Simpan di localStorage
        localStorage.setItem(`workout_start_time_${hariKe}`, timeString);
        
        showMessage('info', `Waktu mulai: ${timeString}`, 2000, `pertemuan${hariKe}`);
    }
}

/**********************************
* Set waktu selesai olahraga kardio *
***********************************/
function setStopTimeKardio(hariKe) {
    const now = new Date();
    const timeString = now.toTimeString().split(' ')[0].substring(0, 5); // Format HH:mm
    
    const inputField = document.getElementById(`stopOlahraga${hariKe}`);
    if (inputField) {
        inputField.value = timeString;
        
        // Simpan di localStorage
        localStorage.setItem(`workout_stop_time_${hariKe}`, timeString);
        
        showMessage('info', `Waktu selesai: ${timeString}`, 2000, `pertemuan${hariKe}`);
    }
}

/*****************************************
 * SIMPAN WORKOUT DATA - FINAL VALIDATED
 *****************************************/
/*****************************************
 * SIMPAN WORKOUT DATA - FINAL FIXED
 *****************************************/
async function simpanWorkoutData(hariKe) {
  console.log(`üíæ Tombol Simpan diklik hari ${hariKe}`);

  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');

  if (!userId) {
    showMessage('error', 'Silakan login terlebih dahulu', 3000, `pertemuan${hariKe}`);
    return false;
  }

  // ================================
  // üîé AMBIL INPUT KARDIO
  // ================================
  const kardioType = document.getElementById(`kardioType${hariKe}`)?.value?.trim() || '';
  const startTime  = document.getElementById(`startTime${hariKe}`)?.value?.trim() || '';
  const stopTime   = document.getElementById(`stopTime${hariKe}`)?.value?.trim() || '';

  const kardioLengkap =
    kardioType !== '' &&
    startTime !== '' &&
    stopTime !== '';

  // ================================
  // üîé CEK RESISTANCE (VERSI AMAN)
  // ================================
  let resistanceRaw = localStorage.getItem(`resistanceHari${hariKe}`);
  let adaResistance = false;
  let resistanceData = [];

  if (resistanceRaw) {
    try {
      const parsed = JSON.parse(resistanceRaw);

      if (Array.isArray(parsed)) {
        adaResistance = parsed.length > 0;
        resistanceData = parsed;
      } else if (typeof parsed === 'object' && parsed !== null) {
        adaResistance = Object.keys(parsed).length > 0;
        resistanceData = Object.values(parsed);
      }

    } catch (e) {
      adaResistance = false;
    }
  }

  // ================================
  // üö® VALIDASI UTAMA
  // ================================
  if (!kardioLengkap && !adaResistance) {
    showMessage(
      'warning',
      'Input terlebih dahulu Jenis workoutnya',
      3000,
      `pertemuan${hariKe}`
    );
    return false;
  }

  // ================================
  // ‚è± HITUNG TOTAL RESISTANCE
  // ================================
  let totalSets = 0;
  let totalReps = 0;
  let totalMinutes = 0;

  resistanceData.forEach(item => {
    totalSets += parseInt(item.set || 0);
    totalReps += parseInt(item.repetisi || 0);
    totalMinutes += parseInt(item.durasi || 0);
  });

  // ================================
  // üì¶ BUILD PAYLOAD
  // ================================
  const workoutData = {
    kardioType,
    startTime,
    stopTime,
    resistenExercises: JSON.stringify(resistanceData),
    totalSets,
    totalReps,
    totalMinutes
  };

  try {
    const response = await fetch(URL_PROGRAM_APP, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams({
        action: 'updateWorkout',
        userId,
        userName,
        hariKe,
        workoutData: JSON.stringify(workoutData)
      })
    });

    const result = await response.json();
    console.log('üì• Response dari server:', result);

    if (result.success === true) {
      localStorage.setItem(`workoutSavedHari${hariKe}`, 'true');

      const btnSelesai = document.getElementById(`btnSelesaiWorkout${hariKe}`);
      if (btnSelesai) btnSelesai.disabled = false;

      showMessage('success', 'Workout berhasil disimpan', 3000, `pertemuan${hariKe}`);
      return true;
    } else {
      showMessage('error', result.message || 'Gagal menyimpan workout', 3000, `pertemuan${hariKe}`);
      return false;
    }

  } catch (err) {
    console.error('‚ùå Error simpan workout:', err);
    showMessage('error', 'Terjadi kesalahan koneksi', 3000, `pertemuan${hariKe}`);
    return false;
  }
}

 async function BACKUP_simpanWorkoutData(hariKe) {
  console.log(`üíæ Tombol Simpan diklik hari ${hariKe}`);

  const userId   = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');

  if (!userId) {
    showMessage('error', 'Silakan login terlebih dahulu', 3000, `pertemuan${hariKe}`);
    return false;
  }
  // üîé Validasi Input Workout
  const kardioType  = document.getElementById(`kardioType${hariKe}`)?.value || '';
  const startTime   = document.getElementById(`startTime${hariKe}`)?.value || '';
  const stopTime    = document.getElementById(`stopTime${hariKe}`)?.value || '';
  const resistanceContainer = document.getElementById(`resistanceContainer${hariKe}`);
  const resistanceItems     = resistanceContainer ? resistanceContainer.querySelectorAll('.resistance-item') : [];
  const adaKardio           = kardioType !== '' && startTime !== '' && stopTime !== '';
  const adaResistance       = resistanceItems.length > 0;

  // ‚ùå Jika dua-duanya kosong
  if (!adaKardio && !adaResistance) {
    showMessage( 'warning', 'Input terlebih dahulu jenis workoutnya', 3000, `pertemuan${hariKe}`);
    return false;
  }

  // ‚ùå Jika kardio dipilih tapi pilihan upload kegiatan dan jam kosong
  if (kardioType !== '' && (startTime === '' || stopTime === '')) {
    showMessage( 'warning', 'Lengkapi upload, waktu mulai dan selesai olahraga kardio', 3000, `pertemuan${hariKe}` );
    return false;
  }

  // ‚úÖ Proses Simpan ke Server
  try {
    const workoutData = { kardioType, startTime, stopTime };
    const response    = await fetch(URL_PROGRAM_APP, {
      method: 'POST', 
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      body: new URLSearchParams({
        action: 'updateWorkout',
        userId,
        userName,
        hariKe,
        workoutData: JSON.stringify(workoutData)
      })
    });

    const result = await response.json();
    console.log('üì• Response dari server:', result);

    if (result.success === true) {
      localStorage.setItem(`workoutSavedHari${hariKe}`, 'true');
      const btnSelesai = document.getElementById(`btnSelesaiWorkout${hariKe}`);
      if (btnSelesai) btnSelesai.disabled = false;
        showMessage( 'success', 'Data workout berhasil disimpan', 3000, `pertemuan${hariKe}` );
      return true;
    } else {
        showMessage( 'error', result.message || 'Gagal menyimpan workout', 3000, `pertemuan${hariKe}` );
      return false;
    }

  } catch (err) {
    console.error('‚ùå Error simpan workout:', err);
    showMessage( 'error', 'Terjadi kesalahan koneksi', 3000, `pertemuan${hariKe}` );
    return false;
  }
}

function ambilDataWorkoutHari(hariKe) {
    console.log(`üìä Ambil data workout hari ${hariKe}`);

    const kardioType = document.getElementById(`olahragaKardio${hariKe}`)?.value || '';
    const startTime  = document.getElementById(`startOlahraga${hariKe}`)?.value || '';
    const stopTime   = document.getElementById(`stopOlahraga${hariKe}`)?.value || '';
    const kardioFile = window.kardioFileUrlByDay?.[hariKe] || '';
    const kardioFilename = extractFileNameFromDriveUrl(kardioFile, hariKe);

    // === RESISTANCE ===
    const exercises  =  window.selectedResistanceExercises?.[hariKe] || [];
    let totalSets    = 0;
    let totalReps    = 0;
    let totalMinutes = 0;
    const exerciseNames = [];

    exercises.forEach(ex => {
        totalSets += Number(ex.set || 0);
        totalReps += Number(ex.repetisi || 0);
        totalMinutes += Number(ex.durasi || 0);
        exerciseNames.push(ex.name);
    });

    return {
        kardioType,
        kardioFile,
        kardioFilename,
        startTime,
        stopTime,

        resistenExercises: exerciseNames.join(', '),
        totalSets,
        totalReps,
        totalMinutes
    };
}

function disableWorkoutUI(hariKe) {
  const container = document.getElementById(`workoutContent${hariKe}`);
  if (!container) return;

  container.querySelectorAll('input, select, textarea, button').forEach(el => {
    if (
      el.classList.contains('btn-close-header') ||
      el.id === 'btnCekDisiniWorkout'
    ) return;

    el.disabled = true;
    el.style.pointerEvents = 'none';
  });

  console.log(`üîí Workout UI hari ${hariKe} dikunci total`);
}

function tandaiWorkoutSelesai(hariKe) {
  const btn = document.querySelector(
    `.submenu-trigger[data-target="workoutContent${hariKe}"]`
  );

  if (!btn) return;

  if (!btn.querySelector('.status-done')) {
    const icon = document.createElement('span');
    icon.className = 'status-done ms-2';
    icon.innerHTML = 'üü¢';
    btn.appendChild(icon);
  }

  console.log(`‚úÖ Submenu Workout hari ${hariKe} ditandai selesai`);
}


/************************
* Simpan status workout *
*************************/
function saveWorkoutStatus(hariKe, status) {
  const userId = localStorage.getItem('userId');
  if (!userId) return;
  
  localStorage.setItem(`workout_status_${userId}_${hariKe}`, status);
  
  if (status === 'completed') {
    localStorage.setItem(`workout_completed_${userId}_${hariKe}`, new Date().toISOString());
    
    // Update UI
    updateWorkoutCompletionUI(hariKe);
    
    // Disable semua tombol
    disableButtonsAfterCompletion(hariKe, 'workout');
    
    // Update submenu link
    updateSubmenuLinkUI(hariKe, 'workout');
    
    // Simpan ke user progress data
    const progressKey = `completeProgress_${userId}`;
    let progressData = JSON.parse(localStorage.getItem(progressKey) || '{}');
    
    if (progressData.success) {
      progressData.workoutHari1 = true;
      localStorage.setItem(progressKey, JSON.stringify(progressData));
    }
  }
}

function updateProgressIcon(module, hariKe) {
  // Update icon centang di menu
  const moduleItem = document.getElementById(`${module}ReminderItem`) ||
                    document.getElementById(`${module}-hari-${hariKe}`);
  if (moduleItem) {
    // Hapus badge lama jika ada
    const oldBadge = moduleItem.querySelector('.badge');
    if (oldBadge) oldBadge.remove();
    
    // Tambah badge baru
    const newBadge = document.createElement('span');
    newBadge.className = 'badge bg-success';
    newBadge.innerHTML = '<i class="fas fa-check"></i>';
    moduleItem.appendChild(newBadge);
  }
}

/********************************************
* Fungsi untuk cek status saat load halaman
*********************************************/
function cekStatusWaterReminder() {
  const hariKe = 1;
  const status = localStorage.getItem('waterReminder_hari_' + hariKe);
  
  if (status === 'completed') {
    // Nonaktifkan tombol
    document.getElementById('btnSimpan').disabled = true;
    document.getElementById('btnSimpan').innerHTML = '<i class="fas fa-check"></i> Simpan';
    document.getElementById('btnSelesai').disabled = true;
    document.getElementById('btnSelesai').innerHTML = '<i class="fas fa-check"></i> Selesai Water';
    
    // Tampilkan centang
    const waterItem = document.getElementById('waterReminderItem');
    if (waterItem) {
      waterItem.innerHTML += ' <span class="badge bg-success"><i class="fas fa-check"></i></span>';
    }
  }
  
  // Tampilkan data asupan air yang sudah disimpan
  const asupanAir = localStorage.getItem('asupanAir_hari_' + hariKe);
  if (asupanAir) {
    const radioBtn = document.querySelector('input[value="' + asupanAir + '"]');
    if (radioBtn) {
      radioBtn.checked = true;
    }
  }
}

/******************************************
* Selesaikan Istirahat dan disable tombol *
*******************************************/
async function selesaiIstirahat(hariKe) {
    // Simpan status
    localStorage.setItem(`istirahat_status_${hariKe}`, 'completed');
    localStorage.setItem(`istirahat_completed_${hariKe}`, new Date().toISOString());
    
    // Disable tombol
    disableButtonsAfterCompletion(hariKe, 'istirahat');
    
    // Update UI
    const istirahatItem = document.querySelector(`[onclick="istirahat(${hariKe})"]`);
    if (istirahatItem) {
        istirahatItem.innerHTML = `<i class="fas fa-bed"></i>${hariKe}.5 Waktu Istirahat - Hari ke ${hariKe} ‚úì`;
        istirahatItem.style.color = '#666666';
        // istirahatItem.style.fontWeight = 'bold';
    }
    showMessage('success', `Istirahat hari ${hariKe} selesai!`, 3000, `pertemuan${hariKe}`);
}

/**********************************************
* Selesaikan Data Tracking dan disable tombol *
***********************************************/
async function selesaiDataTracking(hariKe) {
    // Simpan status
    localStorage.setItem(`datatracking_status_${hariKe}`, 'completed');
    localStorage.setItem(`datatracking_completed_${hariKe}`, new Date().toISOString());
    
    // Disable tombol
    disableButtonsAfterCompletion(hariKe, 'datatracking');
    // Update UI
    const trackingItem = document.querySelector(`[onclick="dataTracking(${hariKe})"]`);
    if (trackingItem) {
        trackingItem.innerHTML = `<i class="fas fa-user-friends"></i>${hariKe}.6 Data Tracking - Hari ke ${hariKe} ‚úì`;
        trackingItem.style.color = '#666666';
        // trackingItem.style.fontWeight = 'bold';
    }
    showMessage('success', `Data Tracking hari ${hariKe} selesai!`, 3000, `pertemuan${hariKe}`);
}

/*************************************************
* Tampilkan form dengan pengecekan status tombol *
**************************************************/
function showSubmenuWithStatus(targetId, hariKe, submenuType) {
    // Tampilkan submenu seperti biasa
    showSubmenu(targetId);
    
    // Check dan apply button status
    setTimeout(() => {
        checkAndApplyButtonStatus(hariKe);
        
        // Untuk mealplan, juga check upload status
        if (submenuType === 'mealplan') {
            loadMealPlanProgress(hariKe);
        }
        
        // Untuk workout, juga check resistance data
        if (submenuType === 'workout') {
            loadSavedResistanceData(hariKe);
        }
    }, 500);
}

/************************************
* Update UI setelah workout selesai *
*************************************/
function updateWorkoutCompletionUI(hariKe) {
  const submenu = document.querySelector(
    `.submenu-trigger[data-target="workoutContent${hariKe}"]`
  );

  if (!submenu) {
    console.warn('Submenu workout tidak ditemukan');
    return;
  }

  if (!submenu.querySelector('.status-done')) {
    const icon = document.createElement('i');
    icon.className = 'fas fa-check-circle status-done';
    icon.style.color = 'green';
    icon.style.marginLeft = '6px';
    submenu.appendChild(icon);
  }

  console.log(`‚úÖ Icon centang workout hari ${hariKe} ditambahkan`);
}

/**************************
* Load saved workout data *
***************************/
function loadSavedWorkoutData(hariKe) {
    console.log(`üìÇ Loading saved workout data for day ${hariKe}`);
    
    // Load kardio type
    const kardioType = localStorage.getItem(`workout_kardio_type_${hariKe}`);
    const kardioSelect = document.getElementById(`olahragaKardio${hariKe}`);
    if (kardioType && kardioSelect) {
        kardioSelect.value = kardioType;
        // kardioSelect.style.cursor = 'pointer';
    }
    
    // Load kardio filename
    const kardioFilename = localStorage.getItem(`workout_kardio_filename_${hariKe}`);
    const kardioInput = document.getElementById(`kegiatanKardio${hariKe}`);
    if (kardioFilename && kardioInput) {
        kardioInput.value = `‚úì ${kardioFilename}`;
    }
    
    // Load start time
    const startTime = localStorage.getItem(`workout_start_time_${hariKe}`);
    const startInput = document.getElementById(`startOlahraga${hariKe}`);
    if (startTime && startInput) {
        startInput.value = startTime;
    }
    
    // Load stop time
    const stopTime = localStorage.getItem(`workout_stop_time_${hariKe}`);
    const stopInput = document.getElementById(`stopOlahraga${hariKe}`);
    if (stopTime && stopInput) {
        stopInput.value = stopTime;
    }
    
    // Check if already completed
    const status = localStorage.getItem(`workout_status_${hariKe}`);
    if (status === 'completed') {
        updateWorkoutCompletionUI(hariKe);
    }
}

/************************************************
 * SETUP WORKOUT FOR DAY - FIXED
 * Inisialisasi semua event listener untuk workout
 ************************************************/
function setupWorkoutForDay(hariKe) {
  console.log(`üîß Setup workout untuk hari ${hariKe}`);

  // 1Ô∏è‚É£ Event listener utama workout (simpan & selesai)
  setupWorkoutEventListeners(hariKe);

  // 2Ô∏è‚É£ Setup resistance exercises
  setupResistanceExercises(hariKe);
 
  /* NON AKTIFKAN 
  // 3Ô∏è‚É£ Tombol Simpan (aman walau dipanggil ulang)
  const btnSimpan = document.getElementById(`btnSimpanWorkout${hariKe}`);
  if (btnSimpan) {
    btnSimpan.onclick = function (e) {
      e.preventDefault();
      console.log(`üíæ Tombol Simpan diklik untuk hari ${hariKe}`);
      simpanWorkoutData(hariKe);
      btnSimpan.disabled = true;   // DISABLED SETELAH TERSIMPAN
    };
  }

  // 4Ô∏è‚É£ Tombol Selesai ‚Üí WAJIB pakai selesaiWorkout (FETCH)
  const btnSelesai = document.getElementById(`btnSelesaiWorkout${hariKe}`);
  if (btnSelesai) {
    btnSelesai.disabled = true;
    btnSelesai.onclick = function (e) {
      e.preventDefault();
      console.log(`üèÅ Tombol Selesai diklik untuk hari ${hariKe}`);
      selesaiWorkout(hariKe); // ‚úÖ SATU-SATUNYA FUNGSI
    };
  }
  */  

  // 5Ô∏è‚É£ Restore data jika user lama
  loadSavedWorkoutData(hariKe);
}

/************************************************
 * INITIALIZE ALL WORKOUT DAYS - FIXED (Focus on day 1)
 ************************************************/
function initializeAllWorkoutDays() {
    console.log('üîß Initializing workout days (focus on day 1)...');
    
    // Hanya fokus pada hari 1 dulu
    const hariKe = 1;
    
    // 1. Debug dulu untuk melihat apa yang ada
    generateWorkoutForms(); // Fungsi debugging
    
    // 2. Setup event listeners untuk hari 1
    setupWorkoutEventListeners(hariKe);
    
    // 3. Setup resistance (jika ada)
    setupResistanceExercises(hariKe);
    
    // 4. Cek jika sudah selesai
    if (localStorage.getItem(`workoutHari${hariKe}`) === 'completed') {
        console.log(`üìä Workout hari ${hariKe} sudah selesai`);
        disableWorkoutUI(hariKe);
        updateSubmenuLinkUI('workout', hariKe);
    }
    
    console.log('‚úÖ Workout initialization complete for day 1');
}

/*******************************************
 * CREATE WORKOUT FORM HTML - FINAL FIX
 *******************************************/
function createWorkoutFormHTML(hariKe) {
    return `
        <!-- Pilih Jenis Olahraga Kardio -->
        <div class="mt-3 mb-2">
            <h6>Olahraga Kardio :</h6>
            <div class="input-group mb-3">
                <div class="input-group-text">
                    <i class="fas fa-running"></i>
                </div>
                <select class="form-select" id="olahragaKardio${hariKe}">
                    <option value="">Pilih Jenis Olahraga...</option>
                    <option value="Lari">Lari</option>
                    <option value="Sepeda">Sepeda</option>
                    <option value="Renang">Renang</option>
                    <option value="Aerobic">Aerobic</option>
                    <option value="Zumba">Zumba</option>
                    <option value="Jalan Cepat">Jalan Cepat</option>
                </select>
            </div>
        </div>

        <!-- Upload Kardio -->
        <div class="input-group mb-3">
            <div class="input-group-text">
              <i class="fas fa-file-upload"></i>
            </div>
            <input class="form-control" type="text" id="kegiatanKardio${hariKe}" placeholder="Kegiatan Olahraga" readonly>
            <button type="button" class="btn btn-outline-secondary btn-sm"
              onclick="uploadKardioFile(${hariKe})">Upload
            </button>
        </div>

        <!-- Waktu Start -->
        <div class="input-group mb-3">
            <div class="input-group-text">
              <i class="fas fa-play"></i>
            </div>
            <input class="form-control" type="time" id="startOlahraga${hariKe}" disabled>
            <button type="button" class="btn btn-outline-primary btn-sm"
              onclick="setStartTimeKardio(${hariKe})">¬†¬†Start¬†¬†
            </button>
        </div>

        <!-- Waktu Stop -->
        <div class="input-group mb-3">
            <div class="input-group-text">
              <i class="fas fa-stop"></i>
            </div>
            <input class="form-control" type="time" id="stopOlahraga${hariKe}" disabled>
            <button type="button" class="btn btn-outline-danger btn-sm"
              onclick="setStopTimeKardio(${hariKe})">¬†¬†Stop¬†¬†
            </button>
        </div>

        <!-- ================= RESISTANCE ================= -->
        <div class="mt-4">
            <h6>Olahraga Resistance :</h6>

            <!-- üîë DATA RESISTANCE (WAJIB ADA) -->
            <input type="hidden" id="resistenExercises${hariKe}">
            <input type="hidden" id="totalSets${hariKe}">
            <input type="hidden" id="totalReps${hariKe}">
            <input type="hidden" id="totalMinutes${hariKe}">

            <button type="button" class="btn btn-outline-primary btn-sm mb-2"
                onclick="showResistanceModal(${hariKe})"> Tambah Resistance
            </button>
            <div id="selectedResistanceContainer${hariKe}"></div>
        </div>

        <!-- Tombol -->
        <div class="mt-4">
            <button type="button" class="btn btn-primary btn-sm" id="btnSimpanWorkout${hariKe}">
              <i class="fa fa-pencil-square-o"></i> Simpan
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="btnSelesaiWorkout${hariKe}" disabled>
              <i class="fas fa-check"></i> Selesai Workout
            </button>
        </div>
    `;
}

/*******************************************
 * GENERATE WORKOUT FORMS - FIXED SIMPLE
 *******************************************/
function generateWorkoutForms() {
    console.log('üîß Generating workout forms for all days...');
    
    for (let hariKe = 1; hariKe <= 10; hariKe++) {
        // Container ID: untuk hari 1 -> "olahragaKardio-list", untuk hari >1 -> "olahragaKardio-list2", dst
        const containerId = hariKe === 1 ? 'olahragaKardio-list' : `olahragaKardio-list${hariKe}`;
        const container = document.getElementById(containerId);
        
        if (container) {
            // Hanya generate jika container masih kosong (hanya komentar)
            const currentContent = container.innerHTML.trim();
            if (currentContent === '<!-- Pilihan olahraga kardio dimuat di sini -->' || 
                currentContent === '') {
                
                console.log(`üîÑ Generating workout form for day ${hariKe}`);
                container.innerHTML = createWorkoutFormHTML(hariKe);
                
                // Juga generate untuk resistance container
                const resistanceContainerId = hariKe === 1 ? 'olahragaResisten-list' : `olahragaResisten-list${hariKe}`;
                const resistanceContainer = document.getElementById(resistanceContainerId);
                if (resistanceContainer) {
                    resistanceContainer.innerHTML = '<!-- Resistance exercises akan muncul di sini -->';
                }
            } else {
                console.log(`‚úÖ Workout form for day ${hariKe} already populated`);
            }
        } else {
            console.log(`‚ö†Ô∏è Container ${containerId} not found for day ${hariKe}`);
        }
    }
}

/*******************************************
 * SHOW RESISTANCE MODAL - Jika belum ada
 *******************************************/
function showResistanceModal(hariKe) {
    // Buat modal sederhana untuk memilih exercise
    const exerciseTypes = [
        'Push Up', 'Sit Up', 'Squat', 'Plank', 
        'Pull Up', 'Lunges', 'Bench Press', 'Deadlift'
    ];
    
    let optionsHTML = '';
    exerciseTypes.forEach(exercise => {
        optionsHTML += `<option value="${exercise}">${exercise}</option>`;
    });
    
    const modalHTML = `
        <div class="modal fade" id="resistanceModal${hariKe}" tabindex="-1">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Pilih Resistance Exercise</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select class="form-select" id="selectExercise${hariKe}">
                            <option value="">Pilih exercise...</option>
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary" onclick="addSelectedExercise(${hariKe})">Tambah</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Tambahkan modal ke body jika belum ada
    if (!document.getElementById(`resistanceModal${hariKe}`)) {
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById(`resistanceModal${hariKe}`));
    modal.show();
}

/*******************************************
 * ADD SELECTED EXERCISE - FINAL FIX
 *******************************************/
function addSelectedExercise(hariKe) {
    const selectElement = document.getElementById(`selectExercise${hariKe}`);
    const exerciseName = selectElement.value;

    if (!exerciseName) {
        //alert('Pilih exercise terlebih dahulu!');
        showMessage('warning', 'Pilih exercise terlebih dahulu', 3000);
        return;
    }

    // Tutup modal
    const modalEl = document.getElementById(`resistanceModal${hariKe}`);
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    // Tambah ke UI (pakai fungsi yang SUDAH ADA)
    if (typeof addResistanceExercise === 'function') {
        addResistanceExercise(hariKe, exerciseName, false);
    }

    // ============================
    // üîë SIMPAN KE FORM (INI KUNCI)
    // ============================
    const resistenInput = document.getElementById(`resistenExercises${hariKe}`);

    let current = resistenInput.value
        ? resistenInput.value.split(',')
        : [];

    current.push(exerciseName);
    resistenInput.value = current.join(',');
}

/*******************************************
 * SETUP RESISTANCE EXERCISES - FIXED FINAL
 *******************************************/
function setupResistanceExercises(hariKe) {
    console.log(`üèãÔ∏è Setup resistance exercises hari ${hariKe}`);
    
    const resistanceContainer = document.getElementById(`selectedResistanceContainer${hariKe}`);
    if (!resistanceContainer) {
        console.log(`‚ÑπÔ∏è Resistance container not found, will be created when needed`);
        return;
    }
    
    console.log(`‚úÖ Resistance container ready for day ${hariKe}`);
}
 
function isWorkoutCompleted(hariKe) {
    // Prioritas 1: data dari server
    if (window.userProgress && window.userProgress[`workoutHari${hariKe}`] === true) {
        return true;
    }
    // Prioritas 2: localStorage fallback
    const localStatus = localStorage.getItem(`workoutHari${hariKe}`);
    return localStatus === 'completed';
}

/********************************************************
* Apply Read-Only Mode untuk Workout yang Sudah Selesai *
*********************************************************/
function applyWorkoutReadOnlyMode(hariKe) {
  // ‚úÖ USER BARU ‚Üí STOP
  if (!window.userProgress || !window.userProgress[`workoutHari${hariKe}`]) {
    console.log(`üü¢ applyWorkoutReadOnlyMode SKIP (USER BARU) hari ${hariKe}`);
    return;
  }

  console.log(`üîí Apply READ ONLY workout hari ${hariKe}`);

  disableWorkoutUI(hariKe);

  // ‚úÖ X & Cek Disini TETAP AKTIF
  enableCloseAndCekDisini(`workoutContent${hariKe}`);
}

/************************************************
 * DISABLE WORKOUT UI - FIXED
 * Nonaktifkan semua input kecuali Cek Disini dan X
 ************************************************/
function disableWorkoutUI(hariKe) {
    console.log(`üîí Disabling workout UI hari ${hariKe}`);
    
    const container = document.getElementById(`workoutContent${hariKe}`);
    if (!container) return;
    
    // 1Ô∏è‚É£ DISABLE SEMUA INPUT
    container.querySelectorAll('input, select, textarea').forEach(input => {
        const inputId = input.id || '';
        
        // ‚ùó JANGAN DISABLE JIKA INI ADALAH TOMBOL CEK DISINI
        if (!inputId.includes('CekDisini')) {
            input.disabled = true;
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
            input.style.cursor = 'not-allowed';
        }
    });
    
    // 2Ô∏è‚É£ DISABLE SEMUA TOMBOL (KECUALI CEK DISINI DAN X)
    container.querySelectorAll('button').forEach(button => {
        const buttonId = button.id || '';
        const buttonText = button.textContent || '';
        const buttonClass = button.className || '';
        
        // ‚ùó TOMBOL "CLOSE/X" TETAP ENABLED
        if (buttonClass.includes('btn-close') || 
            buttonClass.includes('close-pdf') || 
            buttonClass.includes('close-video') ||
            button.innerHTML.includes('fa-times')) {
            button.disabled = false;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            return;
        }
        
        // ‚ùó TOMBOL "CEK DISINI" TETAP ENABLED
        if (buttonId.includes('CekDisini') || 
            buttonText.includes('Cek Disini')) {
            button.disabled = false;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-primary');
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            button.title = 'Lihat PDF';
            return;
        }
        
        // ‚õî LAINNYA ‚Üí DISABLE
        button.disabled = true;
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
        button.title = 'Workout selesai';
    });
    
    console.log(`‚úÖ Workout UI hari ${hariKe} berhasil di-disable`);
}

/************************************
* Fungsi Tambah Olahraga Resistance *
*************************************/
function addResistanceExercise(hariKe, exerciseName, fromRestore = false) {
    console.log(`‚ûï Adding resistance exercise for day ${hariKe}: ${exerciseName} | restore=${fromRestore}`);
    
    const containerId = `selectedResistanceContainer${hariKe}`;
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`‚ùå Resistance container not found: ${containerId}`);
        return;
    }
    
    const exerciseId = exerciseName.toLowerCase().replace(/\s+/g, '-');
    const fullExerciseId = `resistance-${hariKe}-${exerciseId}`;

    // ‚õî CEK DUPLIKASI ‚Äî WAJIB DI AWAL (SEBELUM APPEND)
    if (document.getElementById(fullExerciseId)) {
        // ‚ùó WARNING HANYA JIKA USER ACTION
        if (!fromRestore) {
            showMessage('warning', 'Olahraga ini sudah terpilih', 3000, `pertemuan${hariKe}`);
        }
        return; // STOP TOTAL
    }

    // ‚úÖ BUAT ELEMENT (AMAN, TIDAK DUPLIKAT)
    const exerciseElement = document.createElement("div");
    exerciseElement.id = fullExerciseId;
    exerciseElement.className = "resistance-exercise-item card mb-3";
    exerciseElement.innerHTML = `  
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title mb-0 text-primary">${exerciseName}</h6>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeResistanceExercise(${hariKe}, '${exerciseId}')"
                            data-bs-toggle="tooltip" title="Hapus"> 
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="row g-2">
                <div class="col-12 col-md-4">
                    <div class="input-group input-group-sm">	
                        <span class="input-group-text"><i class="fas fa-user-cog"></i></span>
                        <input type="number" min="0"
                               id="jmlSet-${hariKe}-${exerciseId}"
                               class="form-control"
                               placeholder="Jumlah set"
                               data-exercise="${exerciseId}"
                               data-hari="${hariKe}"
                               data-type="set">
                    </div>
                </div>

                <div class="col-12 col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-user-plus"></i></span>
                        <input type="number" min="0"
                               id="jmlRepetisi-${hariKe}-${exerciseId}"
                               class="form-control"
                               placeholder="Jumlah Repetisi"
                               data-exercise="${exerciseId}"
                               data-hari="${hariKe}"
                               data-type="repetisi">
                    </div>
                </div>

                <div class="col-12 col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-user-clock"></i></span>
                        <input type="number" min="0"
                               id="jmlDurasi-${hariKe}-${exerciseId}"
                               class="form-control"
                               placeholder="Durasi (Menit)"
                               data-exercise="${exerciseId}"
                               data-hari="${hariKe}"
                               data-type="durasi">
                    </div>
                </div>
            </div>
        </div>
    `;

    container.appendChild(exerciseElement);

    // üíæ AUTO SAVE (TIDAK DIUBAH)
    exerciseElement
        .querySelectorAll('input[type="number"]')
        .forEach(input => {
            input.addEventListener('change', function () {
                const exId  = this.dataset.exercise;
                const hKe   = this.dataset.hari;
                saveResistanceData(hKe, exId);
            });
        });

    console.log(`‚úÖ Added resistance exercise: ${exerciseName} for day ${hariKe}`);
}

/**********************************************
* Fungsi Hapus Olahraga Resistance (per hari)
**********************************************/
function removeResistanceExercise(hariKe, exerciseId) {
    const fullExerciseId = `resistance-${hariKe}-${exerciseId}`;
    const exerciseElement = document.getElementById(fullExerciseId);
    if (exerciseElement) {
        exerciseElement.remove();
        showMessage('warning', 'Pilihan olahraga Resistance dihapus', 3000, `pertemuan${hariKe}`);
        
        // Hapus dari localStorage
        localStorage.removeItem(`resistance-${hariKe}-${exerciseId}`);
    }
}

/*******************************************
* Fungsi Simpan Data Resistance (per hari)
********************************************/
function saveResistanceData(hariKe, exerciseId) {
    const setValue      = document.getElementById(`jmlSet-${hariKe}-${exerciseId}`)?.value;
    const repetisiValue = document.getElementById(`jmlRepetisi-${hariKe}-${exerciseId}`)?.value;
    const durasiValue   = document.getElementById(`jmlDurasi-${hariKe}-${exerciseId}`)?.value;

    const exerciseElement = document.getElementById(`resistance-${hariKe}-${exerciseId}`);
    const exerciseName    = exerciseElement?.querySelector('.card-title')?.textContent || exerciseId.replace(/-/g, ' ');

    const exerciseData = {
        name: exerciseName,
        set: setValue || 0,
        repetisi: repetisiValue || 0,
        durasi: durasiValue || 0,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem( `resistance-${hariKe}-${exerciseId}`, JSON.stringify(exerciseData) );
    console.log(  `üíæ Saved resistance data for day ${hariKe}, exercise ${exerciseId}:`,exerciseData);
}

/*******************************************************
* Fungsi Load Data Resistance yang Tersimpan (per hari)
********************************************************/
function loadSavedResistanceData(hariKe) {
    // Get all resistance keys for this day
    const allKeys = Object.keys(localStorage);
    const resistanceKeys = allKeys.filter(key => key.startsWith(`resistance-${hariKe}-`));
    
    console.log(`üìÇ Loading saved resistance data for day ${hariKe}:`, resistanceKeys);
    
    resistanceKeys.forEach(key => {
        try {
            const savedData = JSON.parse(localStorage.getItem(key));
            if (savedData) {
                // Extract exerciseId from key
                const exerciseId = key.replace(`resistance-${hariKe}-`, '');
                const exerciseName = savedData.name || exerciseId.replace(/-/g, ' ');
                
                // Add exercise to UI
                setTimeout(() => {
                    // addResistanceExercise(hariKe, exerciseName);
                    addResistanceExercise(hariKe, exerciseName, true);
                    
                    // Set values after element is created
                    setTimeout(() => {
                        const setInput = document.getElementById(`jmlSet-${hariKe}-${exerciseId}`);
                        const repetisiInput = document.getElementById(`jmlRepetisi-${hariKe}-${exerciseId}`);
                        const durasiInput = document.getElementById(`jmlDurasi-${hariKe}-${exerciseId}`);
                        
                        if (setInput && savedData.set) setInput.value = savedData.set;
                        if (repetisiInput && savedData.repetisi) repetisiInput.value = savedData.repetisi;
                        if (durasiInput && savedData.durasi) durasiInput.value = savedData.durasi;
                    }, 200);
                }, 100);
            }
        } catch (error) {
            console.error('Error loading resistance data:', error);
        }
    });
}

/*******************************************
 * GET RESISTANCE DATA FOR SERVER - FIXED
 *******************************************/
function getResistanceDataForServer(hariKe) {
  let exercises = [];
  let totalSets = 0;
  let totalReps = 0;
  let totalMinutes = 0;

  Object.keys(localStorage).forEach(key => {
    if (!key.startsWith(`resistance-${hariKe}-`)) return;

    try {
      const data = JSON.parse(localStorage.getItem(key));
      if (!data) return;

      exercises.push(data.name);
      totalSets += Number(data.set || 0);
      totalReps += Number(data.repetisi || 0);
      totalMinutes += Number(data.durasi || 0);
    } catch (e) {
      console.warn('‚ö†Ô∏è Gagal parse resistance:', key);
    }
  });

  return {
    resistenExercises: exercises.join(', '),
    totalSets,
    totalReps,
    totalMinutes
  };
}

/******************************************************
/* FUNGSI REUSABLE: Generate Water Reminder Form HTML *
/******************************************************/
function generateWaterReminderForm(hariKe, containerId = null) {
    console.log(`üíß Generating water reminder form for day ${hariKe}`);
    
    // Jika containerId tidak diberikan, gunakan default
    const container = containerId ? 
        document.getElementById(containerId) : 
        document.getElementById("airputihRadioBtn");
    
    if (!container) {
        console.error(`‚ùå Container not found for water reminder day ${hariKe}`);
        return;
    }
    
    // Clear container terlebih dahulu
    container.innerHTML = '';
    
    // Buat form HTML
    const wrapper = document.createElement("div");
    wrapper.className = "water-reminder-form";
    wrapper.dataset.hari = hariKe;
    wrapper.id = `waterReminderForm${hariKe}`;
    
    wrapper.innerHTML = `
        <div class="water-form-header mb-3">
            <h6 class="mb-2"><b>ASUPAN AIR PUTIH PERHARI</b></h6>
            <p class="text-muted" style="font-size: 14px;">Pilih jumlah air yang sudah anda minum hari ini</p>
        </div>
        
        <div class="water-options mb-4">
            <div class="input-group mb-3">
                <div class="input-group-text">
                    <input type="radio" name="asupanAir${hariKe}" id="kurang1Ltr${hariKe}" value="Kurang dari 1 ltr" class="water-radio">
                </div>
                <label for="kurang1Ltr${hariKe}" class="form-control water-option-label">
                    Kurang dari 1 ltr air putih
                </label>
            </div>  
            
            <div class="input-group mb-3">
                <div class="input-group-text">
                    <input type="radio" name="asupanAir${hariKe}" id="pas1Ltr${hariKe}" value="1 ltr" class="water-radio">
                </div>
                <label for="pas1Ltr${hariKe}" class="form-control water-option-label">
                    1 ltr air putih
                </label>
            </div>  
            
            <div class="input-group mb-3">
                <div class="input-group-text">
                    <input type="radio" name="asupanAir${hariKe}" id="pas2Ltr${hariKe}" value="2 ltr" class="water-radio">
                </div>
                <label for="pas2Ltr${hariKe}" class="form-control water-option-label">
                    2 ltr air putih
                </label>
            </div>  
            
            <div class="input-group mb-3">
                <div class="input-group-text">
                    <input type="radio" name="asupanAir${hariKe}" id="lebih2Ltr${hariKe}" value="Lebih dari 2 ltr" class="water-radio">
                </div>
                <label for="lebih2Ltr${hariKe}" class="form-control water-option-label">
                    Lebih dari 2 ltr air putih
                </label>
            </div>
        </div>

        <div class="water-actions mt-4">
            <div class="text-left">
                <button type="button" class="btn btn-primary btn-sm" id="btnSimpanWater${hariKe}">
                    <i class="fa fa-pencil-square-o"></i> Simpan
                </button>
                <button type="button" class="btn btn-secondary btn-sm" id="btnSelesaiWater${hariKe}" disabled>
                    <i class="fa fa-check"></i> Selesai Water
                </button>
            </div>
            
            <div class="mt-2" id="waterStatus${hariKe}">
                <!-- Status akan ditampilkan di sini -->
            </div>
        </div>
    `;
    
    container.appendChild(wrapper);
    
    // ‚≠ê‚≠ê PENTING: Setup event listeners setelah form dibuat
    setTimeout(() => {
        console.log('üîß Setup water buttons untuk hari', hariKe);
        setupWaterButtons(hariKe); // ‚¨ÖÔ∏è INI YANG HARUS DIPANGGIL
        //loadSavedWaterData(hariKe);
    }, 100);
    
    return wrapper;
}

/*************************************
 * Setup tombol Water Reminder
 *************************************/
function setupWaterButtons(hariKe) {
  const btnSimpan  = document.getElementById(`btnSimpanWater${hariKe}`);
  const btnSelesai = document.getElementById(`btnSelesaiWater${hariKe}`);

  if (btnSimpan) {
    btnSimpan.onclick = () => simpanWaterReminder(hariKe);
  }

  if (btnSelesai) {
    btnSelesai.onclick = () => selesaiWaterReminder(hariKe);
  }

  console.log(`‚úÖ Water buttons wired for day ${hariKe}`);
}


/*********************************************************
 * LOAD SAVED STATUS - Dipanggil saat buka water reminder
 ********************************************************/
function loadWaterReminderStatus(hariKe) {
    console.log(`üíß Load status water hari ${hariKe}`);
    // Cek jika sudah disimpan
    const saved = localStorage.getItem('water_hari_' + hariKe + '_saved');
    const completed = localStorage.getItem('water_hari_' + hariKe + '_completed');
    const asupanAir = localStorage.getItem('water_hari_' + hariKe + '_asupan');
    
    const btnSimpan = document.getElementById('btnSimpanWater' + hariKe);
    const btnSelesai = document.getElementById('btnSelesaiWater' + hariKe);
    const statusDiv = document.getElementById('waterStatus' + hariKe);
    
    // Jika sudah completed
    if (completed === 'true') {
        if (btnSimpan) {
            btnSimpan.disabled = true;
            btnSimpan.innerHTML = '<i class="fas fa-check"></i> Simpan';
            btnSimpan.classList.remove('btn-primary');
            btnSimpan.classList.add('btn-outline-success');
        }
        
        if (btnSelesai) {
            btnSelesai.disabled = true;
            btnSelesai.innerHTML = '<i class="fas fa-check"></i> Selesai Water';
            btnSelesai.classList.remove('btn-success');
            btnSelesai.classList.add('btn-outline-success');
        }
        
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-sm mt-2 p-2">
                    <i class="fas fa-check-circle"></i> Selesai Water
                </div>
            `;
        }
        return;
    }
    
    // Jika sudah disimpan tapi belum selesai
    if (saved === 'true') {
        if (btnSimpan) {
            btnSimpan.disabled = true;
            btnSimpan.innerHTML = '<i class="fas fa-check"></i> Simpan';
            btnSimpan.classList.remove('btn-primary');
            btnSimpan.classList.add('btn-primary');
        }
        
        if (btnSelesai) {
            btnSelesai.disabled = false;
        }
        
        // Set radio button yang dipilih sebelumnya
        if (asupanAir) {
            const radioName = 'asupanAir' + hariKe;
            const radioToCheck = document.querySelector(`input[name="${radioName}"][value="${asupanAir}"]`);
            if (radioToCheck) {
                radioToCheck.checked = true;
            }
        }
        
        if (statusDiv && asupanAir) {
            statusDiv.innerHTML = `
                <div class="alert alert-info alert-sm mt-2 p-2">
                    <i class="fas fa-info-circle"></i> Pilihan sebelumnya: ${asupanAir}
                </div>
            `;
        }
    }
}

/**************************************************
 * BUKA WATER REMINDER SUBMENU
 *************************************************/
function waterReminder(hariKe) {
  const container = document.getElementById(`waterReminderContent${hariKe}`);
  if (!container) return;

  container.style.display = 'block';

  container.innerHTML = `
    <div class="card p-3 mt-2">
      <h6 class="mb-3"><i class="fas fa-tint"></i> Asupan Air Harian</h6>

      <select id="airPutih${hariKe}" class="form-select mb-3">
        <option value="">-- Pilih Asupan Air --</option>
        <option value="1500">1500 ml</option>
        <option value="2000">2000 ml</option>
        <option value="2500">2500 ml</option>
        <option value="3000">3000 ml</option>
      </select>

      <div class="d-flex gap-2">
        <button id="btnSimpanWater${hariKe}"
                class="btn btn-primary"
                onclick="simpanWaterReminder(${hariKe})">
          <i class="fas fa-save"></i> Simpan
        </button>

        <button id="btnSelesaiWater${hariKe}"
                class="btn btn-secondary"
                onclick="selesaiWaterReminder(${hariKe})"
                disabled>
          <i class="fas fa-check"></i> Selesai Water
        </button>
      </div>
    </div>
  `;
}

/**************************************************
 * GENERATE RADIO BUTTONS UNTUK PILIHAN AIR MINUM
 *************************************************/
function generateWaterRadioButtons(hariKe) {
  const container = document.getElementById(`waterRadioContainer${hariKe}`);
  if (!container) return;

  const options = [
    { value: '1500 ml', label: '1.5 Liter / Hari' },
    { value: '2000 ml', label: '2 Liter / Hari' },
    { value: '2500 ml', label: '2.5 Liter / Hari' },
    { value: '3000 ml', label: '3 Liter / Hari' }
  ];

  container.innerHTML = options.map(opt => `
    <div class="form-check mb-1">
      <input class="form-check-input"
             type="radio"
             name="waterHari${hariKe}"
             id="water-${hariKe}-${opt.value}"
             value="${opt.value}">
      <label class="form-check-label" for="water-${hariKe}-${opt.value}">
        ${opt.label}
      </label>
    </div>
  `).join('');
}


/********************************************
 *  AMBIL NILAI WATER REMINDER (HARI KE-x)
 *******************************************/
function getWaterHari(hariKe) {
  const checked = document.querySelector(
    `input[name="waterHari${hariKe}"]:checked`
  );
  return checked ? checked.value : '';
}

/**************************************************
 * ENABLE / DISABLE SEMUA KOMPONEN WATER REMINDER
 ************************************************/
function setWaterComponentsDisabled(hariKe, isDisabled) {

  // radio buttons
  document
    .querySelectorAll(`input[name="waterHari${hariKe}"]`)
    .forEach(r => r.disabled = isDisabled);

  // tombol simpan
  const btnSimpan = document.getElementById(`btnSimpanWater${hariKe}`);
  if (btnSimpan) btnSimpan.disabled = isDisabled;

  // tombol selesai
  const btnSelesai = document.getElementById(`btnSelesaiWater${hariKe}`);
  if (btnSelesai) btnSelesai.disabled = isDisabled;

  // ‚ùå JANGAN sentuh tombol X
  // ‚ùå JANGAN sentuh tombol Cek Disini
}
 
/*********************************
* SIMPAN DATA ASUPAN AIR (WATER) *
*********************************/
async function simpanWaterReminder(hariKe) {
  const userId = localStorage.getItem('userId');
  const radio  = document.querySelector(`input[name="asupanAir${hariKe}"]:checked`);

  if (!radio) {
    showMessage('warning', 'Pilih jumlah asupan air terlebih dahulu', 3000);
    return;
  }

  const asupanAir = radio.value;
  console.log('üì§ Kirim water:', { userId, hariKe, asupanAir });
  const response = await fetch(URL_PROGRAM_APP, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      action: 'updateWater',
      userId,
      hariKe,
      asupanAir
    })
  });
  const result = await response.text();
  console.log('üì• Response water:', result);
  if (result === 'OK') {
    // showMessage('success', 'Asupan air berhasil disimpan', 3000);
    showMessage('success', 'Asupan air berhasil disimpan', 3000, `pertemuan${hariKe}` );
    
    // Aktifkan tombol selesai
    const btnSelesai = document.getElementById(`btnSelesaiWater${hariKe}`);
    if (btnSelesai) btnSelesai.disabled = false;
   }
}

/*********************************
* Selesaikan Water Reminder *
*********************************/
async function selesaiWaterReminder(hariKe) {
  const userId   = localStorage.getItem('userId');
  const response = await fetch(URL_PROGRAM_APP, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      action: 'completeWater',
      userId,
      hariKe
    })
  });
  const result = await response.text();
  if (result === 'OK') {
    showMessage('success', 'Water Reminder Selesai', 3000, `pertemuan${hariKe}` );
    
    // Disable radio button
    document
      .querySelectorAll(`input[name="asupanAir${hariKe}"]`)
      .forEach(radio => radio.disabled = true);
    
    // Disable tombol Simpan & Selesai
    document.getElementById(`btnSimpanWater${hariKe}`)?.setAttribute('disabled', true);
    document.getElementById(`btnSelesaiWater${hariKe}`)?.setAttribute('disabled', true);
    
    // UPDATE SUBMENU (CENTANG HIJAU)
    updateSubmenuLinkUI('water', hariKe);
  }
}

function disableWaterAfterCompletion(hariKe) {
  // disable radio
  document
    .querySelectorAll(`input[name="asupanAir${hariKe}"]`)
    .forEach(radio => radio.disabled = true);

  // disable tombol Simpan & Selesai
  const btnSimpan  = document.getElementById(`btnSimpanWater${hariKe}`);
  const btnSelesai = document.getElementById(`btnSelesaiWater${hariKe}`);

  if (btnSimpan)  btnSimpan.disabled  = true;
  if (btnSelesai) btnSelesai.disabled = true;
}

/***************************************************
 * FUNGSI HELPER UNTUK CLEANUP SCRIPT
 * @param {object} script - Objek script DOM
 * @param {string} callbackName - Nama callback
 ***************************************************/
function cleanUpScript(script, callbackName) {
    try {
        if (script && script.parentNode) {
            script.parentNode.removeChild(script);
        }
        if (callbackName && window[callbackName]) {
            delete window[callbackName];
        }
    } catch (e) {
        console.error('Error cleanup script:', e);
    }
}

/***************************************************
 * TANDAI SUBMENU SELESAI (GENERIC & REUSABLE)
 * @param {number} hariKe - Nomor hari
 * @param {string} submenuKeyword - Kata kunci submenu
 *   Contoh: 'Water Reminder','Materi', 'Meal Plan', 'Workout'
 ***************************************************/
function tandaiSubmenuSelesai(hariKe, submenuKeyword) {
  if (!hariKe || !submenuKeyword) return;
  const menuItems = document.querySelectorAll('.menu-item');
  menuItems.forEach(item => {
    const text = item.textContent || '';
    // Cocokkan submenu + hari
    if (
      text.includes(submenuKeyword) &&
      text.includes(`Hari ${hariKe}`)
    ) {
      // Tebalkan teks menu
      // item.style.fontWeight = 'bold';

      // Cegah duplikasi icon
      if (!item.querySelector('.submenu-done')) {

        const icon = document.createElement('span');
        icon.className = 'submenu-done';
        icon.setAttribute('aria-label', 'Selesai');
        icon.setAttribute('title', 'Selesai');

        icon.innerHTML = '‚úì';

        // Styling icon lingkaran kecil
        icon.style.display = 'inline-flex';
        icon.style.alignItems = 'center';
        icon.style.justifyContent = 'center';
        icon.style.width = '14px';
        icon.style.height = '14px';
        icon.style.borderRadius = '50%';
        icon.style.border = '1.5px solid #2ecc71';
        icon.style.color = '#2ecc71';
        icon.style.fontSize = '10px';
        icon.style.marginLeft = '2px' ;   // '6px';
        icon.style.lineHeight = '1';

        item.appendChild(icon);
      }
    }
  });
}

/***************************************************
 * AMBIL CONTAINER SUBMENU BERDASARKAN HARI
 * @param {number} hariKe - Nomor hari
 * @param {string} prefix - Prefix container
 ***************************************************/
function getSubmenuContainer(hariKe, prefix) {
  if (!prefix) return null;
  return hariKe != null
    ? document.getElementById(prefix + hariKe)
    : document.getElementById(prefix);
}

/***************************************************
 * ENABLE / DISABLE SEMUA KOMPONEN DI SUBMENU
 * @param {number} hariKe - Nomor hari
 * @param {string} containerPrefix - Prefix container
 * @param {boolean} disabled - Apakah disabled (default: true)
 ***************************************************/
function setSubmenuDisabled(hariKe, containerPrefix, disabled = true) {
  const container = getSubmenuContainer(hariKe, containerPrefix);
  if (!container) return;

  container.querySelectorAll(
    'button, input, select, textarea, a'
  ).forEach(el => {
    if ('disabled' in el) el.disabled = disabled;
    el.style.pointerEvents = disabled ? 'none' : '';
    el.style.opacity = disabled ? '0.6' : '';
  });
}

/***************************************************
 * SETUP RADIO BUTTONS UNTUK WATER REMINDER
 * @param {number} hariKe - Nomor hari
 ***************************************************/
function setupWaterRadioButtons(hariKe) {
    const radioName = 'asupanAir' + hariKe;
    const radios = document.querySelectorAll(`input[name="${radioName}"]`);
    
    radios.forEach(radio => {
        radio.onchange = function() {
            console.log(`üìª Radio berubah hari ${hariKe}: ${this.value}`);
            
            // Aktifkan tombol Simpan
            const btnSimpan = document.getElementById('btnSimpanWater' + hariKe);
            if (btnSimpan) {
                btnSimpan.disabled = false;
                btnSimpan.classList.remove('btn-outline-success');
                btnSimpan.classList.add('btn-primary');
                btnSimpan.innerHTML = '<i class="fas fa-save"></i> Simpan';
            }
        };
    });
}

/***************************************************
 * CEK STATUS WATER REMINDER
 * @param {number} hariKe - Nomor hari
 ***************************************************/
function checkWaterStatus(hariKe) {
  const saved = localStorage.getItem('water_saved_hari_' + hariKe);
  const btnSelesai = document.getElementById('btnSelesaiWater' + hariKe);
  
  if (btnSelesai && saved === 'true') {
    btnSelesai.disabled = false;
    btnSelesai.classList.remove('btn-secondary');
    btnSelesai.classList.add('btn-secondary');
  }
}

/***************************************************
 * LOAD DATA YANG SUDAH DISIMPAN
 * @param {number} hariKe - Nomor hari
 ***************************************************/
function loadWaterReminderData(hariKe) {
    console.log(`üíæ Load water data hari ${hariKe}`);
    
    // Cek dari localStorage
    const saved = localStorage.getItem(`water_hari_${hariKe}_saved`);
    const completed = localStorage.getItem(`water_hari_${hariKe}_completed`);
    const asupanAir = localStorage.getItem(`water_hari_${hariKe}_asupan`);
    
    // Jika sudah selesai
    if (completed === 'true') {
        const btnSimpan = document.getElementById('btnSimpanWater' + hariKe);
        const btnSelesai = document.getElementById('btnSelesaiWater' + hariKe);
        const statusDiv = document.getElementById('waterStatus' + hariKe);
        
        if (btnSimpan) {
            btnSimpan.disabled = true;
            btnSimpan.innerHTML = '<i class="fas fa-check"></i> Simpan';
            btnSimpan.classList.remove('btn-primary');
            btnSimpan.classList.add('btn-primary');
        }
        
        if (btnSelesai) {
            btnSelesai.disabled = true;
            btnSelesai.innerHTML = '<i class="fas fa-check"></i> Selesai Water';
            btnSelesai.classList.remove('btn-secondary');
            btnSelesai.classList.add('btn-secondary');
        }
        
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-sm p-2 mb-0">
                    <i class="fas fa-check-circle"></i> 
                    Water reminder sudah selesai
                </div>
            `;
        }
        // Update menu icon
        updateWaterMenuIcon(hariKe);
        return;
    }
    
    // Jika sudah disimpan tapi belum selesai
    if (saved === 'true' && asupanAir) {
        const btnSimpan = document.getElementById('btnSimpanWater' + hariKe);
        const btnSelesai = document.getElementById('btnSelesaiWater' + hariKe);
        const statusDiv = document.getElementById('waterStatus' + hariKe);
        
        if (btnSimpan) {
            btnSimpan.disabled = true;
            btnSimpan.innerHTML = '<i class="fas fa-check"></i> Simpan';
            btnSimpan.classList.remove('btn-primary');
            btnSimpan.classList.add('btn-primary');
        }
        
        if (btnSelesai) {
            btnSelesai.disabled = false;
            btnSelesai.classList.remove('btn-secondary');
            btnSelesai.classList.add('btn-secondary');
        }
        
        // Set radio button yang sebelumnya dipilih
        const radioName = 'asupanAir' + hariKe;
        const radioToSelect = document.querySelector(`input[name="${radioName}"][value="${asupanAir}"]`);
        if (radioToSelect) {
            radioToSelect.checked = true;
        }
        
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-info alert-sm p-2 mb-0">
                    <i class="fas fa-info-circle"></i> 
                    Pilihan sebelumnya: <strong>${asupanAir}</strong>
                </div>
            `;
        }
    }
}

/*************************
* LOCK WATER REMINDER UI *
**************************/
function lockWaterReminderUI(hariKe) {

  // Disable radio button
  document
    .querySelectorAll(`input[name="airputihRadioBtn${hariKe}"]`)
    .forEach(radio => radio.disabled = true);

  // Disable tombol Simpan
  const btnSimpan = document.getElementById(`btnSimpanAir${hariKe}`);
  if (btnSimpan) btnSimpan.disabled = true;

  // Disable tombol Selesai
  const btnSelesai = document.getElementById(`btnSelesaiAir${hariKe}`);
  if (btnSelesai) btnSelesai.disabled = true;

  // ‚ùó TIDAK MENYENTUH:
  // - Tombol X
  // - Tombol Cek Disini

  console.log(`üîí Water Reminder hari ${hariKe} terkunci`);
}

// Fungsi untuk update icon di menu
function updateWaterMenuIcon(hariKe) {
    console.log('üéØ Update menu icon untuk water hari', hariKe);
    
    // Cari menu item untuk water hari ini
    const menuItem = document.querySelector(`[onclick*="waterReminder(${hariKe})"]`);
    
    if (menuItem) {
        // Hapus badge lama jika ada
        const oldBadges = menuItem.querySelectorAll('.badge');
        oldBadges.forEach(badge => badge.remove());
        
        // Tambah badge centang hijau
        const checkBadge = document.createElement('span');
        checkBadge.className = 'badge bg-success ms-2';
        checkBadge.innerHTML = '<i class="fas fa-check"></i>';
        checkBadge.title = 'Selesai Water';
        menuItem.appendChild(checkBadge);
        
        console.log('‚úÖ Centang ditambahkan di menu');
    }
}

/***************************************************
 * UPDATE PROGRESS COUNTER DI DASHBOARD
 * @param {string} type - Jenis progress ('water', 'meal', 'workout', dll)
 * @param {number} hariKe - Nomor hari
 ***************************************************/
function updateProgressCounter(type, hariKe) {
  // Implementasi sesuai kebutuhan dashboard Anda
  console.log(`üìä Progress ${type} hari ${hariKe} diupdate`);
  
  // Contoh: Update counter di suatu element
  const counterElement = document.getElementById('progressCounter');
  if (counterElement) {
    // Logika update counter
  }
}

/***************************************************
 * GET HARI AKTIF
 * @returns {number} - Nomor hari aktif
 ***************************************************/
function getHariAktif() {
  // Cek dari URL
  const urlParams = new URLSearchParams(window.location.search);
  const hariFromUrl = urlParams.get('hari');
  
  // Cek dari localStorage
  const hariFromStorage = localStorage.getItem('currentDay');
  
  // Cek dari menu aktif
  const activeMenu = document.querySelector('.menu-item.active');
  let hariFromMenu = 1;
  if (activeMenu && activeMenu.textContent) {
    const match = activeMenu.textContent.match(/Hari\s*(\d+)/i);
    if (match) hariFromMenu = parseInt(match[1]);
  }
  
  const hariKe = hariFromUrl || hariFromStorage || hariFromMenu || 1;
  return parseInt(hariKe);
}

/***************************************
 * UPDATE PROGRESS TRACKER UNTUK MODUL
 * @param {number} modul - Nomor modul
 * @param {string} type - Jenis progress ('water_saved', 'water_completed', dll)
 * @param {number} hariKe - Nomor hari
 ****************************************/
function updateModulProgress(modul, type, hariKe) {
  console.log(`üìä Update progress M${modul}: ${type} hari ${hariKe}`);
  
  // Key untuk localStorage
  const progressKey = `modul_${modul}_progress`;
  
  // Load progress yang ada
  let progress = JSON.parse(localStorage.getItem(progressKey) || '{}');
  
  // Update berdasarkan type
  if (type === 'water_saved') {
    progress.water_saved = progress.water_saved || [];
    if (!progress.water_saved.includes(hariKe)) {
      progress.water_saved.push(hariKe);
    }
  } else if (type === 'water_completed') {
    progress.water_completed = progress.water_completed || [];
    if (!progress.water_completed.includes(hariKe)) {
      progress.water_completed.push(hariKe);
    }
  }
  
  // Simpan kembali
  localStorage.setItem(progressKey, JSON.stringify(progress));
  
  // Update UI jika ada progress bar
  updateModulProgressUI(modul, progress);
}

/***************************************
 * UPDATE PROGRESS UI UNTUK MODUL
 * @param {number} modul - Nomor modul
 * @param {object} progress - Data progress
 ****************************************/
function updateModulProgressUI(modul, progress) {
  // Cari progress bar untuk modul ini
  const progressBarId = `progressBarModul${modul}`;
  const progressBar = document.getElementById(progressBarId);
  
  if (progressBar) {
    // Hitung persentase progress
    const totalHari = 10; // Asumsi 10 hari per modul
    const completed = progress.water_completed ? progress.water_completed.length : 0;
    const percentage = Math.round((completed / totalHari) * 100);
    
    // Update progress bar
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = `${percentage}%`;
    
    // Update label
    const progressLabel = document.getElementById(`progressLabelModul${modul}`);
    if (progressLabel) {
      progressLabel.textContent = `Progress: ${completed}/${totalHari} hari`;
    }
  }
}

/***************************************
 * LOAD SAVED DATA UNTUK MODUL
 * @param {number} modul - Nomor modul
 * @param {number} hariKe - Nomor hari
 ****************************************/
function loadSavedWaterDataModul(modul, hariKe) {
  console.log(`üíæ Load saved water data M${modul}D${hariKe}`);
  
  const prefix = `M${modul}D${hariKe}`;
  
  // 1. Load pilihan asupan air
  const storageKey = `water_M${modul}_D${hariKe}_asupan`;
  const savedAsupan = localStorage.getItem(storageKey);
  
  if (savedAsupan) {
    const radioName = `asupanAir${prefix}`;
    const radioToSelect = document.querySelector(`input[name="${radioName}"][value="${savedAsupan}"]`);
    
    if (radioToSelect) {
      radioToSelect.checked = true;
      console.log(`‚úÖ Pilihan asupan direstore M${modul}D${hariKe}:`, savedAsupan);
    }
  }
  
  // 2. Load status saved
  const savedKey = `water_M${modul}_D${hariKe}_saved`;
  const isSaved = localStorage.getItem(savedKey) === 'true';
  
  if (isSaved) {
    const btnSimpanId = `btnSimpanWater${prefix}`;
    const btnSimpan = document.getElementById(btnSimpanId);
    
    if (btnSimpan) {
      btnSimpan.disabled = true;
      btnSimpan.innerHTML = '<i class="fas fa-check"></i> Tersimpan';
      btnSimpan.className = btnSimpan.className.replace('btn-primary', 'btn-outline-success');
    }
    
    // Aktifkan tombol selesai
    const btnSelesaiId = `btnSelesaiWater${prefix}`;
    const btnSelesai = document.getElementById(btnSelesaiId);
    if (btnSelesai) {
      btnSelesai.disabled = false;
      btnSelesai.className = btnSelesai.className.replace('btn-secondary', 'btn-secondary');
    }
  }
  
  // 3. Load status completed
  const completedKey = `water_M${modul}_D${hariKe}_completed`;
  const isCompleted = localStorage.getItem(completedKey) === 'true';
  
  if (isCompleted) {
    // Jika sudah selesai, disable semua
    const btnSimpanId = `btnSimpanWater${prefix}`;
    const btnSelesaiId = `btnSelesaiWater${prefix}`;
    
    const btnSimpan = document.getElementById(btnSimpanId);
    const btnSelesai = document.getElementById(btnSelesaiId);
    
    if (btnSimpan) {
      btnSimpan.disabled = true;
      btnSimpan.innerHTML = '<i class="fas fa-check"></i> Simpan';
    }
    
    if (btnSelesai) {
      btnSelesai.disabled = true;
      btnSelesai.innerHTML = '<i class="fas fa-check"></i> Selesai Water';
      btnSelesai.className = btnSelesai.className.replace('btn-secondary', 'btn-secondary');
    }
    
    // Update status display
    const statusDivId = `waterStatus${prefix}`;
    const statusDiv = document.getElementById(statusDivId);
    if (statusDiv) {
      statusDiv.innerHTML = `
        <div class="alert alert-success alert-sm p-2 mb-0">
          <i class="fas fa-check-circle"></i> 
          <strong>Water reminder sudah selesai</strong>
          <br><small>Modul ${modul}, Hari ${hariKe}</small>
        </div>
      `;
    }
    
    // Update menu icon
    updateWaterMenuIconModul(modul, hariKe);
  }
}

/***************************************
 * UPDATE MENU ICON UNTUK MODUL
 * @param {number} modul - Nomor modul
 * @param {number} hariKe - Nomor hari
 ****************************************/
function updateWaterMenuIconModul(modul, hariKe) {
  console.log(`üéØ Update menu icon M${modul}D${hariKe}`);
  
  const prefix = `M${modul}D${hariKe}`;
  
  // Cari menu item
  const menuSelectors = [
    `a[onclick*="waterReminderModul(${modul}, ${hariKe})"]`,
    `a[data-target*="waterReminderContent${prefix}"]`,
    `#waterMenuItem${prefix}`,
    `.menu-item[data-modul="${modul}"][data-hari="${hariKe}"][data-type="water"]`
  ];
  
  let menuItem = null;
  for (const selector of menuSelectors) {
    menuItem = document.querySelector(selector);
    if (menuItem) break;
  }
  
  if (menuItem) {
    // Hapus badge lama
    const oldBadges = menuItem.querySelectorAll('.badge');
    oldBadges.forEach(badge => badge.remove());
    
    // Tambah badge centang
    const checkBadge = document.createElement('span');
    checkBadge.className = 'badge bg-success ms-2';
    checkBadge.innerHTML = '<i class="fas fa-check"></i>';
    checkBadge.title = `Water reminder selesai - Modul ${modul}, Hari ${hariKe}`;
    menuItem.appendChild(checkBadge);
    
    console.log(`‚úÖ Centang ditambahkan di menu M${modul}D${hariKe}`);
  }
}

/***************************************
 * CHECK STATUS UNTUK MODUL
 * @param {number} modul - Nomor modul
 * @param {number} hariKe - Nomor hari
 ****************************************/
function checkWaterStatusModul(modul, hariKe) {
  const prefix = `M${modul}D${hariKe}`;
  const savedKey = `water_M${modul}_D${hariKe}_saved`;
  const isSaved = localStorage.getItem(savedKey) === 'true';
  
  const btnSelesaiId = `btnSelesaiWater${prefix}`;
  const btnSelesai = document.getElementById(btnSelesaiId);
  
  if (btnSelesai && isSaved) {
    btnSelesai.disabled = false;
    btnSelesai.className = btnSelesai.className.replace('btn-secondary', 'btn-secondary');
    return true;
  }
  
  return false;
}

/**
 * RESET WATER REMINDER UNTUK MODUL (TESTING)
 * @param {number} modul - Nomor modul
 * @param {number} hariKe - Nomor hari
 */
function resetWaterReminderModul(modul, hariKe) {
  if (!confirm(`Reset Water Reminder Modul ${modul}, Hari ${hariKe}?`)) return;
  
  const prefix = `M${modul}D${hariKe}`;
  
  // Hapus dari localStorage
  localStorage.removeItem(`water_M${modul}_D${hariKe}_asupan`);
  localStorage.removeItem(`water_M${modul}_D${hariKe}_saved`);
  localStorage.removeItem(`water_M${modul}_D${hariKe}_completed`);
  
  // Reset progress tracker
  const progressKey = `modul_${modul}_progress`;
  let progress = JSON.parse(localStorage.getItem(progressKey) || '{}');
  
  if (progress.water_saved) {
    progress.water_saved = progress.water_saved.filter(day => day !== hariKe);
  }
  
  if (progress.water_completed) {
    progress.water_completed = progress.water_completed.filter(day => day !== hariKe);
  }
  
  localStorage.setItem(progressKey, JSON.stringify(progress));
  
  // Reset tombol
  const btnSimpanId = `btnSimpanWater${prefix}`;
  const btnSelesaiId = `btnSelesaiWater${prefix}`;
  
  const btnSimpan = document.getElementById(btnSimpanId);
  const btnSelesai = document.getElementById(btnSelesaiId);
  
  if (btnSimpan) {
    btnSimpan.disabled = false;
    btnSimpan.innerHTML = '<i class="fas fa-save"></i> Simpan';
    btnSimpan.className = btnSimpan.className.replace('btn-outline-success', 'btn-primary');
  }
  
  if (btnSelesai) {
    btnSelesai.disabled = true;
    btnSelesai.innerHTML = '<i class="fa fa-check"></i> Selesai Water';
    btnSelesai.className = btnSelesai.className.replace('btn-secondary', 'btn-secondary');
  }
  
  // Reset radio buttons
  const radioName = `asupanAir${prefix}`;
  document.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
    radio.checked = false;
  });
  
  // Reset status display
  const statusDivId = `waterStatus${prefix}`;
  const statusDiv = document.getElementById(statusDivId);
  if (statusDiv) {
    statusDiv.innerHTML = '';
  }
  
  // Reset menu icon
  updateWaterMenuIconModul(modul, hariKe); // Akan menghapus badge
  
  showMessage(
    'info', 
    `Water reminder Modul ${modul}, Hari ${hariKe} telah direset`, 
    3000
  );
  
  console.log(`üîÑ Water reminder M${modul}D${hariKe} di-reset`);
}

/****************************************************
/* FUNGSI REUSABLE: Load Saved Water Reminder Data *
/****************************************************/
function loadSavedWaterReminderData(hariKe) {
    console.log(`üíß Loading saved water data for day ${hariKe}`);
    
    const userId      = localStorage.getItem('userId');
    const savedKey    = userId ? `water_asupan_${userId}_${hariKe}` : `water_asupan_${hariKe}`;
    const savedAsupan = localStorage.getItem(savedKey);
    const savedStatus = userId ? 
        localStorage.getItem(`water_status_${userId}_${hariKe}`) : 
        localStorage.getItem(`water_status_${hariKe}`);
    
    if (savedAsupan) {
        // Set radio button yang sesuai
        const radioIdMap = {
            'Kurang dari 1 ltr': `kurang1Ltr${hariKe}`,
            '1 ltr': `pas1Ltr${hariKe}`,
            '2 ltr': `pas2Ltr${hariKe}`,
            'Lebih dari 2 ltr': `lebih2Ltr${hariKe}`
        };
        
        const radioId = radioIdMap[savedAsupan];
        if (radioId) {
            const radioBtn = document.getElementById(radioId);
            if (radioBtn) {
                radioBtn.checked = true;
                
                // Tampilkan label yang dipilih
                const selectedLabel = document.querySelector(`label[for="${radioId}"]`);
                if (selectedLabel) {
                    selectedLabel.style.backgroundColor = '#e8f4fd';
                    selectedLabel.style.fontWeight = '500';
                }
                
                // Jika sudah disimpan, disable radio buttons
                const savedFlagKey = userId ? `water_saved_${userId}_${hariKe}` : `water_saved_${hariKe}`;
                if (localStorage.getItem(savedFlagKey)) {
                    disableWaterRadioButtons(hariKe);
                }
            }
        }
    }
    
    // Jika sudah selesai, apply completion UI
    if (savedStatus === 'completed') {
        updateWaterReminderCompletionUI(hariKe);
        disableAllWaterButtons(hariKe);
    }
}

/**************************
/* Water Reminder Actions *
/**************************/
function updateWaterSaveUI(hariKe, asupanAir) {
    // Tampilkan info saved
    const savedInfo    = document.getElementById(`waterSavedInfo${hariKe}`);
    const selectedText = document.getElementById(`waterSelectedText${hariKe}`);
 
    // Update tombol simpan
    const simpanBtn = document.getElementById(`btnSimpanWater${hariKe}`);
    if (simpanBtn) {
        simpanBtn.innerHTML = '<i class="fas fa-check"></i> Simpan';
        simpanBtn.disabled = true;
        simpanBtn.classList.remove('btn-primary');
        simpanBtn.classList.add('btn-primary');
        simpanBtn.style.opacity = '0.8';
    }
}

function disableWaterRadioButtons(hariKe) {
  const container = document.getElementById('waterReminderContent' + hariKe);
  if (!container) return;

  const radios = container.querySelectorAll('input[type="radio"]');
  radios.forEach(radio => {
    radio.disabled = true;
  });
}

function disableAllWaterButtons(hariKe) {
  const btnSimpan = document.getElementById('btnSimpanWater' + hariKe);
  const btnSelesai = document.getElementById('btnSelesaiWater' + hariKe);

  if (btnSimpan) btnSimpan.disabled = true;
  if (btnSelesai) btnSelesai.disabled = true;
}


/****************************************************
/* FUNGSI UTAMA: Initialize Water Reminder Forms *
/****************************************************/
function initializeAllWaterReminderForms() {
    console.log('üöÄ Initializing all water reminder forms...');
    
    // Generate form untuk semua hari (1-10)
    for (let hariKe = 1; hariKe <= 10; hariKe++) {
        // Cari container untuk hari ini
        const containerId = `airputihRadioBtn${hariKe > 1 ? hariKe : ''}`;
        const container = document.getElementById(containerId);
        
        if (container) {
            // Generate form jika container ditemukan
            generateWaterReminderForm(hariKe, containerId);
        } else {
            console.log(`‚ö†Ô∏è Water container not found for day ${hariKe}: ${containerId}`);
        }
    }
    
    console.log('‚úÖ All water reminder forms initialized');
}

/*****************************************
/* CSS STYLING UNTUK WATER REMINDER FORM *
/*****************************************/
function addWaterReminderStyles() {
    const styleId = 'water-reminder-styles';
    
    // Hapus style lama jika ada
    const oldStyle = document.getElementById(styleId);
    if (oldStyle) oldStyle.remove();
    
    // Tambahkan style baru
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
        .water-reminder-form {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .water-form-header h6 {
            color: #000000;
            padding-bottom: 5px;
        }
        
        .water-option-label {
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: none !important;
        }
        
        .water-option-label:hover {
            background-color: #f8f9fa;
        }
        
        .input-group:has(.water-radio:checked) .water-option-label {
            background-color: #e8f4fd !important;
            font-weight: 500 !important;
            color: #0a58ca;
        }
        
        .input-group-text:has(.water-radio:disabled) {
            background-color: #e9ecef;
            opacity: 0.6;
        }
        
        .water-actions {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
        }
        
        .water-saved-info .alert {
            border-radius: 8px;
            border: 1px solid #d1e7dd;
        }
        
        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .water-reminder-form {
                padding: 10px;
            }
            
            .water-actions .d-flex {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                gap: 10px;
            }
            
            .water-actions .btn {
                flex: 1 1 0px;
                font-size: 13px;
                padding: 8px 5px;
            }
        }
    `;
    
    document.head.appendChild(style);
    console.log('üé® Water reminder styles added');
}

/******************************************
* AUTO-LOCK WATER (USER LAMA / READ-ONLY) *
******************************************/
function showWaterReminderForm(hariKe) {
  console.log(`üíß Showing water reminder form for day ${hariKe}`);

  // Tampilkan submenu
  showSubmenu(`waterReminderContent${hariKe}`);

  const containerId = `airputihRadioBtn${hariKe > 1 ? hariKe : ''}`;
  const container   = document.getElementById(containerId);

  if (!container) {
    console.error('‚ùå Water container tidak ditemukan:', containerId);
    return;
  }

  // Generate form jika belum ada
  if (container.innerHTML.trim() === '') {
    generateWaterReminderForm(hariKe, containerId);
  }

  // Load data tersimpan
  setTimeout(() => {
    loadSavedWaterReminderData(hariKe);
  }, 200);

  // üîí AUTO LOCK JIKA USER LAMA (WATER SUDAH OK)
  setTimeout(() => {
    if (
      window.userProgress &&
      window.userProgress[`waterHari${hariKe}`] === true
    ) {
      console.log('üîí Water Reminder hari', hariKe, 'READ ONLY');
      disableWaterAfterCompletion(hariKe);
    }
  }, 300);
}

/* =====================================================
   KIRIM DATA KE GOOGLE APPS SCRIPT (JSONP)
   ===================================================== */
function kirimKeServer(data, callback = null) {
  if (!data || !data.action) {
    console.error('‚ùå Data atau action tidak valid:', data);
    return;
  }

  // Buat callback unik (JSONP)
  const callbackName = 'cb_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
  data.callback = callbackName;

  // Bangun query string
  const params = Object.keys(data)
    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(data[key]))
    .join('&');

  const script = document.createElement('script');
  script.src = `${URL_PROGRAM_APP }?${params}`;

  console.log('üöÄ Mengirim request ke server:', script.src);

  // JSONP callback
  window[callbackName] = function (response) {
    console.log('üì• Respon dari server:', response);

    if (typeof callback === 'function') {
      callback(response);
    }

    // Cleanup
    delete window[callbackName];
    document.body.removeChild(script);
  };

  // Error handling
  script.onerror = function () {
    console.error('‚ùå Gagal terhubung ke server');
    if (typeof callback === 'function') {
      callback({ status: 'error', message: 'Gagal terhubung ke server' });
    }
    delete window[callbackName];
    document.body.removeChild(script);
  };

  document.body.appendChild(script);
}

function parseJSONP(text) {
  if (!text) return null;
  const match = text.match(/\((.*)\)/);
  if (!match) return null;
  try {
    return JSON.parse(match[1]);
  } catch (e) {
    console.error('‚ùå Gagal parse JSONP:', e);
    return null;
  }
}

/*********************************************************
 * HARD BLOCK MODUL via Bootstrap Collapse (FINAL FIX)
 *********************************************************/
document.addEventListener('show.bs.collapse', function (e) {
  const collapseEl = e.target;

  // Cari header yang mengontrol collapse ini
  const header = document.querySelector(
    `[data-bs-target="#${collapseEl.id}"], [href="#${collapseEl.id}"]`
  );

  if (!header) return;
  const hariKe = parseInt(header.getAttribute('data-hari'), 10);

  // ‚õî BLOK MODUL HARI 1 JIKA PERKENALAN BELUM SELESAI
  if (
    hariKe === 1 &&
    window.userProgress &&
    window.userProgress.perkenalan !== true
  ) {
    e.preventDefault();
    e.stopImmediatePropagation();
    showMessage( 'warning', 'Silakan selesaikan Perkenalan terlebih dahulu', 3000 );
    console.warn(`‚õî Bootstrap collapse Hari ${hariKe} diblok TOTAL`);
  }
}, true);

</script>
</body>
</html>
